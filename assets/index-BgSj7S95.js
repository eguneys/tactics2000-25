var Wr=Object.defineProperty;var Hr=(t,e,n)=>e in t?Wr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var S=(t,e,n)=>Hr(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();const Y={context:void 0,registry:void 0,effects:void 0,done:!1,getContextId(){return di(this.context.count)},getNextContextId(){return di(this.context.count++)}};function di(t){const e=String(t),n=e.length-1;return Y.context.id+(n?String.fromCharCode(96+n):"")+e}function Qr(t){Y.context=t}const Gr=(t,e)=>t===e,Vr=Symbol("solid-proxy"),Jr=Symbol("solid-track"),Ot={equals:Gr};let Fi=Qi;const Oe=1,Nt=2,Ui={owned:null,cleanups:null,context:null,owner:null};var L=null;let cn=null,Yr=null,U=null,te=null,Se=null,en=0;function xt(t,e){const n=U,i=L,r=t.length===0,s=e===void 0?i:e,o=r?Ui:{owned:null,cleanups:null,context:s?s.context:null,owner:s},c=r?t:()=>t(()=>he(()=>gt(o)));L=o,U=null;try{return ct(c,!0)}finally{U=n,L=i}}function ie(t,e){e=e?Object.assign({},Ot,e):Ot;const n={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},i=r=>(typeof r=="function"&&(r=r(n.value)),Hi(n,r));return[Wi.bind(n),i]}function Ee(t,e,n){const i=Hn(t,e,!1,Oe);At(i)}function _e(t,e,n){Fi=rs;const i=Hn(t,e,!1,Oe);i.user=!0,Se?Se.push(i):At(i)}function ee(t,e,n){n=n?Object.assign({},Ot,n):Ot;const i=Hn(t,e,!0,0);return i.observers=null,i.observerSlots=null,i.comparator=n.equals||void 0,At(i),Wi.bind(i)}function Tt(t){return ct(t,!1)}function he(t){if(U===null)return t();const e=U;U=null;try{return t()}finally{U=e}}function pn(t,e,n){const i=Array.isArray(t);let r;return s=>{let o;if(i){o=Array(t.length);for(let l=0;l<t.length;l++)o[l]=t[l]()}else o=t();const c=he(()=>e(o,r,s));return r=o,c}}function Zr(t){_e(()=>he(t))}function Xr(t){return L===null||(L.cleanups===null?L.cleanups=[t]:L.cleanups.push(t)),t}function es(t,e){const n=Symbol("context");return{id:n,Provider:os(n),defaultValue:t}}function Wn(t){let e;return L&&L.context&&(e=L.context[t.id])!==void 0?e:t.defaultValue}function ts(t){const e=ee(t),n=ee(()=>gn(e()));return n.toArray=()=>{const i=n();return Array.isArray(i)?i:i!=null?[i]:[]},n}function Wi(){if(this.sources&&this.state)if(this.state===Oe)At(this);else{const t=te;te=null,ct(()=>Dt(this),!1),te=t}if(U){const t=this.observers?this.observers.length:0;U.sources?(U.sources.push(this),U.sourceSlots.push(t)):(U.sources=[this],U.sourceSlots=[t]),this.observers?(this.observers.push(U),this.observerSlots.push(U.sources.length-1)):(this.observers=[U],this.observerSlots=[U.sources.length-1])}return this.value}function Hi(t,e,n){let i=t.value;return(!t.comparator||!t.comparator(i,e))&&(t.value=e,t.observers&&t.observers.length&&ct(()=>{for(let r=0;r<t.observers.length;r+=1){const s=t.observers[r],o=cn&&cn.running;o&&cn.disposed.has(s),(o?!s.tState:!s.state)&&(s.pure?te.push(s):Se.push(s),s.observers&&Gi(s)),o||(s.state=Oe)}if(te.length>1e6)throw te=[],new Error},!1)),e}function At(t){if(!t.fn)return;gt(t);const e=en;ns(t,t.value,e)}function ns(t,e,n){let i;const r=L,s=U;U=L=t;try{i=t.fn(e)}catch(o){return t.pure&&(t.state=Oe,t.owned&&t.owned.forEach(gt),t.owned=null),t.updatedAt=n+1,Vi(o)}finally{U=s,L=r}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?Hi(t,i):t.value=i,t.updatedAt=n)}function Hn(t,e,n,i=Oe,r){const s={fn:t,state:i,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:L,context:L?L.context:null,pure:n};return L===null||L!==Ui&&(L.owned?L.owned.push(s):L.owned=[s]),s}function Kt(t){if(t.state===0)return;if(t.state===Nt)return Dt(t);if(t.suspense&&he(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<en);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===Oe)At(t);else if(t.state===Nt){const i=te;te=null,ct(()=>Dt(t,e[0]),!1),te=i}}function ct(t,e){if(te)return t();let n=!1;e||(te=[]),Se?n=!0:Se=[],en++;try{const i=t();return is(n),i}catch(i){n||(Se=null),te=null,Vi(i)}}function is(t){if(te&&(Qi(te),te=null),t)return;const e=Se;Se=null,e.length&&ct(()=>Fi(e),!1)}function Qi(t){for(let e=0;e<t.length;e++)Kt(t[e])}function rs(t){let e,n=0;for(e=0;e<t.length;e++){const i=t[e];i.user?t[n++]=i:Kt(i)}if(Y.context){if(Y.count){Y.effects||(Y.effects=[]),Y.effects.push(...t.slice(0,n));return}Qr()}for(Y.effects&&!Y.count&&(t=[...Y.effects,...t],n+=Y.effects.length,delete Y.effects),e=0;e<n;e++)Kt(t[e])}function Dt(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const i=t.sources[n];if(i.sources){const r=i.state;r===Oe?i!==e&&(!i.updatedAt||i.updatedAt<en)&&Kt(i):r===Nt&&Dt(i,e)}}}function Gi(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=Nt,n.pure?te.push(n):Se.push(n),n.observers&&Gi(n))}}function gt(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),i=t.sourceSlots.pop(),r=n.observers;if(r&&r.length){const s=r.pop(),o=n.observerSlots.pop();i<r.length&&(s.sourceSlots[o]=i,r[i]=s,n.observerSlots[i]=o)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)gt(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)gt(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function ss(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function Vi(t,e=L){throw ss(t)}function gn(t){if(typeof t=="function"&&!t.length)return gn(t());if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++){const i=gn(t[n]);Array.isArray(i)?e.push.apply(e,i):e.push(i)}return e}return t}function os(t,e){return function(i){let r;return Ee(()=>r=he(()=>(L.context={...L.context,[t]:i.value},ts(()=>i.children))),void 0),r}}const cs=Symbol("fallback");function pi(t){for(let e=0;e<t.length;e++)t[e]()}function Qn(t,e,n={}){let i=[],r=[],s=[],o=0,c=e.length>1?[]:null;return Xr(()=>pi(s)),()=>{let l=t()||[],a=l.length,u,h;return l[Jr],he(()=>{let m,p,d,b,_,k,v,C,y;if(a===0)o!==0&&(pi(s),s=[],i=[],r=[],o=0,c&&(c=[])),n.fallback&&(i=[cs],r[0]=xt(E=>(s[0]=E,n.fallback())),o=1);else if(o===0){for(r=new Array(a),h=0;h<a;h++)i[h]=l[h],r[h]=xt(f);o=a}else{for(d=new Array(a),b=new Array(a),c&&(_=new Array(a)),k=0,v=Math.min(o,a);k<v&&i[k]===l[k];k++);for(v=o-1,C=a-1;v>=k&&C>=k&&i[v]===l[C];v--,C--)d[C]=r[v],b[C]=s[v],c&&(_[C]=c[v]);for(m=new Map,p=new Array(C+1),h=C;h>=k;h--)y=l[h],u=m.get(y),p[h]=u===void 0?-1:u,m.set(y,h);for(u=k;u<=v;u++)y=i[u],h=m.get(y),h!==void 0&&h!==-1?(d[h]=r[u],b[h]=s[u],c&&(_[h]=c[u]),h=p[h],m.set(y,h)):s[u]();for(h=k;h<a;h++)h in d?(r[h]=d[h],s[h]=b[h],c&&(c[h]=_[h],c[h](h))):r[h]=xt(f);r=r.slice(0,o=a),i=l.slice(0)}return r});function f(m){if(s[h]=m,c){const[p,d]=ie(h);return c[h]=d,e(l[h],p)}return e(l[h])}}}function X(t,e){return he(()=>t(e||{}))}let ls=0;function as(){return Y.context?Y.getNextContextId():`cl-${ls++}`}const hs=t=>`Stale read from <${t}>.`;function ft(t){const e="fallback"in t&&{fallback:()=>t.fallback};return ee(Qn(()=>t.each,t.children,e||void 0))}function Gn(t){const e=t.keyed,n=ee(()=>t.when,void 0,{equals:(i,r)=>e?i===r:!i==!r});return ee(()=>{const i=n();if(i){const r=t.children;return typeof r=="function"&&r.length>0?he(()=>r(e?i:()=>{if(!he(n))throw hs("Show");return t.when})):r}return t.fallback},void 0,void 0)}function us(t,e,n){let i=n.length,r=e.length,s=i,o=0,c=0,l=e[r-1].nextSibling,a=null;for(;o<r||c<s;){if(e[o]===n[c]){o++,c++;continue}for(;e[r-1]===n[s-1];)r--,s--;if(r===o){const u=s<i?c?n[c-1].nextSibling:n[s-c]:l;for(;c<s;)t.insertBefore(n[c++],u)}else if(s===c)for(;o<r;)(!a||!a.has(e[o]))&&e[o].remove(),o++;else if(e[o]===n[s-1]&&n[c]===e[r-1]){const u=e[--r].nextSibling;t.insertBefore(n[c++],e[o++].nextSibling),t.insertBefore(n[--s],u),e[r]=n[s]}else{if(!a){a=new Map;let h=c;for(;h<s;)a.set(n[h],h++)}const u=a.get(e[o]);if(u!=null)if(c<u&&u<s){let h=o,f=1,m;for(;++h<r&&h<s&&!((m=a.get(e[h]))==null||m!==u+f);)f++;if(f>u-c){const p=e[o];for(;c<u;)t.insertBefore(n[c++],p)}else t.replaceChild(n[c++],e[o++])}else o++;else e[o++].remove()}}}const gi="_$DX_DELEGATE";function fs(t,e,n,i={}){let r;return xt(s=>{r=s,e===document?t():B(e,t(),e.firstChild?null:void 0,n)},i.owner),()=>{r(),e.textContent=""}}function ue(t,e,n){let i;const r=()=>{const o=document.createElement("template");return o.innerHTML=t,o.content.firstChild},s=()=>(i||(i=r())).cloneNode(!0);return s.cloneNode=s,s}function ds(t,e=window.document){const n=e[gi]||(e[gi]=new Set);for(let i=0,r=t.length;i<r;i++){const s=t[i];n.has(s)||(n.add(s),e.addEventListener(s,gs))}}function mi(t,e,n){Jn(t)||(n==null?t.removeAttribute(e):t.setAttribute(e,n))}function Vn(t,e){Jn(t)||(e==null?t.removeAttribute("class"):t.className=e)}function ps(t,e,n,i){if(Array.isArray(n)){const r=n[0];t.addEventListener(e,n[0]=s=>r.call(t,n[1],s))}else t.addEventListener(e,n,typeof n!="function"&&n)}function Ji(t,e,n){return he(()=>t(e,n))}function B(t,e,n,i){if(n!==void 0&&!i&&(i=[]),typeof e!="function")return It(t,e,i,n);Ee(r=>It(t,e(),r,n),i)}function Jn(t){return!!Y.context&&!Y.done&&(!t||t.isConnected)}function gs(t){let e=t.target;const n=`$$${t.type}`,i=t.target,r=t.currentTarget,s=l=>Object.defineProperty(t,"target",{configurable:!0,value:l}),o=()=>{const l=e[n];if(l&&!e.disabled){const a=e[`${n}Data`];if(a!==void 0?l.call(e,a,t):l.call(e,t),t.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(t.target)&&s(e.host),!0},c=()=>{for(;o()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(t,"currentTarget",{configurable:!0,get(){return e||document}}),t.composedPath){const l=t.composedPath();s(l[0]);for(let a=0;a<l.length-2&&(e=l[a],!!o());a++){if(e._$host){e=e._$host,c();break}if(e.parentNode===r)break}}else c();s(i)}function It(t,e,n,i,r){const s=Jn(t);if(s){!n&&(n=[...t.childNodes]);let l=[];for(let a=0;a<n.length;a++){const u=n[a];u.nodeType===8&&u.data.slice(0,2)==="!$"?u.remove():l.push(u)}n=l}for(;typeof n=="function";)n=n();if(e===n)return n;const o=typeof e,c=i!==void 0;if(t=c&&n[0]&&n[0].parentNode||t,o==="string"||o==="number"){if(s||o==="number"&&(e=e.toString(),e===n))return n;if(c){let l=n[0];l&&l.nodeType===3?l.data!==e&&(l.data=e):l=document.createTextNode(e),n=Qe(t,n,i,l)}else n!==""&&typeof n=="string"?n=t.firstChild.data=e:n=t.textContent=e}else if(e==null||o==="boolean"){if(s)return n;n=Qe(t,n,i)}else{if(o==="function")return Ee(()=>{let l=e();for(;typeof l=="function";)l=l();n=It(t,l,n,i)}),()=>n;if(Array.isArray(e)){const l=[],a=n&&Array.isArray(n);if(mn(l,e,n,r))return Ee(()=>n=It(t,l,n,i,!0)),()=>n;if(s){if(!l.length)return n;if(i===void 0)return n=[...t.childNodes];let u=l[0];if(u.parentNode!==t)return n;const h=[u];for(;(u=u.nextSibling)!==i;)h.push(u);return n=h}if(l.length===0){if(n=Qe(t,n,i),c)return n}else a?n.length===0?wi(t,l,i):us(t,n,l):(n&&Qe(t),wi(t,l));n=l}else if(e.nodeType){if(s&&e.parentNode)return n=c?[e]:e;if(Array.isArray(n)){if(c)return n=Qe(t,n,i,e);Qe(t,n,null,e)}else n==null||n===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);n=e}}return n}function mn(t,e,n,i){let r=!1;for(let s=0,o=e.length;s<o;s++){let c=e[s],l=n&&n[t.length],a;if(!(c==null||c===!0||c===!1))if((a=typeof c)=="object"&&c.nodeType)t.push(c);else if(Array.isArray(c))r=mn(t,c,l)||r;else if(a==="function")if(i){for(;typeof c=="function";)c=c();r=mn(t,Array.isArray(c)?c:[c],Array.isArray(l)?l:[l])||r}else t.push(c),r=!0;else{const u=String(c);l&&l.nodeType===3&&l.data===u?t.push(l):t.push(document.createTextNode(u))}}return r}function wi(t,e,n=null){for(let i=0,r=e.length;i<r;i++)t.insertBefore(e[i],n)}function Qe(t,e,n,i){if(n===void 0)return t.textContent="";const r=i||document.createTextNode("");if(e.length){let s=!1;for(let o=e.length-1;o>=0;o--){const c=e[o];if(r!==c){const l=c.parentNode===t;!s&&!o?l?t.replaceChild(r,c):t.insertBefore(r,n):l&&c.remove()}else s=!0}}else t.insertBefore(r,n);return[r]}const ms=["white","black"],zt=["a","b","c","d","e","f","g","h"],qt=["1","2","3","4","5","6","7","8"],ws=[...qt].reverse(),Yn=Array.prototype.concat(...zt.map(t=>qt.map(e=>t+e))),ce=t=>Yn[8*t[0]+t[1]],j=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],Yi=Yn.map(j);function ks(t){let e;const n=()=>(e===void 0&&(e=t()),e);return n.clear=()=>{e=void 0},n}const bs=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Zn=t=>t==="white"?"black":"white",mt=(t,e)=>{const n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i},wn=(t,e)=>t.role===e.role&&t.color===e.color,$t=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],we=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},Zi=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},Xn=(t,e)=>{t.style.visibility=e?"visible":"hidden"},We=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},Xi=t=>t.button===2,Ce=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function er(t,e,n){const i=j(t);return e||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const Le=(t,e)=>Math.abs(t-e),ys=t=>(e,n,i,r)=>Le(e,i)<2&&(t==="white"?r===n+1||n<=1&&r===n+2&&e===i:r===n-1||n>=6&&r===n-2&&e===i),tr=(t,e,n,i)=>{const r=Le(t,n),s=Le(e,i);return r===1&&s===2||r===2&&s===1},nr=(t,e,n,i)=>Le(t,n)===Le(e,i),ir=(t,e,n,i)=>t===n||e===i,rr=(t,e,n,i)=>nr(t,e,n,i)||ir(t,e,n,i),vs=(t,e,n)=>(i,r,s,o)=>Le(i,s)<2&&Le(r,o)<2||n&&r===o&&r===(t==="white"?0:7)&&(i===4&&(s===2&&e.includes(0)||s===6&&e.includes(7))||e.includes(s));function _s(t,e){const n=e==="white"?"1":"8",i=[];for(const[r,s]of t)r[1]===n&&s.color===e&&s.role==="rook"&&i.push(j(r)[0]);return i}function sr(t,e,n){const i=t.get(e);if(!i)return[];const r=j(e),s=i.role,o=s==="pawn"?ys(i.color):s==="knight"?tr:s==="bishop"?nr:s==="rook"?ir:s==="queen"?rr:vs(i.color,_s(t,i.color),n);return Yi.filter(c=>(r[0]!==c[0]||r[1]!==c[1])&&o(r[0],r[1],c[0],c[1])).map(ce)}function re(t,...e){t&&setTimeout(()=>t(...e),1)}function Cs(t){t.orientation=Zn(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function Ss(t,e){for(const[n,i]of e)i?t.pieces.set(n,i):t.pieces.delete(n)}function Es(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[n,i]of t.pieces)i.role==="king"&&i.color===e&&(t.check=n)}function As(t,e,n,i){Te(t),t.premovable.current=[e,n],re(t.premovable.events.set,e,n,i)}function Ne(t){t.premovable.current&&(t.premovable.current=void 0,re(t.premovable.events.unset))}function $s(t,e,n){Ne(t),t.predroppable.current={role:e,key:n},re(t.predroppable.events.set,e,n)}function Te(t){const e=t.predroppable;e.current&&(e.current=void 0,re(e.events.unset))}function Ps(t,e,n){if(!t.autoCastle)return!1;const i=t.pieces.get(e);if(!i||i.role!=="king")return!1;const r=j(e),s=j(n);if(r[1]!==0&&r[1]!==7||r[1]!==s[1])return!1;r[0]===4&&!t.pieces.has(n)&&(s[0]===6?n=ce([7,s[1]]):s[0]===2&&(n=ce([0,s[1]])));const o=t.pieces.get(n);return!o||o.color!==i.color||o.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(n),r[0]<s[0]?(t.pieces.set(ce([6,s[1]]),i),t.pieces.set(ce([5,s[1]]),o)):(t.pieces.set(ce([2,s[1]]),i),t.pieces.set(ce([3,s[1]]),o)),!0)}function or(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!i)return!1;const s=r&&r.color!==i.color?r:void 0;return n===t.selected&&ae(t),re(t.events.move,e,n,s),Ps(t,e,n)||(t.pieces.set(n,i),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,re(t.events.change),s||!0}function ei(t,e,n,i){if(t.pieces.has(n))if(i)t.pieces.delete(n);else return!1;return re(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,re(t.events.change),t.movable.dests=void 0,t.turnColor=Zn(t.turnColor),!0}function cr(t,e,n){const i=or(t,e,n);return i&&(t.movable.dests=void 0,t.turnColor=Zn(t.turnColor),t.animation.current=void 0),i}function lr(t,e,n){if(ti(t,e,n)){const i=cr(t,e,n);if(i){const r=t.hold.stop();ae(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return i!==!0&&(s.captured=i),re(t.movable.events.after,e,n,s),!0}}else if(xs(t,e,n))return As(t,e,n,{ctrlKey:t.stats.ctrlKey}),ae(t),!0;return ae(t),!1}function ar(t,e,n,i){const r=t.pieces.get(e);r&&(Rs(t,e,n)||i)?(t.pieces.delete(e),ei(t,r,n,i),re(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&Ms(t,e,n)?$s(t,r.role,n):(Ne(t),Te(t)),t.pieces.delete(e),ae(t)}function kn(t,e,n){if(re(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){ae(t),t.hold.cancel();return}else if((t.selectable.enabled||n)&&t.selected!==e&&lr(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(ur(t,e)||ni(t,e))&&(hr(t,e),t.hold.start())}function hr(t,e){t.selected=e,ni(t,e)?t.premovable.customDests||(t.premovable.dests=sr(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function ae(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function ur(t,e){const n=t.pieces.get(e);return!!n&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}const ti=(t,e,n)=>{var i,r;return e!==n&&ur(t,e)&&(t.movable.free||!!(!((r=(i=t.movable.dests)===null||i===void 0?void 0:i.get(e))===null||r===void 0)&&r.includes(n)))};function Rs(t,e,n){const i=t.pieces.get(e);return!!i&&(e===n||!t.pieces.has(n))&&(t.movable.color==="both"||t.movable.color===i.color&&t.turnColor===i.color)}function ni(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function xs(t,e,n){var i,r;const s=(r=(i=t.premovable.customDests)===null||i===void 0?void 0:i.get(e))!==null&&r!==void 0?r:sr(t.pieces,e,t.premovable.castle);return e!==n&&ni(t,e)&&s.includes(n)}function Ms(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);return!!i&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&t.movable.color===i.color&&t.turnColor!==i.color}function Os(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}function Ns(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],i=e[1];let r=!1;if(ti(t,n,i)){const s=cr(t,n,i);if(s){const o={premove:!0};s!==!0&&(o.captured=s),re(t.movable.events.after,n,i,o),r=!0}}return Ne(t),r}function Ts(t,e){const n=t.predroppable.current;let i=!1;if(!n)return!1;if(e(n)){const r={role:n.role,color:t.movable.color};ei(t,r,n.key)&&(re(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return Te(t),i}function ii(t){Ne(t),Te(t),ae(t)}function ki(t){t.movable.color=t.movable.dests=t.animation.current=void 0,ii(t)}function He(t,e,n){let i=Math.floor(8*(t[0]-n.left)/n.width);e||(i=7-i);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),i>=0&&i<8&&r>=0&&r<8?ce([i,r]):void 0}function Ks(t,e,n,i){const r=j(t),s=Yi.filter(a=>rr(r[0],r[1],a[0],a[1])||tr(r[0],r[1],a[0],a[1])),c=s.map(a=>er(ce(a),n,i)).map(a=>mt(e,a)),[,l]=c.reduce((a,u,h)=>a[0]<u?a:[u,h],[c[0],0]);return ce(s[l])}const se=t=>t.orientation==="white",fr="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ds={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Is={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function dr(t){t==="start"&&(t=fr);const e=new Map;let n=7,i=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--n,n<0)return e;i=0;break;case"~":{const s=e.get(ce([i-1,n]));s&&(s.promoted=!0);break}default:{const s=r.charCodeAt(0);if(s<57)i+=s-48;else{const o=r.toLowerCase();e.set(ce([i,n]),{role:Ds[o],color:r===o?"black":"white"}),++i}}}return e}function zs(t){return ws.map(e=>zt.map(n=>{const i=t.get(n+e);if(i){let r=Is[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function pr(t,e){e.animation&&(ri(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function gr(t,e){var n,i,r;if(!((n=e.movable)===null||n===void 0)&&n.dests&&(t.movable.dests=void 0),!((i=e.drawable)===null||i===void 0)&&i.autoShapes&&(t.drawable.autoShapes=[]),ri(t,e),e.fen&&(t.pieces=dr(e.fen),t.drawable.shapes=((r=e.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in e&&Es(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&hr(t,t.selected),pr(t,e),!t.movable.rookCastle&&t.movable.dests){const s=t.movable.color==="white"?"1":"8",o="e"+s,c=t.movable.dests.get(o),l=t.pieces.get(o);if(!c||!l||l.role!=="king")return;t.movable.dests.set(o,c.filter(a=>!(a==="a"+s&&c.includes("c"+s))&&!(a==="h"+s&&c.includes("g"+s))))}}function ri(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)&&bi(t[n])&&bi(e[n])?ri(t[n],e[n]):t[n]=e[n])}function bi(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const Ke=(t,e)=>e.animation.enabled?Bs(t,e):$e(t,e);function $e(t,e){const n=t(e);return e.dom.redraw(),n}const ln=(t,e)=>({key:t,pos:j(t),piece:e}),qs=(t,e)=>e.sort((n,i)=>mt(t.pos,n.pos)-mt(t.pos,i.pos))[0];function Ls(t,e){const n=new Map,i=[],r=new Map,s=[],o=[],c=new Map;let l,a,u;for(const[h,f]of t)c.set(h,ln(h,f));for(const h of Yn)l=e.pieces.get(h),a=c.get(h),l?a?wn(l,a.piece)||(s.push(a),o.push(ln(h,l))):o.push(ln(h,l)):a&&s.push(a);for(const h of o)a=qs(h,s.filter(f=>wn(h.piece,f.piece))),a&&(u=[a.pos[0]-h.pos[0],a.pos[1]-h.pos[1]],n.set(h.key,u.concat(u)),i.push(a.key));for(const h of s)i.includes(h.key)||r.set(h.key,h.piece);return{anims:n,fadings:r}}function mr(t,e){const n=t.animation.current;if(n===void 0){t.dom.destroyed||t.dom.redrawNow();return}const i=1-(e-n.start)*n.frequency;if(i<=0)t.animation.current=void 0,t.dom.redrawNow();else{const r=js(i);for(const s of n.plan.anims.values())s[2]=s[0]*r,s[3]=s[1]*r;t.dom.redrawNow(!0),requestAnimationFrame((s=performance.now())=>mr(t,s))}}function Bs(t,e){const n=new Map(e.pieces),i=t(e),r=Ls(n,e);if(r.anims.size||r.fadings.size){const s=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},s||mr(e,performance.now())}else e.dom.redraw();return i}const js=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,Fs=["green","red","blue","yellow"];function Us(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?ae(t):ii(t);const n=We(e),i=He(n,se(t),t.dom.bounds());i&&(t.drawable.current={orig:i,pos:n,brush:Gs(e),snapToValidMove:t.drawable.defaultSnapToValidMove},wr(t))}function wr(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const n=He(e.pos,se(t),t.dom.bounds());n||(e.snapToValidMove=!1);const i=e.snapToValidMove?Ks(e.orig,e.pos,se(t),t.dom.bounds()):n;i!==e.mouseSq&&(e.mouseSq=i,e.dest=i!==e.orig?i:void 0,t.dom.redrawNow()),wr(t)}})}function Ws(t,e){t.drawable.current&&(t.drawable.current.pos=We(e))}function Hs(t){const e=t.drawable.current;e&&(e.mouseSq&&Vs(t.drawable,e),kr(t))}function kr(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function Qs(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),br(t.drawable))}function Gs(t){var e;const n=(t.shiftKey||t.ctrlKey)&&Xi(t),i=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return Fs[(n?1:0)+(i?2:0)]}function Vs(t,e){const n=r=>r.orig===e.orig&&r.dest===e.dest,i=t.shapes.find(n);i&&(t.shapes=t.shapes.filter(r=>!n(r))),(!i||i.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),br(t)}function br(t){t.onChange&&t.onChange(t.shapes)}function Js(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),i=We(e),r=He(i,se(t),n);if(!r)return;const s=t.pieces.get(r),o=t.selected;if(!o&&t.drawable.enabled&&(t.drawable.eraseOnClick||!s||s.color!==t.turnColor)&&Qs(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||s||o||Ys(t,i)))e.preventDefault();else if(e.touches)return;const c=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&ti(t,t.selected,r)?Ke(h=>kn(h,r),t):kn(t,r);const a=t.selected===r,u=vr(t,r);if(s&&u&&a&&Os(t,r)){t.draggable.current={orig:r,piece:s,origPos:i,pos:i,started:t.draggable.autoDistance&&t.stats.dragged,element:u,previouslySelected:o,originTarget:e.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");const h=t.dom.elements.ghost;h&&(h.className=`ghost ${s.color} ${s.role}`,we(h,$t(n)(j(r),se(t))),Xn(h,!0)),si(t)}else c&&Ne(t),l&&Te(t);t.dom.redraw()}function Ys(t,e){const n=se(t),i=t.dom.bounds(),r=Math.pow(i.width/8,2);for(const s of t.pieces.keys()){const o=er(s,n,i);if(mt(o,e)<=r)return!0}return!1}function Zs(t,e,n,i){const r="a0";t.pieces.set(r,e),t.dom.redraw();const s=We(n);t.draggable.current={orig:r,piece:e,origPos:s,pos:s,started:!0,element:()=>vr(t,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},si(t)}function si(t){requestAnimationFrame(()=>{var e;const n=t.draggable.current;if(!n)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(n.orig)&&(t.animation.current=void 0);const i=t.pieces.get(n.orig);if(!i||!wn(i,n.piece))Lt(t);else if(!n.started&&mt(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const s=n.element();if(!s)return;s.cgDragging=!0,s.classList.add("dragging"),n.element=s}const r=t.dom.bounds();we(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==He(n.pos,se(t),r))}si(t)})}function Xs(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=We(e))}function eo(t,e){const n=t.draggable.current;if(!n)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&n.originTarget!==e.target&&!n.newPiece){t.draggable.current=void 0;return}Ne(t),Te(t);const i=We(e)||n.pos,r=He(i,se(t),t.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?ar(t,n.orig,r,n.force):(t.stats.ctrlKey=e.ctrlKey,lr(t,n.orig,r)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!r&&(t.pieces.delete(n.orig),re(t.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?ae(t):t.selectable.enabled||ae(t),yr(t),t.draggable.current=void 0,t.dom.redraw()}function Lt(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,ae(t),yr(t),t.dom.redraw())}function yr(t){const e=t.dom.elements;e.ghost&&Xn(e.ghost,!1)}function vr(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&n.tagName==="PIECE")return n;n=n.nextSibling}}function to(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{yi(t,2),setTimeout(()=>yi(t,void 0),120)},120)}function yi(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function no(t,e){function n(){Cs(t),e()}return{set(i){i.orientation&&i.orientation!==t.orientation&&n(),pr(t,i),(i.fen?Ke:$e)(r=>gr(r,i),t)},state:t,getFen:()=>zs(t.pieces),toggleOrientation:n,setPieces(i){Ke(r=>Ss(r,i),t)},selectSquare(i,r){i?Ke(s=>kn(s,i,r),t):t.selected&&(ae(t),t.dom.redraw())},move(i,r){Ke(s=>or(s,i,r),t)},newPiece(i,r){Ke(s=>ei(s,i,r),t)},playPremove(){if(t.premovable.current){if(Ke(Ns,t))return!0;t.dom.redraw()}return!1},playPredrop(i){if(t.predroppable.current){const r=Ts(t,i);return t.dom.redraw(),r}return!1},cancelPremove(){$e(Ne,t)},cancelPredrop(){$e(Te,t)},cancelMove(){$e(i=>{ii(i),Lt(i)},t)},stop(){$e(i=>{ki(i),Lt(i)},t)},explode(i){to(t,i)},setAutoShapes(i){$e(r=>r.drawable.autoShapes=i,t)},setShapes(i){$e(r=>r.drawable.shapes=i,t)},getKeyAtDomPos(i){return He(i,se(t),t.dom.bounds())},redrawAll:e,dragNewPiece(i,r,s){Zs(t,i,r,s)},destroy(){ki(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function io(){return{pieces:dr(fr),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:bs()}}const vi={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function ro(){const t=G("defs"),e=ne(G("filter"),{id:"cg-filter-blur"});return e.appendChild(ne(G("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function so(t,e,n){var i;const r=t.drawable,s=r.current,o=s&&s.mouseSq?s:void 0,c=new Map,l=t.dom.bounds(),a=r.autoShapes.filter(m=>!m.piece);for(const m of r.shapes.concat(a).concat(o?[o]:[])){if(!m.dest)continue;const p=(i=c.get(m.dest))!==null&&i!==void 0?i:new Set,d=Ft(jt(j(m.orig),t.orientation),l),b=Ft(jt(j(m.dest),t.orientation),l);p.add(yn(d,b)),c.set(m.dest,p)}const u=r.shapes.concat(a).map(m=>({shape:m,current:!1,hash:_i(m,bn(m.dest,c),!1,l)}));o&&u.push({shape:o,current:!0,hash:_i(o,bn(o.dest,c),!0,l)});const h=u.map(m=>m.hash).join(";");if(h===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=h;const f=e.querySelector("defs");oo(r,u,f),co(u,e.querySelector("g"),n.querySelector("g"),m=>ho(t,m,r.brushes,c,l))}function oo(t,e,n){var i;const r=new Map;let s;for(const l of e.filter(a=>a.shape.dest&&a.shape.brush))s=_r(t.brushes[l.shape.brush],l.shape.modifiers),!((i=l.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(Bt(s).key,Bt(s)),r.set(s.key,s);const o=new Set;let c=n.firstElementChild;for(;c;)o.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(const[l,a]of r.entries())o.has(l)||n.appendChild(po(a))}function co(t,e,n,i){const r=new Map;for(const s of t)r.set(s.hash,!1);for(const s of[e,n]){const o=[];let c=s.firstElementChild,l;for(;c;)l=c.getAttribute("cgHash"),r.has(l)?r.set(l,!0):o.push(c),c=c.nextElementSibling;for(const a of o)s.removeChild(a)}for(const s of t.filter(o=>!r.get(o.hash)))for(const o of i(s))o.isCustom?n.appendChild(o.el):e.appendChild(o.el)}function _i({orig:t,dest:e,brush:n,piece:i,modifiers:r,customSvg:s,label:o},c,l,a){var u,h;return[a.width,a.height,l,t,e,n,c&&"-",i&&lo(i),r&&ao(r),s&&`custom-${Ci(s.html)},${(h=(u=s.center)===null||u===void 0?void 0:u[0])!==null&&h!==void 0?h:"o"}`,o&&`label-${Ci(o.text)}`].filter(f=>f).join(",")}function lo(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function ao(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function Ci(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return e.toString()}function ho(t,{shape:e,current:n,hash:i},r,s,o){var c,l;const a=Ft(jt(j(e.orig),t.orientation),o),u=e.dest?Ft(jt(j(e.dest),t.orientation),o):a,h=e.brush&&_r(r[e.brush],e.modifiers),f=s.get(e.dest),m=[];if(h){const p=ne(G("g"),{cgHash:i});m.push({el:p}),a[0]!==u[0]||a[1]!==u[1]?p.appendChild(fo(e,h,a,u,n,bn(e.dest,s))):p.appendChild(uo(r[e.brush],a,n,o))}if(e.label){const p=e.label;(c=p.fill)!==null&&c!==void 0||(p.fill=e.brush&&r[e.brush].color);const d=e.brush?void 0:"tr";m.push({el:go(p,i,a,u,f,d),isCustom:!0})}if(e.customSvg){const p=(l=e.customSvg.center)!==null&&l!==void 0?l:"orig",[d,b]=p==="label"?Sr(a,u,f).map(k=>k-.5):p==="dest"?u:a,_=ne(G("g"),{transform:`translate(${d},${b})`,cgHash:i});_.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,m.push({el:_,isCustom:!0})}return m}function uo(t,e,n,i){const r=mo(),s=(i.width+i.height)/(4*Math.max(i.width,i.height));return ne(G("circle"),{stroke:t.color,"stroke-width":r[n?0:1],fill:"none",opacity:Cr(t,n),cx:e[0],cy:e[1],r:s-r[1]/2})}function Bt(t){return["#ffffff","#fff","white"].includes(t.color)?vi.hilitePrimary:vi.hiliteWhite}function fo(t,e,n,i,r,s){var o;function c(u){var h;const f=ko(s&&!r),m=i[0]-n[0],p=i[1]-n[1],d=Math.atan2(p,m),b=Math.cos(d)*f,_=Math.sin(d)*f;return ne(G("line"),{stroke:u?Bt(e).color:e.color,"stroke-width":wo(e,r)+(u?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?Bt(e).key:e.key})`,opacity:!((h=t.modifiers)===null||h===void 0)&&h.hilite?1:Cr(e,r),x1:n[0],y1:n[1],x2:i[0]-b,y2:i[1]-_})}if(!(!((o=t.modifiers)===null||o===void 0)&&o.hilite))return c(!1);const l=G("g"),a=ne(G("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(bo(n,i)),a.appendChild(c(!0)),l.appendChild(a),l.appendChild(c(!1)),l}function po(t){const e=ne(G("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(ne(G("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function go(t,e,n,i,r,s){var o;const l=.4*.75**t.text.length,a=Sr(n,i,r),u=s==="tr"?.4:0,h=ne(G("g"),{transform:`translate(${a[0]+u},${a[1]-u})`,cgHash:e});h.appendChild(ne(G("circle"),{r:.4/2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:(o=t.fill)!==null&&o!==void 0?o:"#666",stroke:"white"}));const f=ne(G("text"),{"font-size":l,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return f.innerHTML=t.text,h.appendChild(f),h}function jt(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function bn(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function G(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function ne(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.setAttribute(n,e[n]);return t}function _r(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(n=>n).join("")}:t}function mo(){return[3/64,4/64]}function wo(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Cr(t,e){return(t.opacity||1)*(e?.9:1)}function ko(t){return(t?20:10)/64}function Ft(t,e){const n=Math.min(1,e.width/e.height),i=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*i]}function bo(t,e){const n={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return ne(G("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function yn(t,e,n=!0){const i=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function yo(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((n,i)=>n+i*i,0))}function Sr(t,e,n){let i=yo(t,e);const r=yn(t,e,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const s=yn(t,e);(n.has((s+1)%16)||n.has((s+15)%16))&&s&1&&(i-=.4)}return[t[0]-Math.cos(r)*i,t[1]-Math.sin(r)*i].map(s=>s+.5)}function vo(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const l of ms)t.classList.toggle("orientation-"+l,e.orientation===l);t.classList.toggle("manipulable",!e.viewOnly);const n=Ce("cg-container");t.appendChild(n);const i=Ce("cg-board");n.appendChild(i);let r,s,o;if(e.drawable.visible&&(r=ne(G("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(ro()),r.appendChild(G("g")),s=ne(G("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(G("g")),o=Ce("cg-auto-pieces"),n.appendChild(r),n.appendChild(s),n.appendChild(o)),e.coordinates){const l=e.orientation==="black"?" black":"",a=e.ranksPosition==="left"?" left":"";if(e.coordinatesOnSquares){const u=e.orientation==="white"?h=>h+1:h=>8-h;zt.forEach((h,f)=>n.appendChild(an(qt.map(m=>h+m),"squares rank"+u(f)+l+a)))}else n.appendChild(an(qt,"ranks"+l+a)),n.appendChild(an(zt,"files"+l))}let c;return e.draggable.enabled&&e.draggable.showGhost&&(c=Ce("piece","ghost"),Xn(c,!1),n.appendChild(c)),{board:i,container:n,wrap:t,ghost:c,svg:r,customSvg:s,autoPieces:o}}function an(t,e){const n=Ce("coords",e);let i;for(const r of t)i=Ce("coord"),i.textContent=r,n.appendChild(i);return n}function _o(t,e){if(!t.dropmode.active)return;Ne(t),Te(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const i=We(e),r=i&&He(i,se(t),t.dom.bounds());r&&ar(t,"a0",r)}t.dom.redraw()}function Co(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),t.viewOnly)return;const i=Eo(t);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function So(t,e){const n=[];if("ResizeObserver"in window||n.push(lt(document.body,"chessground.resize",e)),!t.viewOnly){const i=Si(t,Xs,Ws),r=Si(t,eo,Hs);for(const o of["touchmove","mousemove"])n.push(lt(document,o,i));for(const o of["touchend","mouseup"])n.push(lt(document,o,r));const s=()=>t.dom.bounds.clear();n.push(lt(document,"scroll",s,{capture:!0,passive:!0})),n.push(lt(window,"resize",s,{passive:!0}))}return()=>n.forEach(i=>i())}function lt(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}const Eo=t=>e=>{t.draggable.current?Lt(t):t.drawable.current?kr(t):e.shiftKey||Xi(e)?t.drawable.enabled&&Us(t,e):t.viewOnly||(t.dropmode.active?_o(t,e):Js(t,e))},Si=(t,e,n)=>i=>{t.drawable.current?t.drawable.enabled&&n(t,i):t.viewOnly||e(t,i)};function Ao(t){const e=se(t),n=$t(t.dom.bounds()),i=t.dom.elements.board,r=t.pieces,s=t.animation.current,o=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,l=t.draggable.current,a=Po(t),u=new Set,h=new Set,f=new Map,m=new Map;let p,d,b,_,k,v,C,y,E,P;for(d=i.firstChild;d;){if(p=d.cgKey,Er(d))if(b=r.get(p),k=o.get(p),v=c.get(p),_=d.cgPiece,d.cgDragging&&(!l||l.orig!==p)&&(d.classList.remove("dragging"),we(d,n(j(p),e)),d.cgDragging=!1),!v&&d.cgFading&&(d.cgFading=!1,d.classList.remove("fading")),b){if(k&&d.cgAnimating&&_===at(b)){const A=j(p);A[0]+=k[2],A[1]+=k[3],d.classList.add("anim"),we(d,n(A,e))}else d.cgAnimating&&(d.cgAnimating=!1,d.classList.remove("anim"),we(d,n(j(p),e)),t.addPieceZIndex&&(d.style.zIndex=hn(j(p),e)));_===at(b)&&(!v||!d.cgFading)?u.add(p):v&&_===at(v)?(d.classList.add("fading"),d.cgFading=!0):un(f,_,d)}else un(f,_,d);else if(Ar(d)){const A=d.className;a.get(p)===A?h.add(p):un(m,A,d)}d=d.nextSibling}for(const[A,I]of a)if(!h.has(A)){E=m.get(I),P=E&&E.pop();const K=n(j(A),e);if(P)P.cgKey=A,we(P,K);else{const D=Ce("square",I);D.cgKey=A,we(D,K),i.insertBefore(D,i.firstChild)}}for(const[A,I]of r)if(k=o.get(A),!u.has(A))if(C=f.get(at(I)),y=C&&C.pop(),y){y.cgKey=A,y.cgFading&&(y.classList.remove("fading"),y.cgFading=!1);const K=j(A);t.addPieceZIndex&&(y.style.zIndex=hn(K,e)),k&&(y.cgAnimating=!0,y.classList.add("anim"),K[0]+=k[2],K[1]+=k[3]),we(y,n(K,e))}else{const K=at(I),D=Ce("piece",K),z=j(A);D.cgPiece=K,D.cgKey=A,k&&(D.cgAnimating=!0,z[0]+=k[2],z[1]+=k[3]),we(D,n(z,e)),t.addPieceZIndex&&(D.style.zIndex=hn(z,e)),i.appendChild(D)}for(const A of f.values())Ai(t,A);for(const A of m.values())Ai(t,A)}function $o(t){const e=se(t),n=$t(t.dom.bounds());let i=t.dom.elements.board.firstChild;for(;i;)(Er(i)&&!i.cgAnimating||Ar(i))&&we(i,n(j(i.cgKey),e)),i=i.nextSibling}function Ei(t){var e,n;const i=t.dom.elements.wrap.getBoundingClientRect(),r=t.dom.elements.container,s=i.height/i.width,o=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=o*s;r.style.width=o+"px",r.style.height=c+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("---cg-width",o+"px"),(n=t.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",c+"px")}const Er=t=>t.tagName==="PIECE",Ar=t=>t.tagName==="SQUARE";function Ai(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function hn(t,e){const i=t[1];return`${e?10-i:3+i}`}const at=t=>`${t.color} ${t.role}`;function Po(t){var e,n,i;const r=new Map;if(t.lastMove&&t.highlight.lastMove)for(const c of t.lastMove)ve(r,c,"last-move");if(t.check&&t.highlight.check&&ve(r,t.check,"check"),t.selected&&(ve(r,t.selected,"selected"),t.movable.showDests)){const c=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(c)for(const a of c)ve(r,a,"move-dest"+(t.pieces.has(a)?" oc":""));const l=(i=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(t.selected))!==null&&i!==void 0?i:t.premovable.dests;if(l)for(const a of l)ve(r,a,"premove-dest"+(t.pieces.has(a)?" oc":""))}const s=t.premovable.current;if(s)for(const c of s)ve(r,c,"current-premove");else t.predroppable.current&&ve(r,t.predroppable.current.key,"current-premove");const o=t.exploding;if(o)for(const c of o.keys)ve(r,c,"exploding"+o.stage);return t.highlight.custom&&t.highlight.custom.forEach((c,l)=>{ve(r,l,c)}),r}function ve(t,e,n){const i=t.get(e);i?t.set(e,`${i} ${n}`):t.set(e,n)}function un(t,e,n){const i=t.get(e);i?i.push(n):t.set(e,[n])}function Ro(t,e,n){const i=new Map,r=[];for(const c of t)i.set(c.hash,!1);let s=e.firstElementChild,o;for(;s;)o=s.getAttribute("cgHash"),i.has(o)?i.set(o,!0):r.push(s),s=s.nextElementSibling;for(const c of r)e.removeChild(c);for(const c of t)i.get(c.hash)||e.appendChild(n(c))}function xo(t,e){const i=t.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:No(r),current:!1}));Ro(i,e,r=>Oo(t,r,t.dom.bounds()))}function Mo(t){var e;const n=se(t),i=$t(t.dom.bounds());let r=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;r;)Zi(r,i(j(r.cgKey),n),r.cgScale),r=r.nextSibling}function Oo(t,{shape:e,hash:n},i){var r,s,o;const c=e.orig,l=(r=e.piece)===null||r===void 0?void 0:r.role,a=(s=e.piece)===null||s===void 0?void 0:s.color,u=(o=e.piece)===null||o===void 0?void 0:o.scale,h=Ce("piece",`${l} ${a}`);return h.setAttribute("cgHash",n),h.cgKey=c,h.cgScale=u,Zi(h,$t(i)(j(c),se(t)),u),h}const No=t=>{var e,n,i;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(n=t.piece)===null||n===void 0?void 0:n.color,(i=t.piece)===null||i===void 0?void 0:i.scale].join(",")};function To(t,e){const n=io();gr(n,e||{});function i(){const r="dom"in n?n.dom.unbind:void 0,s=vo(t,n),o=ks(()=>s.board.getBoundingClientRect()),c=u=>{Ao(a),s.autoPieces&&xo(a,s.autoPieces),!u&&s.svg&&so(a,s.svg,s.customSvg)},l=()=>{Ei(a),$o(a),s.autoPieces&&Mo(a)},a=n;return a.dom={elements:s,bounds:o,redraw:Ko(c),redrawNow:c,unbind:r},a.drawable.prevSvgHash="",Ei(a),c(!1),Co(a,l),r||(a.dom.unbind=So(a,l)),a.events.insert&&a.events.insert(s),a}return no(i(),i)}function Ko(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}let $r=class{unwrap(e,n){const i=this._chain(r=>O.ok(e?e(r):r),r=>n?O.ok(n(r)):O.err(r));if(i.isErr)throw i.error;return i.value}map(e,n){return this._chain(i=>O.ok(e(i)),i=>O.err(n?n(i):i))}chain(e,n){return this._chain(e,n||(i=>O.err(i)))}},Do=class extends $r{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}},Io=class extends $r{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}};var O;(function(t){t.ok=function(e){return new Do(e)},t.err=function(e){return new Io(e||new Error)},t.all=function(e){if(Array.isArray(e)){const r=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;r.push(o.value)}return t.ok(r)}const n={},i=Object.keys(e);for(let r=0;r<i.length;r++){const s=e[i[r]];if(s.isErr)return s;n[i[r]]=s.value}return t.ok(n)}})(O||(O={}));const $i=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),vn=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Pi=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,vn(t));let w=class T{constructor(e,n){S(this,"lo");S(this,"hi");this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new T(0,1<<e-32):new T(1<<e,0)}static fromRank(e){return new T(255,0).shl64(8*e)}static fromFile(e){return new T(16843009<<e,16843009<<e)}static empty(){return new T(0,0)}static full(){return new T(4294967295,4294967295)}static corners(){return new T(129,2164260864)}static center(){return new T(402653184,24)}static backranks(){return new T(255,4278190080)}static backrank(e){return e==="white"?new T(255,0):new T(0,4278190080)}static lightSquares(){return new T(1437226410,1437226410)}static darkSquares(){return new T(2857740885,2857740885)}complement(){return new T(~this.lo,~this.hi)}xor(e){return new T(this.lo^e.lo,this.hi^e.hi)}union(e){return new T(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new T(this.lo&e.lo,this.hi&e.hi)}diff(e){return new T(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?T.empty():e>=32?new T(this.hi>>>e-32,0):e>0?new T(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?T.empty():e>=32?new T(0,this.lo<<e-32):e>0?new T(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new T(vn(this.hi),vn(this.lo))}rbit64(){return new T(Pi(this.hi),Pi(this.lo))}minus64(e){const n=this.lo-e.lo,i=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new T(n,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return $i(this.lo)+$i(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new T(this.lo,this.hi|1<<e-32):new T(this.lo|1<<e,this.hi)}without(e){return e>=32?new T(this.lo,this.hi&~(1<<e-32)):new T(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new T(this.lo,this.hi^1<<e-32):new T(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new T(this.lo&this.lo-1,this.hi):new T(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const i=31-Math.clz32(e&-e);e^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;e!==0;){const i=31-Math.clz32(e);e^=1<<i,yield i}}};const Ut=["a","b","c","d","e","f","g","h"],Pr=["1","2","3","4","5","6","7","8"],Be=["white","black"],pe=["pawn","knight","bishop","rook","queen","king"],zo=["a","h"];let Rr=class Mt{constructor(){S(this,"occupied");S(this,"promoted");S(this,"white");S(this,"black");S(this,"pawn");S(this,"knight");S(this,"bishop");S(this,"rook");S(this,"queen");S(this,"king")}static default(){const e=new Mt;return e.reset(),e}reset(){this.occupied=new w(65535,4294901760),this.promoted=w.empty(),this.white=new w(65535,0),this.black=new w(0,4294901760),this.pawn=new w(65280,16711680),this.knight=new w(66,1107296256),this.bishop=new w(36,603979776),this.rook=new w(129,2164260864),this.queen=new w(8,134217728),this.king=new w(16,268435456)}static empty(){const e=new Mt;return e.clear(),e}clear(){this.occupied=w.empty(),this.promoted=w.empty();for(const e of Be)this[e]=w.empty();for(const e of pe)this[e]=w.empty()}clone(){const e=new Mt;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of Be)e[n]=this[n];for(const n of pe)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of pe)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const i=this.getRole(e),r=this.promoted.has(e);return{color:n,role:i,promoted:r}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const i=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),i}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}},Pt=class Ze{constructor(){S(this,"pawn");S(this,"knight");S(this,"bishop");S(this,"rook");S(this,"queen");S(this,"king")}static empty(){const e=new Ze;for(const n of pe)e[n]=0;return e}static fromBoard(e,n){const i=new Ze;for(const r of pe)i[r]=e.pieces(n,r).size();return i}clone(){const e=new Ze;for(const n of pe)e[n]=this[n];return e}equals(e){return pe.every(n=>this[n]===e[n])}add(e){const n=new Ze;for(const i of pe)n[i]=this[i]+e[i];return n}subtract(e){const n=new Ze;for(const i of pe)n[i]=this[i]-e[i];return n}nonEmpty(){return pe.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},qo=class Xe{constructor(e,n){S(this,"white");S(this,"black");this.white=e,this.black=n}static empty(){return new Xe(Pt.empty(),Pt.empty())}static fromBoard(e){return new Xe(Pt.fromBoard(e,"white"),Pt.fromBoard(e,"black"))}clone(){return new Xe(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new Xe(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new Xe(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},Ri=class _n{constructor(e,n){S(this,"white");S(this,"black");this.white=e,this.black=n}static default(){return new _n(3,3)}clone(){return new _n(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}};const x=t=>t!==void 0,q=t=>t==="white"?"black":"white",je=t=>t>>3,le=t=>t&7,Cn=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,Wt=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Lo(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Bo(t){if(t.length===2)return Cn(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const xr=t=>Ut[le(t)]+Pr[je(t)],oi=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,ci=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,jo="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Fo=jo+" w KQkq -",Uo=Fo+" 0 1";var H;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(H||(H={}));let V=class extends Error{};const Wo=(t,e,n)=>{let i=t.indexOf(e);for(;n-- >0&&i!==-1;)i=t.indexOf(e,i+e.length);return i},tt=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,Mr=t=>{const e=Lo(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},fn=t=>{const e=Rr.empty();let n=7,i=0;for(let r=0;r<t.length;r++){const s=t[r];if(s==="/"&&i===8)i=0,n--;else{const o=parseInt(s,10);if(o>0)i+=o;else{if(i>=8||n<0)return O.err(new V(H.Board));const c=i+n*8,l=Mr(s);if(!l)return O.err(new V(H.Board));t[r+1]==="~"&&(l.promoted=!0,r++),e.set(c,l),i++}}}return n!==0||i!==8?O.err(new V(H.Board)):O.ok(e)},xi=t=>{if(t.length>64)return O.err(new V(H.Pockets));const e=qo.empty();for(const n of t){const i=Mr(n);if(!i)return O.err(new V(H.Pockets));e[i.color][i.role]++}return O.ok(e)},Ho=(t,e)=>{let n=w.empty();if(e==="-")return O.ok(n);for(const i of e){const r=i.toLowerCase(),s=i===r?"black":"white",o=s==="white"?0:7;if("a"<=r&&r<="h")n=n.with(Cn(r.charCodeAt(0)-97,o));else if(r==="k"||r==="q"){const c=t[s].intersect(w.backrank(s)).intersect(t.rook.union(t.king)),l=r==="k"?c.last():c.first();n=n.with(x(l)&&t.rook.has(l)?l:Cn(r==="k"?7:0,o))}else return O.err(new V(H.Castling))}return Be.some(i=>w.backrank(i).intersect(n).size()>2)?O.err(new V(H.Castling)):O.ok(n)},Mi=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=tt(e[1]),i=tt(e[2]);return!x(n)||n>3||!x(i)||i>3?O.err(new V(H.RemainingChecks)):O.ok(new Ri(3-n,3-i))}else if(e.length===2){const n=tt(e[0]),i=tt(e[1]);return!x(n)||n>3||!x(i)||i>3?O.err(new V(H.RemainingChecks)):O.ok(new Ri(n,i))}else return O.err(new V(H.RemainingChecks))},Qo=t=>{const e=t.split(/[\s_]+/),n=e.shift();let i,r=O.ok(void 0);if(n.endsWith("]")){const c=n.indexOf("[");if(c===-1)return O.err(new V(H.Fen));i=fn(n.slice(0,c)),r=xi(n.slice(c+1,-1))}else{const c=Wo(n,"/",7);c===-1?i=fn(n):(i=fn(n.slice(0,c)),r=xi(n.slice(c+1)))}let s;const o=e.shift();if(!x(o)||o==="w")s="white";else if(o==="b")s="black";else return O.err(new V(H.Turn));return i.chain(c=>{const l=e.shift(),a=x(l)?Ho(c,l):O.ok(w.empty()),u=e.shift();let h;if(x(u)&&u!=="-"&&(h=Bo(u),!x(h)))return O.err(new V(H.EpSquare));let f=e.shift(),m;x(f)&&f.includes("+")&&(m=Mi(f),f=e.shift());const p=x(f)?tt(f):0;if(!x(p))return O.err(new V(H.Halfmoves));const d=e.shift(),b=x(d)?tt(d):1;if(!x(b))return O.err(new V(H.Fullmoves));const _=e.shift();let k=O.ok(void 0);if(x(_)){if(x(m))return O.err(new V(H.RemainingChecks));k=Mi(_)}else x(m)&&(k=m);return e.length>0?O.err(new V(H.Fen)):r.chain(v=>a.chain(C=>k.map(y=>({board:c,pockets:v,turn:s,castlingRights:C,remainingChecks:y,epSquare:h,halfmoves:p,fullmoves:Math.max(1,b)}))))})},Go=t=>{let e=Wt(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},Vo=t=>{let e="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const s=r+i*8,o=t.get(s);o?(n>0&&(e+=n,n=0),e+=Go(o)):n++,r===7&&(n>0&&(e+=n,n=0),i!==0&&(e+="/"))}return e},Oi=t=>pe.map(e=>Wt(e).repeat(t[e])).join(""),Jo=t=>Oi(t.white).toUpperCase()+Oi(t.black),Yo=(t,e)=>{let n="";for(const i of Be){const r=w.backrank(i);let s=t.kingOf(i);x(s)&&!r.has(s)&&(s=void 0);const o=t.pieces(i,"rook").intersect(r);for(const c of e.intersect(r).reversed())if(c===o.first()&&x(s)&&c<s)n+=i==="white"?"Q":"q";else if(c===o.last()&&x(s)&&s<c)n+=i==="white"?"K":"k";else{const l=Ut[le(c)];n+=i==="white"?l.toUpperCase():l}}return n||"-"},Zo=t=>`${t.white}+${t.black}`,Xo=(t,e)=>[Vo(t.board)+(t.pockets?`[${Jo(t.pockets)}]`:""),t.turn[0],Yo(t.board,t.castlingRights),x(t.epSquare)?xr(t.epSquare):"-",...t.remainingChecks?[Zo(t.remainingChecks)]:[],Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))].join(" ");var ec=ue('<div class="is2d chessboard">');const tc=t=>{let e,n;return Zr(()=>{let i=t.color,r=t.dests,s={premovable:{enabled:!1},movable:{color:i,free:!1,dests:r,events:{after:t.onMoveAfter}},drawable:{onChange:t.onShapes}};n=To(e,s)}),_e(()=>{let i,r;t.fen_uci?[i,r]=t.fen_uci:i=Uo;let s=[];r&&(s.push(r.slice(0,2)),s.push(r.slice(2,4)));let o=t.movable?t.color:void 0;n.set({fen:i,lastMove:s,turnColor:t.color,movable:{color:o,dests:t.dests}})}),_e(()=>{let i=t.orientation??"white";n.set({orientation:i})}),_e(()=>{let i=t.doPromotion;if(i){let r=n.state.pieces.get(i);n.setPieces(new Map([[i,{color:r.color,role:"queen",promoted:!0}]]))}}),_e(()=>{t.shapes&&n.setAutoShapes(t.shapes)}),(()=>{var i=ec();return Ji(r=>e=r,i),i})()},nc=Symbol("store-raw"),ic=Symbol("store-node"),Ge=Symbol("store-has"),rc=Symbol("store-self");function wt(t){let e;return t!=null&&typeof t=="object"&&(t[Vr]||!(e=Object.getPrototypeOf(t))||e===Object.prototype||Array.isArray(t))}function Sn(t,e=new Set){let n,i,r,s;if(n=t!=null&&t[nc])return n;if(!wt(t)||e.has(t))return t;if(Array.isArray(t)){Object.isFrozen(t)?t=t.slice(0):e.add(t);for(let o=0,c=t.length;o<c;o++)r=t[o],(i=Sn(r,e))!==r&&(t[o]=i)}else{Object.isFrozen(t)?t=Object.assign({},t):e.add(t);const o=Object.keys(t),c=Object.getOwnPropertyDescriptors(t);for(let l=0,a=o.length;l<a;l++)s=o[l],!c[s].get&&(r=t[s],(i=Sn(r,e))!==r&&(t[s]=i))}return t}function sc(t,e){let n=t[e];return n||Object.defineProperty(t,e,{value:n=Object.create(null)}),n}function Ni(t,e,n){if(t[e])return t[e];const[i,r]=ie(n,{equals:!1,internal:!0});return i.$=r,t[e]=i}function Ae(t,e,n,i=!1){if(!i&&t[e]===n)return;const r=t[e],s=t.length;n===void 0?(delete t[e],t[Ge]&&t[Ge][e]&&r!==void 0&&t[Ge][e].$()):(t[e]=n,t[Ge]&&t[Ge][e]&&r===void 0&&t[Ge][e].$());let o=sc(t,ic),c;if((c=Ni(o,e,r))&&c.$(()=>n),Array.isArray(t)&&t.length!==s){for(let l=t.length;l<s;l++)(c=o[l])&&c.$();(c=Ni(o,"length",s))&&c.$(t.length)}(c=o[rc])&&c.$()}const En=Symbol("store-root");function et(t,e,n,i,r){const s=e[n];if(t===s)return;const o=Array.isArray(t);if(n!==En&&(!wt(t)||!wt(s)||o!==Array.isArray(s)||r&&t[r]!==s[r])){Ae(e,n,t);return}if(o){if(t.length&&s.length&&(!i||r&&t[0]&&t[0][r]!=null)){let a,u,h,f,m,p,d,b;for(h=0,f=Math.min(s.length,t.length);h<f&&(s[h]===t[h]||r&&s[h]&&t[h]&&s[h][r]===t[h][r]);h++)et(t[h],s,h,i,r);const _=new Array(t.length),k=new Map;for(f=s.length-1,m=t.length-1;f>=h&&m>=h&&(s[f]===t[m]||r&&s[h]&&t[h]&&s[f][r]===t[m][r]);f--,m--)_[m]=s[f];if(h>m||h>f){for(u=h;u<=m;u++)Ae(s,u,t[u]);for(;u<t.length;u++)Ae(s,u,_[u]),et(t[u],s,u,i,r);s.length>t.length&&Ae(s,"length",t.length);return}for(d=new Array(m+1),u=m;u>=h;u--)p=t[u],b=r&&p?p[r]:p,a=k.get(b),d[u]=a===void 0?-1:a,k.set(b,u);for(a=h;a<=f;a++)p=s[a],b=r&&p?p[r]:p,u=k.get(b),u!==void 0&&u!==-1&&(_[u]=s[a],u=d[u],k.set(b,u));for(u=h;u<t.length;u++)u in _?(Ae(s,u,_[u]),et(t[u],s,u,i,r)):Ae(s,u,t[u])}else for(let a=0,u=t.length;a<u;a++)et(t[a],s,a,i,r);s.length>t.length&&Ae(s,"length",t.length);return}const c=Object.keys(t);for(let a=0,u=c.length;a<u;a++)et(t[c[a]],s,c[a],i,r);const l=Object.keys(s);for(let a=0,u=l.length;a<u;a++)t[l[a]]===void 0&&Ae(s,l[a],void 0)}function oc(t,e={}){const{merge:n,key:i="id"}=e,r=Sn(t);return s=>{if(!wt(s)||!wt(r))return r;const o=et(r,{[En]:s},En,n,i);return o===void 0?s:o}}var cc=t=>(typeof t.clear=="function"||(t.clear=()=>{let e;for(;e=t.key(0);)t.removeItem(e)}),t),lc=["clear","getItem","getAll","setItem","removeItem","key","getLength"],ac=t=>(t.withOptions=e=>lc.reduce((n,i)=>(typeof t[i]=="function"&&(n[i]=(...r)=>(r[t[i].length-1]=e,t[i](...r))),n),{get length(){return t.length},withOptions:n=>t.withOptions(n)}),t),hc={domain:"Domain",expires:"Expires",path:"Path",secure:"Secure",httpOnly:"HttpOnly",maxAge:"Max-Age",sameSite:"SameSite"};function uc(t){if(!t)return"";const e=Object.entries(t).map(([n,i])=>{const r=hc[n];if(r)return i instanceof Date?`${r}=${i.toUTCString()}`:typeof i=="boolean"?i?`${r}`:void 0:`${r}=${i}`}).filter(n=>!!n);return e.length!=0?`; ${e.join("; ")}`:""}function fc(t,e){var i;const n=(i=t.match(`(^|;)\\s*${e}\\s*=\\s*([^;]+)`))==null?void 0:i.pop();return n!=null?decodeURIComponent(n):null}var ht=ac(cc({_read:()=>document.cookie,_write:(t,e,n)=>{document.cookie=`${t}=${e}${uc(n)}`},getItem:(t,e)=>fc(ht._read(e),t),setItem:(t,e,n)=>{ht._write(t,e.replace(/[\u00c0-\uffff\&;]/g,i=>encodeURIComponent(i)),n)},removeItem:(t,e)=>{ht._write(t,"deleted",{...e,expires:new Date(0)})},key:(t,e)=>{let n=null,i=0;return ht._read(e).replace(/(?:^|;)\s*(.+?)\s*=\s*[^;]+/g,(r,s)=>(!n&&s&&i++===t&&(n=s),"")),n},getLength:t=>{let e=0;return ht._read(t).replace(/(?:^|;)\s*.+?\s*=\s*[^;]+/g,n=>(e+=n?1:0,"")),e},get length(){return this.getLength()}}));function dc(t,e={}){var u;const n=e.storage||globalThis.localStorage,i=e.name||`storage-${as()}`;if(!n)return[t[0],t[1],null];const r=e.storageOptions,s=e.serialize||JSON.stringify.bind(JSON),o=e.deserialize||JSON.parse.bind(JSON),c=n.getItem(i,r),l=typeof t[0]=="function"?h=>{try{const f=o(h);t[1](()=>f)}catch{}}:h=>{try{const f=o(h);t[1](oc(f))}catch{}};let a=!0;if(c instanceof Promise?c.then(h=>a&&h&&l(h)):c&&l(c),typeof((u=e.sync)==null?void 0:u[0])=="function"){const h=typeof t[0]=="function"?t[0]:()=>t[0];e.sync[0](f=>{f.key!==i||(f.url||globalThis.location.href)!==globalThis.location.href||f.newValue===s(he(h))||l(f.newValue)})}return[t[0],typeof t[0]=="function"?h=>{var p;const f=t[1](h),m=h!=null?s(f):h;return(p=e.sync)==null||p[1](i,m),m!=null?n.setItem(i,m,r):n.removeItem(i,r),a=!1,f}:(...h)=>{var m;t[1](...h);const f=s(he(()=>t[0]));(m=e.sync)==null||m[1](i,f),n.setItem(i,f,r),a=!1},c]}const An=(t,e,n)=>dc(ie(t),{name:`.hopefox2000.v0.${e}`}),Ht=(t,e)=>{let n=w.empty();for(const i of e){const r=t+i;0<=r&&r<64&&Math.abs(le(t)-le(r))<=2&&(n=n.with(r))}return n},xe=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},pc=xe(t=>Ht(t,[-9,-8,-7,-1,1,7,8,9])),gc=xe(t=>Ht(t,[-17,-15,-10,-6,6,10,15,17])),mc={white:xe(t=>Ht(t,[7,9])),black:xe(t=>Ht(t,[-7,-9]))},kt=t=>pc[t],bt=t=>gc[t],ot=(t,e)=>mc[t][e],$n=xe(t=>w.fromFile(le(t)).without(t)),Pn=xe(t=>w.fromRank(je(t)).without(t)),Rn=xe(t=>{const e=new w(134480385,2151686160),n=8*(je(t)-le(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),xn=xe(t=>{const e=new w(270549120,16909320),n=8*(je(t)+le(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Mn=(t,e,n)=>{let i=n.intersect(e),r=i.bswap64();return i=i.minus64(t),r=r.minus64(t.bswap64()),i.xor(r.bswap64()).intersect(e)},wc=(t,e)=>Mn(w.fromSquare(t),$n[t],e),kc=(t,e)=>{const n=Pn[t];let i=e.intersect(n),r=i.rbit64();return i=i.minus64(w.fromSquare(t)),r=r.minus64(w.fromSquare(63-t)),i.xor(r.rbit64()).intersect(n)},ze=(t,e)=>{const n=w.fromSquare(t);return Mn(n,Rn[t],e).xor(Mn(n,xn[t],e))},qe=(t,e)=>wc(t,e).xor(kc(t,e)),Qt=(t,e)=>ze(t,e).xor(qe(t,e)),Ve=(t,e,n)=>{switch(t.role){case"pawn":return ot(t.color,e);case"knight":return bt(e);case"bishop":return ze(e,n);case"rook":return qe(e,n);case"queen":return Qt(e,n);case"king":return kt(e)}},On=(t,e)=>{const n=w.fromSquare(e);return Pn[t].intersects(n)?Pn[t].with(t):xn[t].intersects(n)?xn[t].with(t):Rn[t].intersects(n)?Rn[t].with(t):$n[t].intersects(n)?$n[t].with(t):w.empty()},rt=(t,e)=>On(t,e).intersect(w.full().shl64(t).xor(w.full().shl64(e))).withoutFirst();var Pe;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(Pe||(Pe={}));let Je=class extends Error{};const bc=(t,e,n,i)=>n[e].intersect(qe(t,i).intersect(n.rooksAndQueens()).union(ze(t,i).intersect(n.bishopsAndQueens())).union(bt(t).intersect(n.knight)).union(kt(t).intersect(n.king)).union(ot(q(e),t).intersect(n.pawn)));let Ti=class ut{constructor(){S(this,"castlingRights");S(this,"rook");S(this,"path")}static default(){const e=new ut;return e.castlingRights=w.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new w(14,0),h:new w(96,0)},black:{a:new w(0,234881024),h:new w(0,1610612736)}},e}static empty(){const e=new ut;return e.castlingRights=w.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:w.empty(),h:w.empty()},black:{a:w.empty(),h:w.empty()}},e}clone(){const e=new ut;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,i,r){const s=oi(e,n),o=ci(e,n);this.castlingRights=this.castlingRights.with(r),this.rook[e][n]=r,this.path[e][n]=rt(r,o).with(o).union(rt(i,s).with(s)).without(i).without(r)}static fromSetup(e){const n=ut.empty(),i=e.castlingRights.intersect(e.board.rook);for(const r of Be){const s=w.backrank(r),o=e.board.kingOf(r);if(!x(o)||!s.has(o))continue;const c=i.intersect(e.board[r]).intersect(s),l=c.first();x(l)&&l<o&&n.add(r,"a",o,l);const a=c.last();x(a)&&o<a&&n.add(r,"h",o,a)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of Be)for(const i of zo)this.rook[n][i]===e&&(this.rook[n][i]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(w.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}},yc=class{constructor(e){S(this,"rules");S(this,"board");S(this,"pockets");S(this,"turn");S(this,"castles");S(this,"epSquare");S(this,"remainingChecks");S(this,"halfmoves");S(this,"fullmoves");this.rules=e}reset(){this.board=Rr.default(),this.pockets=void 0,this.turn="white",this.castles=Ti.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=w.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Ti.fromSetup(e),this.epSquare=_c(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,i){return bc(e,n,this.board,i)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[q(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!x(n))return{king:n,blockers:w.empty(),checkers:w.empty(),variantEnd:e,mustCapture:!1};const i=qe(n,w.empty()).intersect(this.board.rooksAndQueens()).union(ze(n,w.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[q(this.turn)]);let r=w.empty();for(const o of i){const c=rt(n,o).intersect(this.board.occupied);c.moreThanOne()||(r=r.union(c))}const s=this.kingAttackers(n,q(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var n,i;const e=new this.constructor;return e.board=this.board.clone(),e.pockets=(n=this.pockets)==null?void 0:n.clone(),e.turn=this.turn,e.castles=this.castles.clone(),e.epSquare=this.epSquare,e.remainingChecks=(i=this.remainingChecks)==null?void 0:i.clone(),e.halfmoves=this.halfmoves,e.fullmoves=this.fullmoves,e}validate(){if(this.board.occupied.isEmpty())return O.err(new Je(Pe.Empty));if(this.board.king.size()!==2)return O.err(new Je(Pe.Kings));if(!x(this.board.kingOf(this.turn)))return O.err(new Je(Pe.Kings));const e=this.board.kingOf(q(this.turn));return x(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?O.err(new Je(Pe.OppositeCheck)):w.backranks().intersects(this.board.pawn)?O.err(new Je(Pe.PawnsOnBackrank)):O.ok(void 0):O.err(new Je(Pe.Kings))}dropDests(e){return w.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return w.empty();const i=this.board.get(e);if(!i||i.color!==this.turn)return w.empty();let r,s;if(i.role==="pawn"){r=ot(this.turn,e).intersect(this.board[q(this.turn)]);const o=this.turn==="white"?8:-8,c=e+o;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const l=this.turn==="white"?e<16:e>=48,a=c+o;l&&!this.board.occupied.has(a)&&(r=r.with(a))}x(this.epSquare)&&Ki(this,e,n)&&(s=w.fromSquare(this.epSquare))}else i.role==="bishop"?r=ze(e,this.board.occupied):i.role==="knight"?r=bt(e):i.role==="rook"?r=qe(e,this.board.occupied):i.role==="queen"?r=Qt(e,this.board.occupied):r=kt(e);if(r=r.diff(this.board[this.turn]),x(n.king)){if(i.role==="king"){const o=this.board.occupied.without(e);for(const c of r)this.kingAttackers(c,q(this.turn),o).nonEmpty()&&(r=r.without(c));return r.union(Rt(this,"a",n)).union(Rt(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!x(o))return w.empty();r=r.intersect(rt(o,n.king).with(o))}n.blockers.has(e)&&(r=r.intersect(On(e,n.king)))}return s&&(r=r.union(s)),r}pseudo_dests(e,n){if(n=n||this.ctx(),n.variantEnd)return w.empty();const i=this.board.get(e);if(!i||i.color!==this.turn)return w.empty();let r,s;if(i.role==="pawn"){r=ot(this.turn,e);const o=this.turn==="white"?8:-8,c=e+o;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const l=this.turn==="white"?e<16:e>=48,a=c+o;l&&!this.board.occupied.has(a)&&(r=r.with(a))}x(this.epSquare)&&Ki(this,e,n)&&(s=w.fromSquare(this.epSquare))}else i.role==="bishop"?r=ze(e,this.board.occupied):i.role==="knight"?r=bt(e):i.role==="rook"?r=qe(e,this.board.occupied):i.role==="queen"?r=Qt(e,this.board.occupied):r=kt(e);if(x(n.king)){if(i.role==="king"){this.board.occupied.without(e);for(const o of r);return r.union(Rt(this,"a",n)).union(Rt(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!x(o))return w.empty();r=r.intersect(rt(o,n.king).with(o))}n.blockers.has(e)&&(r=r.intersect(On(e,n.king)))}return s&&(r=r.union(s)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[q(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(w.darkSquares())||!this.board.bishop.intersects(w.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)==null?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Cc(this),remainingChecks:(n=this.remainingChecks)==null?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Be.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&w.backranks().has(e.to)))return!1;const i=this.dests(e.from,n);return i.has(e.to)||i.has(Sc(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return x(e)&&this.kingAttackers(e,q(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:q(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,e));return n}play(e){const n=this.turn,i=this.epSquare,r=Or(this,e);this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=q(n);{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===i&&(o=this.board.take(e.to+(n==="white"?-8:8)));const c=e.from-e.to;Math.abs(c)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(r){const c=this.castles.rook[n][r];if(x(c)){const l=this.board.take(c);this.board.set(oi(n,r),s),l&&this.board.set(ci(n,r),l)}}this.castles.discardColor(n)}if(!r){const c=this.board.set(e.to,s)||o;c&&this.playCaptureAt(e.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}},vc=class extends yc{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}};const _c=(t,e)=>{if(!x(e))return;const n=t.turn==="white"?5:2,i=t.turn==="white"?8:-8;if(je(e)!==n||t.board.occupied.has(e+i))return;const r=e-i;if(!(!t.board.pawn.has(r)||!t.board[q(t.turn)].has(r)))return e},Cc=t=>{if(!x(t.epSquare))return;const e=t.ctx(),i=t.board.pieces(t.turn,"pawn").intersect(ot(q(t.turn),t.epSquare));for(const r of i)if(t.dests(r,e).has(t.epSquare))return t.epSquare},Ki=(t,e,n)=>{if(!x(t.epSquare)||!ot(t.turn,e).has(t.epSquare))return!1;if(!x(n.king))return!0;const i=t.turn==="white"?8:-8,r=t.epSquare-i;return t.kingAttackers(n.king,q(t.turn),t.board.occupied.toggle(e).toggle(r).with(t.epSquare)).without(r).isEmpty()},Rt=(t,e,n)=>{if(!x(n.king)||n.checkers.nonEmpty())return w.empty();const i=t.castles.rook[t.turn][e];if(!x(i)||t.castles.path[t.turn][e].intersects(t.board.occupied))return w.empty();const r=oi(t.turn,e),s=rt(n.king,r),o=t.board.occupied.without(n.king);for(const a of s)if(t.kingAttackers(a,q(t.turn),o).nonEmpty())return w.empty();const c=ci(t.turn,e),l=t.board.occupied.toggle(n.king).toggle(i).toggle(c);return t.kingAttackers(r,q(t.turn),l).nonEmpty()?w.empty():w.fromSquare(i)},Or=(t,e)=>{const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},Sc=(t,e)=>{const n=Or(t,e);if(!n)return e;const i=t.castles.rook[t.turn][n];return{from:e.from,to:x(i)?i:e.to}},Ec=(t,e)=>{let n="";{const i=t.board.getRole(e.from);if(!i)return"--";if(i==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))n=e.to>e.from?"O-O":"O-O-O";else{const r=t.board.occupied.has(e.to)||i==="pawn"&&le(e.from)!==le(e.to);if(i!=="pawn"){n=Wt(i).toUpperCase();let s;if(i==="king"?s=kt(e.to).intersect(t.board.king):i==="queen"?s=Qt(e.to,t.board.occupied).intersect(t.board.queen):i==="rook"?s=qe(e.to,t.board.occupied).intersect(t.board.rook):i==="bishop"?s=ze(e.to,t.board.occupied).intersect(t.board.bishop):s=bt(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const c of s)t.dests(c,o).has(e.to)||(s=s.without(c));if(s.nonEmpty()){let c=!1,l=s.intersects(w.fromRank(je(e.from)));s.intersects(w.fromFile(le(e.from)))?c=!0:l=!0,l&&(n+=Ut[le(e.from)]),c&&(n+=Pr[je(e.from)])}}}else r&&(n=Ut[le(e.from)]);r&&(n+="x"),n+=xr(e.to),e.promotion&&(n+="="+Wt(e.promotion).toUpperCase())}}return n},Ac=(t,e)=>{var i;const n=Ec(t,e);return t.play(e),(i=t.outcome())!=null&&i.winner?n+"#":t.isCheck()?n+"+":n},yt=(t,e)=>Ac(t.clone(),e),it=class it{constructor(e){S(this,"pos");S(this,"_d_cache");this.pos=e}get fen(){return Xo(this.pos.toSetup())}get h_captures(){return this.captures.map(e=>this.apply_move(e))}get h2_dests(){return this.h_dests.flatMap(([e,n,i])=>n.dests.map(r=>[n,n.apply_move(r),r]))}get h_and_h2_dests(){return this.h_dests.map(([e,n,i])=>[[e,n,i],n.dests.map(r=>[n,n.apply_move(r),r])])}get h_dests(){return this.dests.map(e=>[this,this.apply_move(e),e])}get dests(){var i;if(this._d_cache)return this._d_cache;let e=[],n=this.pos.board[this.pos.turn];for(let r of n)for(let s of this.pos.dests(r)){if((s<8||s>=56)&&((i=this.pos.board.get(r))==null?void 0:i.role)==="pawn"){e.push({from:r,to:s,promotion:"queen"}),e.push({from:r,to:s,promotion:"knight"});continue}let o={from:r,to:s};e.push(o)}return this._d_cache=e,e}dests_from(e){var i;let n=[];for(let r of this.pos.dests(e)){if((r<8||r>=56)&&((i=this.pos.board.get(e))==null?void 0:i.role)==="pawn"){n.push({from:e,to:r,promotion:"queen"}),n.push({from:e,to:r,promotion:"knight"});continue}let s={from:e,to:r};n.push(s)}return n}get turn(){return this.pos.turn}get captures(){return this.dests.filter(e=>!!this.pos.board.get(e.to))}get skip_turn(){let e=this.pos.clone();return e.turn=q(e.turn),new it(e)}apply_move(e){let n=this.pos.clone();return n.play(e),new it(n)}piece(e){return this.pos.board.get(e)}color(e){var n;return(n=this.pos.board.get(e))==null?void 0:n.color}role(e){var n;return(n=this.pos.board.get(e))==null?void 0:n.role}get is_checkmate(){return this.pos.isCheckmate()}get is_check(){return this.pos.isCheck()}get is_stalemate(){return this.pos.isStalemate()}};S(it,"from_fen",e=>new it(vc.fromSetup(Qo(e).unwrap()).unwrap()));let Nn=it;const $c=t=>t.reduce((e,n)=>e.flatMap(i=>n.map(r=>[...i,r])),[[]]);function Pc(t,e){function n(s,o){if(s.length===1&&o.length===1)return s[0]!==o[0]?void 0:s;if(s.length===2&&o.length===1)return s[s.length-1]!==o[0]?void 0:s;if(s.length===2&&o.length===2)return s[s.length-1]!==o[o.length-2]?void 0:[s[0],s[1],o[1]];if(s.length>2&&o.length===2)return s[s.length-1]!==o[o.length-2]?void 0:[...s,o[1]];if(s.length>2&&o.length===1)return s[s.length-1]!==o[0]?void 0:s;throw`Append Invalid ${s.length} | ${o.length}`}let i={};for(let s of Object.keys(t))if(e[s]!==void 0){let o=n(t[s],e[s]);if(!o)return;i[s]=o}else i[s]=t[s];for(let s of Object.keys(e))t[s]===void 0&&(i[s]=e[s]);let r=/([pqrnbkPQRNBKmjuarMJUAR]'?)/;for(let s of Object.keys(i))for(let o of Object.keys(i))s!==o&&s.match(r)&&o.match(r)&&(i[s][i[s].length-1],i[o][i[o].length-1]);return i}function F(t){let n=$c(t).map(r=>r.reduce((s,o)=>s?Pc(s,o):void 0,{})).filter(Boolean);const i=Array.from(new Set(n.map(r=>JSON.stringify(r)))).map(r=>JSON.parse(r));return i.sort((r,s)=>Object.keys(r).length-Object.keys(s).length),i}function de(t){switch(t[0]){case"Q":case"q":return["queen"];case"R":case"r":return["rook"];case"B":case"b":return["bishop"];case"N":case"n":return["knight"];case"K":case"k":return["king"];case"P":case"p":return["pawn"];case"M":case"m":return["knight","bishop"];case"J":case"j":return["rook","queen"];case"U":case"u":return["knight","bishop","rook","queen"];case"R":case"r":return["king","queen","rook","bishop","knight"];case"A":case"a":return["pawn","king","queen","rook","bishop","knight"];default:return[]}}function me(t){return t.toLowerCase()===t}function Rc(t){let e=t.trim().split(`
`),n={depth:-1,rule:".",children:[],m:[],n:[]};const i=[n];for(let r=0;r<e.length;r++){let s=e[r];const o=s.trim();if(!o)continue;const c=s.search(/\S/);let l={depth:c,rule:o,children:[],m:[],n:[]};for(;i.length>c+1;)i.pop();i[i.length-1].children.push(l),i.push(l)}return n}function Nr(t){let e="",n=" ".repeat(t.depth+1),i=t.m.slice(0,2).map(s=>{let o="",c=s.h_to_ha.slice(0,3).reduce(([l,a],u)=>[l.apply_move(u),a+" "+yt(l.pos,u)],[s.h,""])[1].trim();return o+=c,s.h_to_ha.length>3&&(o+=" .."+(s.h_to_ha.length-3)),o}).join(", ");return t.m.length>3&&(i+=".."+(t.m.length-3)),e+=" "+t.rule+" <"+(i??"?")+">"+""+`
`,t.children.map((s,o)=>{o===t.children.length-1?e+=n+"":o===0?e+=n+"":e+=n+" ",e+=Nr(s)}).join(""),e}function xc(t,e){let n=Tr(t,e),i=n.children[n.children.length-1].m[0];if(!i)return;let r,s=i.h;for(let o of i.h_to_ha)r=yt(s.pos,o),s.apply_move(o);return r}function Tr(t,e){let n=Nn.from_fen(t),i=Rc(e);if(i.children.length===0)return i;let r=n.h_dests;for(let s of i.children){let o=tn(r,s.rule,{},n.turn);if(!o||o.length===0)return i}return li(r,i.children[i.children.length-1],{},n.turn),i}function Mc(t,e,n,i){let r=[],s=[];for(let[o,c,l]of t){yt(o.pos,l);let a={...n};for(let f of Object.keys(n))a[f][a[f].length-1]===l.from&&(a[f]=[...a[f],l.to]);let u=tn(c.h_dests,e.rule.slice(1),a,i);if(u===void 0||u.length===0){s.push([o,c,l]);continue}let h=!0;for(let f of u){let m=f.c;yt(c.pos,f.da);let p=c.apply_move(f.da),d=p.h_dests;if(e.children.length>0){for(let b of e.children)if(d=li(d,b,m,i),d.length===0)break}if(e.children.length===0||d.length===0){r.push({c:m,h:o,ha:p,h_to_ha:[l,f.da]}),h=!1;continue}}h&&s.push([o,c,l])}return e.m.push(...r),s}function Oc(t,e,n,i){let r=[];e:for(let[s,o,c]of t){let l=e.rule[1],a=de(l),u=me(l)?i:q(i);for(let h of a.map(f=>o.pos.board[f].intersect(o.pos.board[u])))for(let f of h)if(n[l][n[l].length-1]===f)continue e;r.push([s,o,c])}return r}function Nc(t,e,n,i){let r=tn(t,e.rule.slice(1),n,i);return r&&r.length>0?t:[]}function li(t,e,n,i){let r=e.rule;if(r[0]==="=")return Oc(t,e,n,i);if(r[0]==="^")return Nc(t,e,n,i);if(r[0]==="*")return Mc(t,e,n,i);let s=tn(t,e.rule,n,i);if(s===void 0)return t;let o=t[0][0];if(e.children.length===0)return s.forEach(c=>{e.m.push({c:c.c,h:o,ha:o.apply_move(c.da),h_to_ha:[c.da]})}),t.filter(([c,l,a])=>!s.find(u=>u.da.from===a.from&&u.da.to===a.to));for(let c of s){let l=o.apply_move(c.da),a=l.h_dests;yt(o.pos,c.da);for(let u of e.children)if(a=li(a,u,c.c,o.turn),a.length===0)break;a.length===0&&e.m.push({c:c.c,h:o,ha:l,h_to_ha:[c.da]})}return t}function tn(t,e,n,i){if(e==="."){let m=[];return t.forEach(p=>{m.push({c:n,da:p[2]})}),m}let r=t[0][0],s=e.match(/^([pqrnbkPQRNBKmjuarMJUAR]'?) =([pqrnbkPQRNBKmjuarMJUAR]'?)/),o=e.match(/^([pqrnbkPQRNBKmjuarMJUAR]'?) =([a-h][1-8])/),c=e.match(/\+([pqrnbkPQRNBKmjuarMJUAR]'?) \+([pqrnbkPQRNBKmjuarMJUAR]'?)/),l=e.match(/\+([pqrnbkPQRNBKmjuarMJUAR]'?)$/),a=e.match(/^([pqrnbkPQRNBKmjuarMJUAR]'?)=$/);if(e.includes("#")){let m=t.filter(([p,d,b])=>d.is_checkmate);return m.length===0?void 0:m.map(p=>({c:n,da:p[2]}))}let h=[],f=[n];if(o){let[m,p,d]=o,b=de(p),_=me(p)?i:q(i),k=[];for(let v of b.map(C=>r.pos.board[C].intersect(r.pos.board[_])))for(let C of v){let y=r.pos.board.get(C);for(let E of Ve(y,C,r.pos.board.occupied)){if(r.pos.board.get(E),c){let[P,A,I]=c,K=de(A),D=de(I),z=me(A)?i:q(i),W=me(I)?i:q(i),$=[];for(let fe of Ve(y,E,r.pos.board.occupied.without(C).with(E))){let R=r.pos.board.get(fe);if(!R||z!==R.color||W!==R.color)continue;let be,ye;K.includes(R.role)&&(be=!0),D.includes(R.role)&&(ye=!0),be&&ye?$.push([fe,fe]):be?$.push([fe,void 0]):ye&&$.push([void 0,fe])}$.length===3&&($[0][0]!==void 0&&$[1][1]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[0][0]],[I]:[$[1][1]]}]])),$[0][1]!==void 0&&$[1][0]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[1][0]],[I]:[$[0][1]]}]])),$[0][0]!==void 0&&$[2][1]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[0][0]],[I]:[$[2][1]]}]])),$[0][1]!==void 0&&$[2][0]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[1][0]],[I]:[$[0][1]]}]])),$[1][0]!==void 0&&$[2][1]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[1][0]],[I]:[$[2][1]]}]])),$[1][1]!==void 0&&$[2][0]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[1][0]],[I]:[$[0][1]]}]]))),$.length===2&&($[0][0]!==void 0&&$[1][1]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[0][0]],[I]:[$[1][1]]}]])),$[0][1]!==void 0&&$[1][0]!==void 0&&k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[$[1][0]],[I]:[$[0][1]]}]])));continue}else if(l){let[P,A]=l,I=de(A),K=me(A)?i:q(i),D=[];for(let z of Ve(y,E,r.pos.board.occupied.without(C).with(E))){let W=r.pos.board.get(z);W&&K===W.color&&I.includes(W.role)&&D.push(z)}for(let z of D)k.push(...F([f,[{[p]:[C,E],[d]:[E],[A]:[z]}]]));continue}k.push(...F([f,[{[p]:[C,E],[d]:[E]}]]))}}if(k.length===0)return;for(let v of k){let C=t.filter(([y,E,P])=>v[p][v[p].length-2]===P.from&&v[d][v[d].length-1]===P.to);C.length!==0&&h.push(...C.map(y=>({c:v,da:y[2]})))}}else if(s){let[m,p,d]=s,b=de(p),_=de(d),k=me(p)?i:q(i),v=[];for(let C of b.map(y=>r.pos.board[y].intersect(r.pos.board[k])))for(let y of C){let E=r.pos.board.get(y);for(let P of Ve(E,y,r.pos.board.occupied)){let A=r.pos.board.get(P);if(A&&_.includes(A.role)){if(c){let[I,K,D]=c,z=de(K),W=de(D),$=me(K)?i:q(i),fe=me(D)?i:q(i),R=[];for(let be of Ve(E,P,r.pos.board.occupied.without(y).with(P))){let ye=r.pos.board.get(be);if(!ye||$!==ye.color||fe!==ye.color)continue;let sn,on;z.includes(ye.role)&&(sn=!0),W.includes(ye.role)&&(on=!0),sn&&on?R.push([be,be]):sn?R.push([be,void 0]):on&&R.push([void 0,be])}R.length===3&&(R[0][0]!==void 0&&R[1][1]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[0][0]],[D]:[R[1][1]]}]])),R[0][1]!==void 0&&R[1][0]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[1][0]],[D]:[R[0][1]]}]])),R[0][0]!==void 0&&R[2][1]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[0][0]],[D]:[R[2][1]]}]])),R[0][1]!==void 0&&R[2][0]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[1][0]],[D]:[R[0][1]]}]])),R[1][0]!==void 0&&R[2][1]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[1][0]],[D]:[R[2][1]]}]])),R[1][1]!==void 0&&R[2][0]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[1][0]],[D]:[R[0][1]]}]]))),R.length===2&&(R[0][0]!==void 0&&R[1][1]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[0][0]],[D]:[R[1][1]]}]])),R[0][1]!==void 0&&R[1][0]!==void 0&&v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[R[1][0]],[D]:[R[0][1]]}]])));continue}else if(l){let[I,K]=l,D=de(K),z=me(K)?i:q(i),W=[];for(let $ of Ve(E,P,r.pos.board.occupied.without(y).with(P))){let fe=r.pos.board.get($);fe&&z===fe.color&&D.includes(fe.role)&&W.push($)}for(let $ of W)v.push(...F([f,[{[p]:[y,P],[d]:[P],[K]:[$]}]]));continue}v.push(...F([f,[{[p]:[y,P],[d]:[P]}]]))}}}if(v.length===0)return;for(let C of v){let y=t.filter(([E,P,A])=>C[p][C[p].length-2]===A.from&&C[d][C[d].length-1]===A.to);y.length!==0&&h.push(...y.map(E=>({c:C,da:E[2]})))}}if(a){let[m,p]=a,d=de(p),b=me(p)?i:q(i),_=[];for(let k of d.map(v=>r.pos.board[v].intersect(r.pos.board[b])))for(let v of k)r.pos.board.get(v),_.push(...F([f,[{[p]:[v]}]]))}return h}const Kr=t=>{let e=Object.keys(t.has_tags).length,n={...t.has_tags};return e>0&&(n.has_tag=!0,e===1?n.single_tag=!0:n.many_tags=!0),n[`id_${t.id}`]=!0,n},Tc=t=>{let e={...t.tags,...Kr(t)};return t.rules&&[...new Set(t.rules.flatMap(Kc))].forEach(i=>e[i]=!0),e},Kc=t=>t.solve===void 0?["solved",`solved_${t.rule.name}`]:t.solve>=0?["failed",`failed_${t.rule.name}`]:[""];class Dr{unwrap(e,n){const i=this._chain(r=>N.ok(e?e(r):r),r=>n?N.ok(n(r)):N.err(r));if(i.isErr)throw i.error;return i.value}map(e,n){return this._chain(i=>N.ok(e(i)),i=>N.err(n?n(i):i))}chain(e,n){return this._chain(e,n||(i=>N.err(i)))}}class Dc extends Dr{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}}class Ic extends Dr{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}}var N;(function(t){t.ok=function(e){return new Dc(e)},t.err=function(e){return new Ic(e||new Error)},t.all=function(e){if(Array.isArray(e)){const r=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;r.push(o.value)}return t.ok(r)}const n={},i=Object.keys(e);for(let r=0;r<i.length;r++){const s=e[i[r]];if(s.isErr)return s;n[i[r]]=s.value}return t.ok(n)}})(N||(N={}));const Di=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),Tn=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Ii=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,Tn(t));class g{constructor(e,n){this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new g(0,1<<e-32):new g(1<<e,0)}static fromRank(e){return new g(255,0).shl64(8*e)}static fromFile(e){return new g(16843009<<e,16843009<<e)}static empty(){return new g(0,0)}static full(){return new g(4294967295,4294967295)}static corners(){return new g(129,2164260864)}static center(){return new g(402653184,24)}static backranks(){return new g(255,4278190080)}static backrank(e){return e==="white"?new g(255,0):new g(0,4278190080)}static lightSquares(){return new g(1437226410,1437226410)}static darkSquares(){return new g(2857740885,2857740885)}complement(){return new g(~this.lo,~this.hi)}xor(e){return new g(this.lo^e.lo,this.hi^e.hi)}union(e){return new g(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new g(this.lo&e.lo,this.hi&e.hi)}diff(e){return new g(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?g.empty():e>=32?new g(this.hi>>>e-32,0):e>0?new g(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?g.empty():e>=32?new g(0,this.lo<<e-32):e>0?new g(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new g(Tn(this.hi),Tn(this.lo))}rbit64(){return new g(Ii(this.hi),Ii(this.lo))}minus64(e){const n=this.lo-e.lo,i=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new g(n,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return Di(this.lo)+Di(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new g(this.lo,this.hi|1<<e-32):new g(this.lo|1<<e,this.hi)}without(e){return e>=32?new g(this.lo,this.hi&~(1<<e-32)):new g(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new g(this.lo,this.hi^1<<e-32):new g(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new g(this.lo&this.lo-1,this.hi):new g(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const i=31-Math.clz32(e&-e);e^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;e!==0;){const i=31-Math.clz32(e);e^=1<<i,yield i}}}const Gt=["a","b","c","d","e","f","g","h"],Ir=["1","2","3","4","5","6","7","8"],Fe=["white","black"],ge=["pawn","knight","bishop","rook","queen","king"],zc=["a","h"],Vt=t=>"role"in t;class st{constructor(){}static default(){const e=new st;return e.reset(),e}reset(){this.occupied=new g(65535,4294901760),this.promoted=g.empty(),this.white=new g(65535,0),this.black=new g(0,4294901760),this.pawn=new g(65280,16711680),this.knight=new g(66,1107296256),this.bishop=new g(36,603979776),this.rook=new g(129,2164260864),this.queen=new g(8,134217728),this.king=new g(16,268435456)}static empty(){const e=new st;return e.clear(),e}clear(){this.occupied=g.empty(),this.promoted=g.empty();for(const e of Fe)this[e]=g.empty();for(const e of ge)this[e]=g.empty()}clone(){const e=new st;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of Fe)e[n]=this[n];for(const n of ge)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of ge)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const i=this.getRole(e),r=this.promoted.has(e);return{color:n,role:i,promoted:r}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const i=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),i}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class ke{constructor(){}static empty(){const e=new ke;for(const n of ge)e[n]=0;return e}static fromBoard(e,n){const i=new ke;for(const r of ge)i[r]=e.pieces(n,r).size();return i}clone(){const e=new ke;for(const n of ge)e[n]=this[n];return e}equals(e){return ge.every(n=>this[n]===e[n])}add(e){const n=new ke;for(const i of ge)n[i]=this[i]+e[i];return n}subtract(e){const n=new ke;for(const i of ge)n[i]=this[i]-e[i];return n}nonEmpty(){return ge.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class De{constructor(e,n){this.white=e,this.black=n}static empty(){return new De(ke.empty(),ke.empty())}static fromBoard(e){return new De(ke.fromBoard(e,"white"),ke.fromBoard(e,"black"))}clone(){return new De(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new De(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new De(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class vt{constructor(e,n){this.white=e,this.black=n}static default(){return new vt(3,3)}clone(){return new vt(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}const M=t=>t!==void 0,Z=t=>t==="white"?"black":"white",Ue=t=>t>>3,oe=t=>t&7,Kn=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,dt=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Dn(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function pt(t){if(t.length===2)return Kn(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const _t=t=>Gt[oe(t)]+Ir[Ue(t)],zr=t=>{if(t[1]==="@"&&t.length===4){const e=Dn(t[0]),n=pt(t.slice(2));if(e&&M(n))return{role:e,to:n}}else if(t.length===4||t.length===5){const e=pt(t.slice(0,2)),n=pt(t.slice(2,4));let i;if(t.length===5&&(i=Dn(t[4]),!i))return;if(M(e)&&M(n))return{from:e,to:n,promotion:i}}},ai=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,hi=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,qc="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Lc=qc+" w KQkq -",qr=Lc+" 0 1";var Q;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(Q||(Q={}));class J extends Error{}const Bc=(t,e,n)=>{let i=t.indexOf(e);for(;n-- >0&&i!==-1;)i=t.indexOf(e,i+e.length);return i},nt=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,Lr=t=>{const e=Dn(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},dn=t=>{const e=st.empty();let n=7,i=0;for(let r=0;r<t.length;r++){const s=t[r];if(s==="/"&&i===8)i=0,n--;else{const o=parseInt(s,10);if(o>0)i+=o;else{if(i>=8||n<0)return N.err(new J(Q.Board));const c=i+n*8,l=Lr(s);if(!l)return N.err(new J(Q.Board));t[r+1]==="~"&&(l.promoted=!0,r++),e.set(c,l),i++}}}return n!==0||i!==8?N.err(new J(Q.Board)):N.ok(e)},zi=t=>{if(t.length>64)return N.err(new J(Q.Pockets));const e=De.empty();for(const n of t){const i=Lr(n);if(!i)return N.err(new J(Q.Pockets));e[i.color][i.role]++}return N.ok(e)},jc=(t,e)=>{let n=g.empty();if(e==="-")return N.ok(n);for(const i of e){const r=i.toLowerCase(),s=i===r?"black":"white",o=s==="white"?0:7;if("a"<=r&&r<="h")n=n.with(Kn(r.charCodeAt(0)-97,o));else if(r==="k"||r==="q"){const c=t[s].intersect(g.backrank(s)).intersect(t.rook.union(t.king)),l=r==="k"?c.last():c.first();n=n.with(M(l)&&t.rook.has(l)?l:Kn(r==="k"?7:0,o))}else return N.err(new J(Q.Castling))}return Fe.some(i=>g.backrank(i).intersect(n).size()>2)?N.err(new J(Q.Castling)):N.ok(n)},qi=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=nt(e[1]),i=nt(e[2]);return!M(n)||n>3||!M(i)||i>3?N.err(new J(Q.RemainingChecks)):N.ok(new vt(3-n,3-i))}else if(e.length===2){const n=nt(e[0]),i=nt(e[1]);return!M(n)||n>3||!M(i)||i>3?N.err(new J(Q.RemainingChecks)):N.ok(new vt(n,i))}else return N.err(new J(Q.RemainingChecks))},In=t=>{const e=t.split(/[\s_]+/),n=e.shift();let i,r=N.ok(void 0);if(n.endsWith("]")){const c=n.indexOf("[");if(c===-1)return N.err(new J(Q.Fen));i=dn(n.slice(0,c)),r=zi(n.slice(c+1,-1))}else{const c=Bc(n,"/",7);c===-1?i=dn(n):(i=dn(n.slice(0,c)),r=zi(n.slice(c+1)))}let s;const o=e.shift();if(!M(o)||o==="w")s="white";else if(o==="b")s="black";else return N.err(new J(Q.Turn));return i.chain(c=>{const l=e.shift(),a=M(l)?jc(c,l):N.ok(g.empty()),u=e.shift();let h;if(M(u)&&u!=="-"&&(h=pt(u),!M(h)))return N.err(new J(Q.EpSquare));let f=e.shift(),m;M(f)&&f.includes("+")&&(m=qi(f),f=e.shift());const p=M(f)?nt(f):0;if(!M(p))return N.err(new J(Q.Halfmoves));const d=e.shift(),b=M(d)?nt(d):1;if(!M(b))return N.err(new J(Q.Fullmoves));const _=e.shift();let k=N.ok(void 0);if(M(_)){if(M(m))return N.err(new J(Q.RemainingChecks));k=qi(_)}else M(m)&&(k=m);return e.length>0?N.err(new J(Q.Fen)):r.chain(v=>a.chain(C=>k.map(y=>({board:c,pockets:v,turn:s,castlingRights:C,remainingChecks:y,epSquare:h,halfmoves:p,fullmoves:Math.max(1,b)}))))})},Fc=t=>{let e=dt(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},Uc=t=>{let e="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const s=r+i*8,o=t.get(s);o?(n>0&&(e+=n,n=0),e+=Fc(o)):n++,r===7&&(n>0&&(e+=n,n=0),i!==0&&(e+="/"))}return e},Li=t=>ge.map(e=>dt(e).repeat(t[e])).join(""),Wc=t=>Li(t.white).toUpperCase()+Li(t.black),Hc=(t,e)=>{let n="";for(const i of Fe){const r=g.backrank(i);let s=t.kingOf(i);M(s)&&!r.has(s)&&(s=void 0);const o=t.pieces(i,"rook").intersect(r);for(const c of e.intersect(r).reversed())if(c===o.first()&&M(s)&&c<s)n+=i==="white"?"Q":"q";else if(c===o.last()&&M(s)&&s<c)n+=i==="white"?"K":"k";else{const l=Gt[oe(c)];n+=i==="white"?l.toUpperCase():l}}return n||"-"},Qc=t=>`${t.white}+${t.black}`,Br=(t,e)=>[Uc(t.board)+(t.pockets?`[${Wc(t.pockets)}]`:""),t.turn[0],Hc(t.board,t.castlingRights),M(t.epSquare)?_t(t.epSquare):"-",...t.remainingChecks?[Qc(t.remainingChecks)]:[],Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))].join(" "),Jt=(t,e)=>{let n=g.empty();for(const i of e){const r=t+i;0<=r&&r<64&&Math.abs(oe(t)-oe(r))<=2&&(n=n.with(r))}return n},Me=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},Gc=Me(t=>Jt(t,[-9,-8,-7,-1,1,7,8,9])),Vc=Me(t=>Jt(t,[-17,-15,-10,-6,6,10,15,17])),Jc={white:Me(t=>Jt(t,[7,9])),black:Me(t=>Jt(t,[-7,-9]))},ui=t=>Gc[t],fi=t=>Vc[t],nn=(t,e)=>Jc[t][e],zn=Me(t=>g.fromFile(oe(t)).without(t)),qn=Me(t=>g.fromRank(Ue(t)).without(t)),Ln=Me(t=>{const e=new g(134480385,2151686160),n=8*(Ue(t)-oe(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Bn=Me(t=>{const e=new g(270549120,16909320),n=8*(Ue(t)+oe(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),jn=(t,e,n)=>{let i=n.intersect(e),r=i.bswap64();return i=i.minus64(t),r=r.minus64(t.bswap64()),i.xor(r.bswap64()).intersect(e)},Yc=(t,e)=>jn(g.fromSquare(t),zn[t],e),Zc=(t,e)=>{const n=qn[t];let i=e.intersect(n),r=i.rbit64();return i=i.minus64(g.fromSquare(t)),r=r.minus64(g.fromSquare(63-t)),i.xor(r.rbit64()).intersect(n)},Ct=(t,e)=>{const n=g.fromSquare(t);return jn(n,Ln[t],e).xor(jn(n,Bn[t],e))},St=(t,e)=>Yc(t,e).xor(Zc(t,e)),jr=(t,e)=>Ct(t,e).xor(St(t,e)),Fr=(t,e)=>{const n=g.fromSquare(e);return qn[t].intersects(n)?qn[t].with(t):Bn[t].intersects(n)?Bn[t].with(t):Ln[t].intersects(n)?Ln[t].with(t):zn[t].intersects(n)?zn[t].with(t):g.empty()},Et=(t,e)=>Fr(t,e).intersect(g.full().shl64(t).xor(g.full().shl64(e))).withoutFirst();var Re;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(Re||(Re={}));class Ye extends Error{}const Xc=(t,e,n,i)=>n[e].intersect(St(t,i).intersect(n.rooksAndQueens()).union(Ct(t,i).intersect(n.bishopsAndQueens())).union(fi(t).intersect(n.knight)).union(ui(t).intersect(n.king)).union(nn(Z(e),t).intersect(n.pawn)));class Ie{constructor(){}static default(){const e=new Ie;return e.castlingRights=g.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new g(14,0),h:new g(96,0)},black:{a:new g(0,234881024),h:new g(0,1610612736)}},e}static empty(){const e=new Ie;return e.castlingRights=g.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:g.empty(),h:g.empty()},black:{a:g.empty(),h:g.empty()}},e}clone(){const e=new Ie;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,i,r){const s=ai(e,n),o=hi(e,n);this.castlingRights=this.castlingRights.with(r),this.rook[e][n]=r,this.path[e][n]=Et(r,o).with(o).union(Et(i,s).with(s)).without(i).without(r)}static fromSetup(e){const n=Ie.empty(),i=e.castlingRights.intersect(e.board.rook);for(const r of Fe){const s=g.backrank(r),o=e.board.kingOf(r);if(!M(o)||!s.has(o))continue;const c=i.intersect(e.board[r]).intersect(s),l=c.first();M(l)&&l<o&&n.add(r,"a",o,l);const a=c.last();M(a)&&o<a&&n.add(r,"h",o,a)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of Fe)for(const i of zc)this.rook[n][i]===e&&(this.rook[n][i]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(g.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class el{constructor(e){this.rules=e}reset(){this.board=st.default(),this.pockets=void 0,this.turn="white",this.castles=Ie.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=g.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Ie.fromSetup(e),this.epSquare=tl(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,i){return Xc(e,n,this.board,i)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[Z(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!M(n))return{king:n,blockers:g.empty(),checkers:g.empty(),variantEnd:e,mustCapture:!1};const i=St(n,g.empty()).intersect(this.board.rooksAndQueens()).union(Ct(n,g.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[Z(this.turn)]);let r=g.empty();for(const o of i){const c=Et(n,o).intersect(this.board.occupied);c.moreThanOne()||(r=r.union(c))}const s=this.kingAttackers(n,Z(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var e,n;const i=new this.constructor;return i.board=this.board.clone(),i.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(){if(this.board.occupied.isEmpty())return N.err(new Ye(Re.Empty));if(this.board.king.size()!==2)return N.err(new Ye(Re.Kings));if(!M(this.board.kingOf(this.turn)))return N.err(new Ye(Re.Kings));const e=this.board.kingOf(Z(this.turn));return M(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?N.err(new Ye(Re.OppositeCheck)):g.backranks().intersects(this.board.pawn)?N.err(new Ye(Re.PawnsOnBackrank)):N.ok(void 0):N.err(new Ye(Re.Kings))}dropDests(e){return g.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return g.empty();const i=this.board.get(e);if(!i||i.color!==this.turn)return g.empty();let r,s;if(i.role==="pawn"){r=nn(this.turn,e).intersect(this.board[Z(this.turn)]);const o=this.turn==="white"?8:-8,c=e+o;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const l=this.turn==="white"?e<16:e>=48,a=c+o;l&&!this.board.occupied.has(a)&&(r=r.with(a))}M(this.epSquare)&&il(this,e,n)&&(s=g.fromSquare(this.epSquare))}else i.role==="bishop"?r=Ct(e,this.board.occupied):i.role==="knight"?r=fi(e):i.role==="rook"?r=St(e,this.board.occupied):i.role==="queen"?r=jr(e,this.board.occupied):r=ui(e);if(r=r.diff(this.board[this.turn]),M(n.king)){if(i.role==="king"){const o=this.board.occupied.without(e);for(const c of r)this.kingAttackers(c,Z(this.turn),o).nonEmpty()&&(r=r.without(c));return r.union(Bi(this,"a",n)).union(Bi(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!M(o))return g.empty();r=r.intersect(Et(o,n.king).with(o))}n.blockers.has(e)&&(r=r.intersect(Fr(e,n.king)))}return s&&(r=r.union(s)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[Z(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(g.darkSquares())||!this.board.bishop.intersects(g.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:nl(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Fe.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){if(Vt(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&g.backranks().has(e.to)?!1:this.dropDests(n).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&g.backranks().has(e.to)))return!1;const i=this.dests(e.from,n);return i.has(e.to)||i.has(rl(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return M(e)&&this.kingAttackers(e,Z(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:Z(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,e));return n}play(e){const n=this.turn,i=this.epSquare,r=Ur(this,e);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=Z(n),Vt(e))this.board.set(e.to,{role:e.role,color:n}),this.pockets&&this.pockets[n][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===i&&(o=this.board.take(e.to+(n==="white"?-8:8)));const c=e.from-e.to;Math.abs(c)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(r){const c=this.castles.rook[n][r];if(M(c)){const l=this.board.take(c);this.board.set(ai(n,r),s),l&&this.board.set(hi(n,r),l)}}this.castles.discardColor(n)}if(!r){const c=this.board.set(e.to,s)||o;c&&this.playCaptureAt(e.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class Fn extends el{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}}const tl=(t,e)=>{if(!M(e))return;const n=t.turn==="white"?5:2,i=t.turn==="white"?8:-8;if(Ue(e)!==n||t.board.occupied.has(e+i))return;const r=e-i;if(!(!t.board.pawn.has(r)||!t.board[Z(t.turn)].has(r)))return e},nl=t=>{if(!M(t.epSquare))return;const e=t.ctx(),i=t.board.pieces(t.turn,"pawn").intersect(nn(Z(t.turn),t.epSquare));for(const r of i)if(t.dests(r,e).has(t.epSquare))return t.epSquare},il=(t,e,n)=>{if(!M(t.epSquare)||!nn(t.turn,e).has(t.epSquare))return!1;if(!M(n.king))return!0;const i=t.turn==="white"?8:-8,r=t.epSquare-i;return t.kingAttackers(n.king,Z(t.turn),t.board.occupied.toggle(e).toggle(r).with(t.epSquare)).without(r).isEmpty()},Bi=(t,e,n)=>{if(!M(n.king)||n.checkers.nonEmpty())return g.empty();const i=t.castles.rook[t.turn][e];if(!M(i)||t.castles.path[t.turn][e].intersects(t.board.occupied))return g.empty();const r=ai(t.turn,e),s=Et(n.king,r),o=t.board.occupied.without(n.king);for(const a of s)if(t.kingAttackers(a,Z(t.turn),o).nonEmpty())return g.empty();const c=hi(t.turn,e),l=t.board.occupied.toggle(n.king).toggle(i).toggle(c);return t.kingAttackers(r,Z(t.turn),l).nonEmpty()?g.empty():g.fromSquare(i)},Ur=(t,e)=>{if(Vt(e))return;const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},rl=(t,e)=>{const n=Ur(t,e);if(!n)return e;const i=t.castles.rook[t.turn][n];return{from:e.from,to:M(i)?i:e.to}},sl=(t,e)=>{const n=new Map,i=t.ctx();for(const[r,s]of t.allDests(i))if(s.nonEmpty()){const o=Array.from(s,_t);r===i.king&&oe(r)===4&&(s.has(0)?o.push("c1"):s.has(56)&&o.push("c8"),s.has(7)?o.push("g1"):s.has(63)&&o.push("g8")),n.set(_t(r),o)}return n},ol=(t,e)=>{let n="";if(Vt(e))e.role!=="pawn"&&(n=dt(e.role).toUpperCase()),n+="@"+_t(e.to);else{const i=t.board.getRole(e.from);if(!i)return"--";if(i==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))n=e.to>e.from?"O-O":"O-O-O";else{const r=t.board.occupied.has(e.to)||i==="pawn"&&oe(e.from)!==oe(e.to);if(i!=="pawn"){n=dt(i).toUpperCase();let s;if(i==="king"?s=ui(e.to).intersect(t.board.king):i==="queen"?s=jr(e.to,t.board.occupied).intersect(t.board.queen):i==="rook"?s=St(e.to,t.board.occupied).intersect(t.board.rook):i==="bishop"?s=Ct(e.to,t.board.occupied).intersect(t.board.bishop):s=fi(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const c of s)t.dests(c,o).has(e.to)||(s=s.without(c));if(s.nonEmpty()){let c=!1,l=s.intersects(g.fromRank(Ue(e.from)));s.intersects(g.fromFile(oe(e.from)))?c=!0:l=!0,l&&(n+=Gt[oe(e.from)]),c&&(n+=Ir[Ue(e.from)])}}}else r&&(n=Gt[oe(e.from)]);r&&(n+="x"),n+=_t(e.to),e.promotion&&(n+="="+dt(e.promotion).toUpperCase())}}return n},cl=(t,e)=>{var n;const i=ol(t,e);return t.play(e),!((n=t.outcome())===null||n===void 0)&&n.winner?i+"#":t.isCheck()?i+"+":i},ll=(t,e)=>cl(t.clone(),e);function al(t,e){let n=In(t).unwrap(),i=Fn.fromSetup(n).unwrap(),r=zr(e);return i.play(r),Br(i.toSetup())}const Zt=class Zt{constructor(){S(this,"_add_uci");S(this,"_promotion");S(this,"_position");S(this,"m_fen");S(this,"m_dests");S(this,"m_color");S(this,"_last_move");S(this,"_on_wheel");S(this,"set_on_wheel",e=>{this._on_wheel[1](e)});S(this,"on_play_uci",e=>{let n=al(this.fen,e);this.on_set_fen_uci(n,e)});S(this,"on_set_fen_uci",(e,n)=>{Tt(()=>{this.add_uci=void 0,this.last_move=n,this.position=Fn.fromSetup(In(e).unwrap()).unwrap()})});S(this,"reset_move_after",()=>{this.position=this.position});S(this,"on_move_after",(e,n)=>{let i=this.position.board.get(pt(e)),r=e+n;i.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(r+="q");let s=zr(r),o=ll(this.position,s);this.position.play(s),Tt(()=>{this.last_move=r,this.position=this.position,r.length===5&&(this.promotion=n),this.add_uci=[r,o]})});this._on_wheel=ie(void 0,{equals:!1}),this._last_move=ie(void 0,{equals:!1}),this._add_uci=ie(void 0,{equals:!1}),this._promotion=ie(void 0,{equals:!1}),this._position=ie(Fn.fromSetup(In(qr).unwrap()).unwrap(),{equals:!1}),this.m_dests=ee(()=>sl(this.position)),this.m_fen=ee(()=>Br(this.position.toSetup())),this.m_color=ee(()=>this.position.turn)}get position(){return this._position[0]()}set position(e){this._position[1](e)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(e){this._promotion[1](e)}get add_uci(){return this._add_uci[0]()}set add_uci(e){this._add_uci[1](e)}get last_move(){return this._last_move[0]()}set last_move(e){this._last_move[1](e)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let e=this.fen,n=this.last_move;return[e,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};S(Zt,"init",()=>new Zt);let Un=Zt;function hl(t){let e=0;return n=>{e+=n.deltaY*(n.deltaMode?40:1),Math.abs(e)>=4?(t(n,!0),e=0):t(n,!1)}}function ul(t){return new Worker(""+new URL("worker2-l2HB2bgq.js",import.meta.url).href,{type:"module",name:t==null?void 0:t.name})}const rn=es(),fl=t=>{let e=new ul;const[n,i]=ie(),[r,s]=ie(),[o,c]=ie();e.onmessage=d=>{switch(d.data==="ready"&&(l=!0,h()),d.data.t){case"progress":i(d.data.d);break;case"puzzles":let{all:b,filtered:_}=d.data.d;Tt(()=>{c(b),s(_)});break}};let l=!1,a,u=[];function h(){l&&e.postMessage({t:"filter",d:{filter:a,rules:u}})}let p={get progress(){return n()},get puzzles(){return r()},get all(){return o()},filter:d=>{a=d,h()},rules:d=>{u=d,h()}};return X(rn.Provider,{value:p,get children(){return[" ",ee(()=>t.children)," "]}})};function dl(t,e,n=!1){let i,r=0;return function(...s){const o=this;i&&clearTimeout(i),i=void 0;const c=performance.now()-r;r=performance.now(),n&&c>e?t.apply(o,s):i=setTimeout(()=>{i=void 0,t.apply(o,s)},e)}}var pl=ue("<div class=header>"),gl=ue("<div class=app-wrap><div class=board-wrap><div class=board></div><div class=tree></div></div><div class=editor-wrap></div><div class=puzzles-wrap>"),ml=ue("<div>"),wl=ue("<div class=progress> <!>/<!> "),kl=ue('<div class=puzzles><div class=filter><input type=text placeholder="Filter y_filter _!_ n_filter"><span>/10000 Positions</span></div><div class=list></div><div class=info><button>Toggle Solved</button><button>Toggle Id'),bl=ue("<div><span class=id><a target=_blank></a></span><span class=has-tags></span><span class=tags>"),ji=ue("<span class=tag>"),yl=ue("<div class=rule-list><div class=scroll-wrap></div><div class=tools><div class=rule>+ New rule</div><div class=rule>- Delete rule"),vl=ue("<div class=text-wrap><textarea class=editor-input title=rules rows=13 cols=21></textarea><div class=ascii><textarea>"),_l=ue("<div><span class=name></span><span class=stats>f <!> / s "),Cl=ue("<span>");function Sl(){return X(fl,{get children(){return X(El,{})}})}function El(){const[t,e]=ie(void 0),[n,i]=ie(0),r=ee(()=>{let c=t();return c?c.sans:[]});_e(()=>{let c=t(),l=n();c?s.on_set_fen_uci(c.move_fens[l+1]):s.on_set_fen_uci(qr)}),_e(pn(t,()=>{i(-1)}));const s=new Un,o=hl((c,l)=>{if(!l)return;const a=c.target;if(a.tagName!=="PIECE"&&a.tagName!=="SQUARE"&&a.tagName!=="CG-BOARD")return;c.preventDefault();let u=Math.sign(c.deltaY),h=t();u>0?h&&i(Math.min(h.move_fens.length-2,n()+1)):i(Math.max(-1,n()-1))});return[pl(),(()=>{var c=gl(),l=c.firstChild,a=l.firstChild,u=a.nextSibling,h=l.nextSibling,f=h.nextSibling;return ps(a,"wheel",o),B(a,X(tc,{onShapes:()=>{},movable:!0,get doPromotion(){return s.promotion},get onMoveAfter(){return s.on_move_after},get fen_uci(){return s.fen_uci},get color(){return s.turnColor},get dests(){return s.dests}})),B(u,X(ft,{get each(){return r()},children:(m,p)=>(()=>{var d=ml();return d.$$click=()=>i(p),B(d,m),Ee(()=>Vn(d,"san"+(n()===p()?" active":""))),d})()})),B(h,X(Pl,{get fen(){return s.fen_uci[0]}})),B(f,X($l,{on_selected_puzzle:e})),B(c,X(Al,{}),null),c})()]}const Al=()=>{const t=Wn(rn);return X(Gn,{get when(){return t.progress},children:e=>(()=>{var n=wl(),i=n.firstChild,r=i.nextSibling,s=r.nextSibling,o=s.nextSibling;return o.nextSibling,B(n,()=>e()[0],r),B(n,()=>e()[1],o),n})()})},Xt=class Xt{constructor(e){this.puzzle=e}get id(){return this.puzzle.id}get fen(){return this.puzzle.fen}get tags(){return this.puzzle.tags}get has_tags(){return Kr(this.puzzle)}get all_tags(){return Tc(this.puzzle)}};S(Xt,"create",e=>new Xt(e));let Yt=Xt;const $l=t=>{let e=Wn(rn);const n=ee(Qn(()=>e.puzzles,Yt.create)),[i,r]=An(void 0,"filter"),[s,o]=An(void 0,"id_selected"),c=ee(()=>n().find(f=>f.id===s())),l=()=>{let f=i();if(f){if(f.includes("id_"))f=f.replace(/id_\w*/,"");else{let m=c();if(!m)return;let[p,d]=f.split("_!_");f=p.trim()+` id_${m.id} `,d!==void 0&&(f+="_!_"+d.trim())}r(f)}},a=()=>{let f=i();f&&(f.includes("solved")?f=f.replace("solved",""):f=f.trim()+" solved",r(f))};_e(pn(c,f=>{var m;f?t.on_selected_puzzle(f.puzzle):(n()[0]&&o((m=n()[0])==null?void 0:m.id),t.on_selected_puzzle(void 0))})),_e(pn(i,f=>{e.filter(f)}));let u;const h=dl(f=>{r(f)},1100);return(()=>{var f=kl(),m=f.firstChild,p=m.firstChild,d=p.nextSibling,b=d.firstChild,_=m.nextSibling,k=_.nextSibling,v=k.firstChild,C=v.nextSibling;return Ji(y=>u=y,p),p.$$input=()=>h(u.value),mi(p,"spellcheck",!1),B(d,()=>n().length,b),B(_,X(Gn,{get when(){return n()},children:y=>X(ft,{get each(){return y().slice(0,1e3)},children:E=>(()=>{var P=bl(),A=P.firstChild,I=A.firstChild,K=A.nextSibling,D=K.nextSibling;return P.$$click=()=>o(E.id),B(I,()=>E.id),B(K,X(ft,{get each(){return Object.keys(E.has_tags).filter(z=>!z.includes("id_"))},children:z=>(()=>{var W=ji();return B(W,z),W})()})),B(D,X(ft,{get each(){return Object.keys(E.all_tags)},children:z=>(()=>{var W=ji();return B(W,z),W})()})),Ee(z=>{var W="puzzle"+(E.id===s()?" active":""),$=`https://lichess.org/training/${E.id}`;return W!==z.e&&Vn(P,z.e=W),$!==z.t&&mi(I,"href",z.t=$),z},{e:void 0,t:void 0}),P})()})})),v.$$click=a,C.$$click=l,Ee(()=>p.value=i()),f})()};function Pl(t){let e=Wn(rn);const n=ee(Qn(()=>e.all,Yt.create)),i=b=>n().filter(_=>_.all_tags[`failed_${b}`]).length,r=b=>n().filter(_=>_.all_tags[`solved_${b}`]).length;function s(){let b=1,_=`rule${b}`,k=o();for(;k.find(v=>v.name===_);)_=`rule${b++}`;return{name:_,rule:""}}const[o,c]=An([{name:"rule1",rule:""}],"rule-list"),[l,a]=ie(0);e.rules(o());const u=ee(()=>o()[l()]),h=b=>{if(b.key==="Escape"){let _=b.target.value,k=u(),v={name:k.name,rule:_},C=o(),y=C.findIndex(E=>E.name===k.name);C.splice(y,1,v),c([...C]),e.rules([v])}},f=()=>{Tt(()=>{c([s(),...o()]),a(0)})},m=()=>{let b=o();if(b.length===1)return;let _=b.splice(l(),1);c([...b]),e.rules(_.map(k=>({name:k.name,rule:""})))};let p=ee(()=>{if(t.fen)try{return xc(t.fen,u().rule)}catch(b){return"Error"+b}});const d=ee(()=>{let b=u();if(!(!b||!t.fen))return Nr(Tr(t.fen,b.rule))});return[(()=>{var b=yl(),_=b.firstChild,k=_.nextSibling,v=k.firstChild,C=v.nextSibling;return B(_,X(ft,{get each(){return o()},children:(y,E)=>(()=>{var P=_l(),A=P.firstChild,I=A.nextSibling,K=I.firstChild,D=K.nextSibling;return D.nextSibling,P.$$click=()=>a(E()),B(A,()=>y.name),B(I,()=>i(y.name),D),B(I,()=>r(y.name),null),Ee(()=>Vn(P,"rule"+(E()===l()?" active":""))),P})()})),v.$$click=f,C.$$click=m,b})(),(()=>{var b=vl(),_=b.firstChild,k=_.nextSibling,v=k.firstChild;return _.$$keydown=h,v.disabled=!0,B(v,d),B(k,X(Gn,{get when(){return p()},children:C=>(()=>{var y=Cl();return B(y,C),y})()}),null),Ee(()=>{var C;return _.value=((C=u())==null?void 0:C.rule)??"Select a rule"}),b})()]}ds(["click","input","keydown"]);const Rl=document.getElementById("root");fs(()=>X(Sl,{}),Rl);
