var Wi=Object.defineProperty;var Ui=(t,e,n)=>e in t?Wi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var v=(t,e,n)=>Ui(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();const j={context:void 0,registry:void 0,effects:void 0,done:!1,getContextId(){return cr(this.context.count)},getNextContextId(){return cr(this.context.count++)}};function cr(t){const e=String(t),n=e.length-1;return j.context.id+(n?String.fromCharCode(96+n):"")+e}function Hi(t){j.context=t}const Gi=(t,e)=>t===e,Vi=Symbol("solid-proxy"),Qi=Symbol("solid-track"),At={equals:Gi};let Lr=jr;const Se=1,$t=2,Br={owned:null,cleanups:null,context:null,owner:null};var M=null;let Yt=null,Yi=null,T=null,G=null,ge=null,Gt=0;function St(t,e){const n=T,r=M,i=t.length===0,s=e===void 0?r:e,o=i?Br:{owned:null,cleanups:null,context:s?s.context:null,owner:s},l=i?t:()=>t(()=>ie(()=>at(o)));M=o,T=null;try{return Xe(l,!0)}finally{T=n,M=r}}function Q(t,e){e=e?Object.assign({},At,e):At;const n={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},r=i=>(typeof i=="function"&&(i=i(n.value)),qr(n,i));return[Fr.bind(n),r]}function me(t,e,n){const r=Ln(t,e,!1,Se);kt(r)}function de(t,e,n){Lr=rs;const r=Ln(t,e,!1,Se);r.user=!0,ge?ge.push(r):kt(r)}function H(t,e,n){n=n?Object.assign({},At,n):At;const r=Ln(t,e,!0,0);return r.observers=null,r.observerSlots=null,r.comparator=n.equals||void 0,kt(r),Fr.bind(r)}function xt(t){return Xe(t,!1)}function ie(t){if(T===null)return t();const e=T;T=null;try{return t()}finally{T=e}}function rn(t,e,n){const r=Array.isArray(t);let i;return s=>{let o;if(r){o=Array(t.length);for(let c=0;c<t.length;c++)o[c]=t[c]()}else o=t();const l=ie(()=>e(o,i,s));return i=o,l}}function Ji(t){de(()=>ie(t))}function Zi(t){return M===null||(M.cleanups===null?M.cleanups=[t]:M.cleanups.push(t)),t}function Xi(t,e){const n=Symbol("context");return{id:n,Provider:ss(n),defaultValue:t}}function Kn(t){let e;return M&&M.context&&(e=M.context[t.id])!==void 0?e:t.defaultValue}function es(t){const e=H(t),n=H(()=>sn(e()));return n.toArray=()=>{const r=n();return Array.isArray(r)?r:r!=null?[r]:[]},n}function Fr(){if(this.sources&&this.state)if(this.state===Se)kt(this);else{const t=G;G=null,Xe(()=>Rt(this),!1),G=t}if(T){const t=this.observers?this.observers.length:0;T.sources?(T.sources.push(this),T.sourceSlots.push(t)):(T.sources=[this],T.sourceSlots=[t]),this.observers?(this.observers.push(T),this.observerSlots.push(T.sources.length-1)):(this.observers=[T],this.observerSlots=[T.sources.length-1])}return this.value}function qr(t,e,n){let r=t.value;return(!t.comparator||!t.comparator(r,e))&&(t.value=e,t.observers&&t.observers.length&&Xe(()=>{for(let i=0;i<t.observers.length;i+=1){const s=t.observers[i],o=Yt&&Yt.running;o&&Yt.disposed.has(s),(o?!s.tState:!s.state)&&(s.pure?G.push(s):ge.push(s),s.observers&&Wr(s)),o||(s.state=Se)}if(G.length>1e6)throw G=[],new Error},!1)),e}function kt(t){if(!t.fn)return;at(t);const e=Gt;ts(t,t.value,e)}function ts(t,e,n){let r;const i=M,s=T;T=M=t;try{r=t.fn(e)}catch(o){return t.pure&&(t.state=Se,t.owned&&t.owned.forEach(at),t.owned=null),t.updatedAt=n+1,Ur(o)}finally{T=s,M=i}(!t.updatedAt||t.updatedAt<=n)&&(t.updatedAt!=null&&"observers"in t?qr(t,r):t.value=r,t.updatedAt=n)}function Ln(t,e,n,r=Se,i){const s={fn:t,state:r,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:M,context:M?M.context:null,pure:n};return M===null||M!==Br&&(M.owned?M.owned.push(s):M.owned=[s]),s}function Pt(t){if(t.state===0)return;if(t.state===$t)return Rt(t);if(t.suspense&&ie(t.suspense.inFallback))return t.suspense.effects.push(t);const e=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<Gt);)t.state&&e.push(t);for(let n=e.length-1;n>=0;n--)if(t=e[n],t.state===Se)kt(t);else if(t.state===$t){const r=G;G=null,Xe(()=>Rt(t,e[0]),!1),G=r}}function Xe(t,e){if(G)return t();let n=!1;e||(G=[]),ge?n=!0:ge=[],Gt++;try{const r=t();return ns(n),r}catch(r){n||(ge=null),G=null,Ur(r)}}function ns(t){if(G&&(jr(G),G=null),t)return;const e=ge;ge=null,e.length&&Xe(()=>Lr(e),!1)}function jr(t){for(let e=0;e<t.length;e++)Pt(t[e])}function rs(t){let e,n=0;for(e=0;e<t.length;e++){const r=t[e];r.user?t[n++]=r:Pt(r)}if(j.context){if(j.count){j.effects||(j.effects=[]),j.effects.push(...t.slice(0,n));return}Hi()}for(j.effects&&!j.count&&(t=[...j.effects,...t],n+=j.effects.length,delete j.effects),e=0;e<n;e++)Pt(t[e])}function Rt(t,e){t.state=0;for(let n=0;n<t.sources.length;n+=1){const r=t.sources[n];if(r.sources){const i=r.state;i===Se?r!==e&&(!r.updatedAt||r.updatedAt<Gt)&&Pt(r):i===$t&&Rt(r,e)}}}function Wr(t){for(let e=0;e<t.observers.length;e+=1){const n=t.observers[e];n.state||(n.state=$t,n.pure?G.push(n):ge.push(n),n.observers&&Wr(n))}}function at(t){let e;if(t.sources)for(;t.sources.length;){const n=t.sources.pop(),r=t.sourceSlots.pop(),i=n.observers;if(i&&i.length){const s=i.pop(),o=n.observerSlots.pop();r<i.length&&(s.sourceSlots[o]=r,i[r]=s,n.observerSlots[r]=o)}}if(t.tOwned){for(e=t.tOwned.length-1;e>=0;e--)at(t.tOwned[e]);delete t.tOwned}if(t.owned){for(e=t.owned.length-1;e>=0;e--)at(t.owned[e]);t.owned=null}if(t.cleanups){for(e=t.cleanups.length-1;e>=0;e--)t.cleanups[e]();t.cleanups=null}t.state=0}function is(t){return t instanceof Error?t:new Error(typeof t=="string"?t:"Unknown error",{cause:t})}function Ur(t,e=M){throw is(t)}function sn(t){if(typeof t=="function"&&!t.length)return sn(t());if(Array.isArray(t)){const e=[];for(let n=0;n<t.length;n++){const r=sn(t[n]);Array.isArray(r)?e.push.apply(e,r):e.push(r)}return e}return t}function ss(t,e){return function(r){let i;return me(()=>i=ie(()=>(M.context={...M.context,[t]:r.value},es(()=>r.children))),void 0),i}}const os=Symbol("fallback");function ar(t){for(let e=0;e<t.length;e++)t[e]()}function Bn(t,e,n={}){let r=[],i=[],s=[],o=0,l=e.length>1?[]:null;return Zi(()=>ar(s)),()=>{let c=t()||[],a=c.length,h,u;return c[Qi],ie(()=>{let g,m,f,b,k,y,$,P,x;if(a===0)o!==0&&(ar(s),s=[],r=[],i=[],o=0,l&&(l=[])),n.fallback&&(r=[os],i[0]=St(Z=>(s[0]=Z,n.fallback())),o=1);else if(o===0){for(i=new Array(a),u=0;u<a;u++)r[u]=c[u],i[u]=St(p);o=a}else{for(f=new Array(a),b=new Array(a),l&&(k=new Array(a)),y=0,$=Math.min(o,a);y<$&&r[y]===c[y];y++);for($=o-1,P=a-1;$>=y&&P>=y&&r[$]===c[P];$--,P--)f[P]=i[$],b[P]=s[$],l&&(k[P]=l[$]);for(g=new Map,m=new Array(P+1),u=P;u>=y;u--)x=c[u],h=g.get(x),m[u]=h===void 0?-1:h,g.set(x,u);for(h=y;h<=$;h++)x=r[h],u=g.get(x),u!==void 0&&u!==-1?(f[u]=i[h],b[u]=s[h],l&&(k[u]=l[h]),u=m[u],g.set(x,u)):s[h]();for(u=y;u<a;u++)u in f?(i[u]=f[u],s[u]=b[u],l&&(l[u]=k[u],l[u](u))):i[u]=St(p);i=i.slice(0,o=a),r=c.slice(0)}return i});function p(g){if(s[u]=g,l){const[m,f]=Q(u);return l[u]=f,e(c[u],m)}return e(c[u])}}}function U(t,e){return ie(()=>t(e||{}))}let ls=0;function cs(){return j.context?j.getNextContextId():`cl-${ls++}`}const as=t=>`Stale read from <${t}>.`;function ot(t){const e="fallback"in t&&{fallback:()=>t.fallback};return H(Bn(()=>t.each,t.children,e||void 0))}function Fn(t){const e=t.keyed,n=H(()=>t.when,void 0,{equals:(r,i)=>e?r===i:!r==!i});return H(()=>{const r=n();if(r){const i=t.children;return typeof i=="function"&&i.length>0?ie(()=>i(e?r:()=>{if(!ie(n))throw as("Show");return t.when})):i}return t.fallback},void 0,void 0)}function us(t,e,n){let r=n.length,i=e.length,s=r,o=0,l=0,c=e[i-1].nextSibling,a=null;for(;o<i||l<s;){if(e[o]===n[l]){o++,l++;continue}for(;e[i-1]===n[s-1];)i--,s--;if(i===o){const h=s<r?l?n[l-1].nextSibling:n[s-l]:c;for(;l<s;)t.insertBefore(n[l++],h)}else if(s===l)for(;o<i;)(!a||!a.has(e[o]))&&e[o].remove(),o++;else if(e[o]===n[s-1]&&n[l]===e[i-1]){const h=e[--i].nextSibling;t.insertBefore(n[l++],e[o++].nextSibling),t.insertBefore(n[--s],h),e[i]=n[s]}else{if(!a){a=new Map;let u=l;for(;u<s;)a.set(n[u],u++)}const h=a.get(e[o]);if(h!=null)if(l<h&&h<s){let u=o,p=1,g;for(;++u<i&&u<s&&!((g=a.get(e[u]))==null||g!==h+p);)p++;if(p>h-l){const m=e[o];for(;l<h;)t.insertBefore(n[l++],m)}else t.replaceChild(n[l++],e[o++])}else o++;else e[o++].remove()}}}const ur="_$DX_DELEGATE";function hs(t,e,n,r={}){let i;return St(s=>{i=s,e===document?t():O(e,t(),e.firstChild?null:void 0,n)},r.owner),()=>{i(),e.textContent=""}}function se(t,e,n){let r;const i=()=>{const o=document.createElement("template");return o.innerHTML=t,o.content.firstChild},s=()=>(r||(r=i())).cloneNode(!0);return s.cloneNode=s,s}function fs(t,e=window.document){const n=e[ur]||(e[ur]=new Set);for(let r=0,i=t.length;r<i;r++){const s=t[r];n.has(s)||(n.add(s),e.addEventListener(s,ps))}}function hr(t,e,n){jn(t)||(n==null?t.removeAttribute(e):t.setAttribute(e,n))}function qn(t,e){jn(t)||(e==null?t.removeAttribute("class"):t.className=e)}function ds(t,e,n,r){if(Array.isArray(n)){const i=n[0];t.addEventListener(e,n[0]=s=>i.call(t,n[1],s))}else t.addEventListener(e,n,typeof n!="function"&&n)}function Hr(t,e,n){return ie(()=>t(e,n))}function O(t,e,n,r){if(n!==void 0&&!r&&(r=[]),typeof e!="function")return Mt(t,e,r,n);me(i=>Mt(t,e(),i,n),r)}function jn(t){return!!j.context&&!j.done&&(!t||t.isConnected)}function ps(t){let e=t.target;const n=`$$${t.type}`,r=t.target,i=t.currentTarget,s=c=>Object.defineProperty(t,"target",{configurable:!0,value:c}),o=()=>{const c=e[n];if(c&&!e.disabled){const a=e[`${n}Data`];if(a!==void 0?c.call(e,a,t):c.call(e,t),t.cancelBubble)return}return e.host&&typeof e.host!="string"&&!e.host._$host&&e.contains(t.target)&&s(e.host),!0},l=()=>{for(;o()&&(e=e._$host||e.parentNode||e.host););};if(Object.defineProperty(t,"currentTarget",{configurable:!0,get(){return e||document}}),t.composedPath){const c=t.composedPath();s(c[0]);for(let a=0;a<c.length-2&&(e=c[a],!!o());a++){if(e._$host){e=e._$host,l();break}if(e.parentNode===i)break}}else l();s(r)}function Mt(t,e,n,r,i){const s=jn(t);if(s){!n&&(n=[...t.childNodes]);let c=[];for(let a=0;a<n.length;a++){const h=n[a];h.nodeType===8&&h.data.slice(0,2)==="!$"?h.remove():c.push(h)}n=c}for(;typeof n=="function";)n=n();if(e===n)return n;const o=typeof e,l=r!==void 0;if(t=l&&n[0]&&n[0].parentNode||t,o==="string"||o==="number"){if(s||o==="number"&&(e=e.toString(),e===n))return n;if(l){let c=n[0];c&&c.nodeType===3?c.data!==e&&(c.data=e):c=document.createTextNode(e),n=Le(t,n,r,c)}else n!==""&&typeof n=="string"?n=t.firstChild.data=e:n=t.textContent=e}else if(e==null||o==="boolean"){if(s)return n;n=Le(t,n,r)}else{if(o==="function")return me(()=>{let c=e();for(;typeof c=="function";)c=c();n=Mt(t,c,n,r)}),()=>n;if(Array.isArray(e)){const c=[],a=n&&Array.isArray(n);if(on(c,e,n,i))return me(()=>n=Mt(t,c,n,r,!0)),()=>n;if(s){if(!c.length)return n;if(r===void 0)return n=[...t.childNodes];let h=c[0];if(h.parentNode!==t)return n;const u=[h];for(;(h=h.nextSibling)!==r;)u.push(h);return n=u}if(c.length===0){if(n=Le(t,n,r),l)return n}else a?n.length===0?fr(t,c,r):us(t,n,c):(n&&Le(t),fr(t,c));n=c}else if(e.nodeType){if(s&&e.parentNode)return n=l?[e]:e;if(Array.isArray(n)){if(l)return n=Le(t,n,r,e);Le(t,n,null,e)}else n==null||n===""||!t.firstChild?t.appendChild(e):t.replaceChild(e,t.firstChild);n=e}}return n}function on(t,e,n,r){let i=!1;for(let s=0,o=e.length;s<o;s++){let l=e[s],c=n&&n[t.length],a;if(!(l==null||l===!0||l===!1))if((a=typeof l)=="object"&&l.nodeType)t.push(l);else if(Array.isArray(l))i=on(t,l,c)||i;else if(a==="function")if(r){for(;typeof l=="function";)l=l();i=on(t,Array.isArray(l)?l:[l],Array.isArray(c)?c:[c])||i}else t.push(l),i=!0;else{const h=String(l);c&&c.nodeType===3&&c.data===h?t.push(c):t.push(document.createTextNode(h))}}return i}function fr(t,e,n=null){for(let r=0,i=e.length;r<i;r++)t.insertBefore(e[r],n)}function Le(t,e,n,r){if(n===void 0)return t.textContent="";const i=r||document.createTextNode("");if(e.length){let s=!1;for(let o=e.length-1;o>=0;o--){const l=e[o];if(i!==l){const c=l.parentNode===t;!s&&!o?c?t.replaceChild(i,l):t.insertBefore(i,n):c&&l.remove()}else s=!0}}else t.insertBefore(i,n);return[i]}const gs=["white","black"],Ot=["a","b","c","d","e","f","g","h"],Nt=["1","2","3","4","5","6","7","8"],ms=[...Nt].reverse(),Wn=Array.prototype.concat(...Ot.map(t=>Nt.map(e=>t+e))),ne=t=>Wn[8*t[0]+t[1]],N=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],Gr=Wn.map(N);function ws(t){let e;const n=()=>(e===void 0&&(e=t()),e);return n.clear=()=>{e=void 0},n}const bs=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Un=t=>t==="white"?"black":"white",ut=(t,e)=>{const n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r},ln=(t,e)=>t.role===e.role&&t.color===e.color,yt=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],ae=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},Vr=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},Hn=(t,e)=>{t.style.visibility=e?"visible":"hidden"},Ie=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},Qr=t=>t.button===2,pe=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function Yr(t,e,n){const r=N(t);return e||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const Ne=(t,e)=>Math.abs(t-e),ks=t=>(e,n,r,i)=>Ne(e,r)<2&&(t==="white"?i===n+1||n<=1&&i===n+2&&e===r:i===n-1||n>=6&&i===n-2&&e===r),Jr=(t,e,n,r)=>{const i=Ne(t,n),s=Ne(e,r);return i===1&&s===2||i===2&&s===1},Zr=(t,e,n,r)=>Ne(t,n)===Ne(e,r),Xr=(t,e,n,r)=>t===n||e===r,ei=(t,e,n,r)=>Zr(t,e,n,r)||Xr(t,e,n,r),ys=(t,e,n)=>(r,i,s,o)=>Ne(r,s)<2&&Ne(i,o)<2||n&&i===o&&i===(t==="white"?0:7)&&(r===4&&(s===2&&e.includes(0)||s===6&&e.includes(7))||e.includes(s));function vs(t,e){const n=e==="white"?"1":"8",r=[];for(const[i,s]of t)i[1]===n&&s.color===e&&s.role==="rook"&&r.push(N(i)[0]);return r}function ti(t,e,n){const r=t.get(e);if(!r)return[];const i=N(e),s=r.role,o=s==="pawn"?ks(r.color):s==="knight"?Jr:s==="bishop"?Zr:s==="rook"?Xr:s==="queen"?ei:ys(r.color,vs(t,r.color),n);return Gr.filter(l=>(i[0]!==l[0]||i[1]!==l[1])&&o(i[0],i[1],l[0],l[1])).map(ne)}function Y(t,...e){t&&setTimeout(()=>t(...e),1)}function _s(t){t.orientation=Un(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function Cs(t,e){for(const[n,r]of e)r?t.pieces.set(n,r):t.pieces.delete(n)}function Ss(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[n,r]of t.pieces)r.role==="king"&&r.color===e&&(t.check=n)}function Es(t,e,n,r){Ae(t),t.premovable.current=[e,n],Y(t.premovable.events.set,e,n,r)}function Ee(t){t.premovable.current&&(t.premovable.current=void 0,Y(t.premovable.events.unset))}function As(t,e,n){Ee(t),t.predroppable.current={role:e,key:n},Y(t.predroppable.events.set,e,n)}function Ae(t){const e=t.predroppable;e.current&&(e.current=void 0,Y(e.events.unset))}function $s(t,e,n){if(!t.autoCastle)return!1;const r=t.pieces.get(e);if(!r||r.role!=="king")return!1;const i=N(e),s=N(n);if(i[1]!==0&&i[1]!==7||i[1]!==s[1])return!1;i[0]===4&&!t.pieces.has(n)&&(s[0]===6?n=ne([7,s[1]]):s[0]===2&&(n=ne([0,s[1]])));const o=t.pieces.get(n);return!o||o.color!==r.color||o.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(n),i[0]<s[0]?(t.pieces.set(ne([6,s[1]]),r),t.pieces.set(ne([5,s[1]]),o)):(t.pieces.set(ne([2,s[1]]),r),t.pieces.set(ne([3,s[1]]),o)),!0)}function ni(t,e,n){const r=t.pieces.get(e),i=t.pieces.get(n);if(e===n||!r)return!1;const s=i&&i.color!==r.color?i:void 0;return n===t.selected&&re(t),Y(t.events.move,e,n,s),$s(t,e,n)||(t.pieces.set(n,r),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,Y(t.events.change),s||!0}function Gn(t,e,n,r){if(t.pieces.has(n))if(r)t.pieces.delete(n);else return!1;return Y(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,Y(t.events.change),t.movable.dests=void 0,t.turnColor=Un(t.turnColor),!0}function ri(t,e,n){const r=ni(t,e,n);return r&&(t.movable.dests=void 0,t.turnColor=Un(t.turnColor),t.animation.current=void 0),r}function ii(t,e,n){if(Vn(t,e,n)){const r=ri(t,e,n);if(r){const i=t.hold.stop();re(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:i};return r!==!0&&(s.captured=r),Y(t.movable.events.after,e,n,s),!0}}else if(Ps(t,e,n))return Es(t,e,n,{ctrlKey:t.stats.ctrlKey}),re(t),!0;return re(t),!1}function si(t,e,n,r){const i=t.pieces.get(e);i&&(xs(t,e,n)||r)?(t.pieces.delete(e),Gn(t,i,n,r),Y(t.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&Rs(t,e,n)?As(t,i.role,n):(Ee(t),Ae(t)),t.pieces.delete(e),re(t)}function cn(t,e,n){if(Y(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){re(t),t.hold.cancel();return}else if((t.selectable.enabled||n)&&t.selected!==e&&ii(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(li(t,e)||Qn(t,e))&&(oi(t,e),t.hold.start())}function oi(t,e){t.selected=e,Qn(t,e)?t.premovable.customDests||(t.premovable.dests=ti(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function re(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function li(t,e){const n=t.pieces.get(e);return!!n&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}const Vn=(t,e,n)=>{var r,i;return e!==n&&li(t,e)&&(t.movable.free||!!(!((i=(r=t.movable.dests)===null||r===void 0?void 0:r.get(e))===null||i===void 0)&&i.includes(n)))};function xs(t,e,n){const r=t.pieces.get(e);return!!r&&(e===n||!t.pieces.has(n))&&(t.movable.color==="both"||t.movable.color===r.color&&t.turnColor===r.color)}function Qn(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function Ps(t,e,n){var r,i;const s=(i=(r=t.premovable.customDests)===null||r===void 0?void 0:r.get(e))!==null&&i!==void 0?i:ti(t.pieces,e,t.premovable.castle);return e!==n&&Qn(t,e)&&s.includes(n)}function Rs(t,e,n){const r=t.pieces.get(e),i=t.pieces.get(n);return!!r&&(!i||i.color!==t.movable.color)&&t.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&t.movable.color===r.color&&t.turnColor!==r.color}function Ms(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}function Os(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],r=e[1];let i=!1;if(Vn(t,n,r)){const s=ri(t,n,r);if(s){const o={premove:!0};s!==!0&&(o.captured=s),Y(t.movable.events.after,n,r,o),i=!0}}return Ee(t),i}function Ns(t,e){const n=t.predroppable.current;let r=!1;if(!n)return!1;if(e(n)){const i={role:n.role,color:t.movable.color};Gn(t,i,n.key)&&(Y(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return Ae(t),r}function Yn(t){Ee(t),Ae(t),re(t)}function dr(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Yn(t)}function Ke(t,e,n){let r=Math.floor(8*(t[0]-n.left)/n.width);e||(r=7-r);let i=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(i=7-i),r>=0&&r<8&&i>=0&&i<8?ne([r,i]):void 0}function Ts(t,e,n,r){const i=N(t),s=Gr.filter(a=>ei(i[0],i[1],a[0],a[1])||Jr(i[0],i[1],a[0],a[1])),l=s.map(a=>Yr(ne(a),n,r)).map(a=>ut(e,a)),[,c]=l.reduce((a,h,u)=>a[0]<h?a:[h,u],[l[0],0]);return ne(s[c])}const J=t=>t.orientation==="white",ci="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ds={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},zs={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ai(t){t==="start"&&(t=ci);const e=new Map;let n=7,r=0;for(const i of t)switch(i){case" ":case"[":return e;case"/":if(--n,n<0)return e;r=0;break;case"~":{const s=e.get(ne([r-1,n]));s&&(s.promoted=!0);break}default:{const s=i.charCodeAt(0);if(s<57)r+=s-48;else{const o=i.toLowerCase();e.set(ne([r,n]),{role:Ds[o],color:i===o?"black":"white"}),++r}}}return e}function Is(t){return ms.map(e=>Ot.map(n=>{const r=t.get(n+e);if(r){let i=zs[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function ui(t,e){e.animation&&(Jn(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function hi(t,e){var n,r,i;if(!((n=e.movable)===null||n===void 0)&&n.dests&&(t.movable.dests=void 0),!((r=e.drawable)===null||r===void 0)&&r.autoShapes&&(t.drawable.autoShapes=[]),Jn(t,e),e.fen&&(t.pieces=ai(e.fen),t.drawable.shapes=((i=e.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in e&&Ss(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&oi(t,t.selected),ui(t,e),!t.movable.rookCastle&&t.movable.dests){const s=t.movable.color==="white"?"1":"8",o="e"+s,l=t.movable.dests.get(o),c=t.pieces.get(o);if(!l||!c||c.role!=="king")return;t.movable.dests.set(o,l.filter(a=>!(a==="a"+s&&l.includes("c"+s))&&!(a==="h"+s&&l.includes("g"+s))))}}function Jn(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)&&pr(t[n])&&pr(e[n])?Jn(t[n],e[n]):t[n]=e[n])}function pr(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const xe=(t,e)=>e.animation.enabled?Bs(t,e):ke(t,e);function ke(t,e){const n=t(e);return e.dom.redraw(),n}const Jt=(t,e)=>({key:t,pos:N(t),piece:e}),Ks=(t,e)=>e.sort((n,r)=>ut(t.pos,n.pos)-ut(t.pos,r.pos))[0];function Ls(t,e){const n=new Map,r=[],i=new Map,s=[],o=[],l=new Map;let c,a,h;for(const[u,p]of t)l.set(u,Jt(u,p));for(const u of Wn)c=e.pieces.get(u),a=l.get(u),c?a?ln(c,a.piece)||(s.push(a),o.push(Jt(u,c))):o.push(Jt(u,c)):a&&s.push(a);for(const u of o)a=Ks(u,s.filter(p=>ln(u.piece,p.piece))),a&&(h=[a.pos[0]-u.pos[0],a.pos[1]-u.pos[1]],n.set(u.key,h.concat(h)),r.push(a.key));for(const u of s)r.includes(u.key)||i.set(u.key,u.piece);return{anims:n,fadings:i}}function fi(t,e){const n=t.animation.current;if(n===void 0){t.dom.destroyed||t.dom.redrawNow();return}const r=1-(e-n.start)*n.frequency;if(r<=0)t.animation.current=void 0,t.dom.redrawNow();else{const i=Fs(r);for(const s of n.plan.anims.values())s[2]=s[0]*i,s[3]=s[1]*i;t.dom.redrawNow(!0),requestAnimationFrame((s=performance.now())=>fi(t,s))}}function Bs(t,e){const n=new Map(e.pieces),r=t(e),i=Ls(n,e);if(i.anims.size||i.fadings.size){const s=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:i},s||fi(e,performance.now())}else e.dom.redraw();return r}const Fs=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,qs=["green","red","blue","yellow"];function js(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?re(t):Yn(t);const n=Ie(e),r=Ke(n,J(t),t.dom.bounds());r&&(t.drawable.current={orig:r,pos:n,brush:Gs(e),snapToValidMove:t.drawable.defaultSnapToValidMove},di(t))}function di(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const n=Ke(e.pos,J(t),t.dom.bounds());n||(e.snapToValidMove=!1);const r=e.snapToValidMove?Ts(e.orig,e.pos,J(t),t.dom.bounds()):n;r!==e.mouseSq&&(e.mouseSq=r,e.dest=r!==e.orig?r:void 0,t.dom.redrawNow()),di(t)}})}function Ws(t,e){t.drawable.current&&(t.drawable.current.pos=Ie(e))}function Us(t){const e=t.drawable.current;e&&(e.mouseSq&&Vs(t.drawable,e),pi(t))}function pi(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function Hs(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),gi(t.drawable))}function Gs(t){var e;const n=(t.shiftKey||t.ctrlKey)&&Qr(t),r=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return qs[(n?1:0)+(r?2:0)]}function Vs(t,e){const n=i=>i.orig===e.orig&&i.dest===e.dest,r=t.shapes.find(n);r&&(t.shapes=t.shapes.filter(i=>!n(i))),(!r||r.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),gi(t)}function gi(t){t.onChange&&t.onChange(t.shapes)}function Qs(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),r=Ie(e),i=Ke(r,J(t),n);if(!i)return;const s=t.pieces.get(i),o=t.selected;if(!o&&t.drawable.enabled&&(t.drawable.eraseOnClick||!s||s.color!==t.turnColor)&&Hs(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||s||o||Ys(t,r)))e.preventDefault();else if(e.touches)return;const l=!!t.premovable.current,c=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&Vn(t,t.selected,i)?xe(u=>cn(u,i),t):cn(t,i);const a=t.selected===i,h=wi(t,i);if(s&&h&&a&&Ms(t,i)){t.draggable.current={orig:i,piece:s,origPos:r,pos:r,started:t.draggable.autoDistance&&t.stats.dragged,element:h,previouslySelected:o,originTarget:e.target,keyHasChanged:!1},h.cgDragging=!0,h.classList.add("dragging");const u=t.dom.elements.ghost;u&&(u.className=`ghost ${s.color} ${s.role}`,ae(u,yt(n)(N(i),J(t))),Hn(u,!0)),Zn(t)}else l&&Ee(t),c&&Ae(t);t.dom.redraw()}function Ys(t,e){const n=J(t),r=t.dom.bounds(),i=Math.pow(r.width/8,2);for(const s of t.pieces.keys()){const o=Yr(s,n,r);if(ut(o,e)<=i)return!0}return!1}function Js(t,e,n,r){const i="a0";t.pieces.set(i,e),t.dom.redraw();const s=Ie(n);t.draggable.current={orig:i,piece:e,origPos:s,pos:s,started:!0,element:()=>wi(t,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},Zn(t)}function Zn(t){requestAnimationFrame(()=>{var e;const n=t.draggable.current;if(!n)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(n.orig)&&(t.animation.current=void 0);const r=t.pieces.get(n.orig);if(!r||!ln(r,n.piece))Tt(t);else if(!n.started&&ut(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const s=n.element();if(!s)return;s.cgDragging=!0,s.classList.add("dragging"),n.element=s}const i=t.dom.bounds();ae(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==Ke(n.pos,J(t),i))}Zn(t)})}function Zs(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=Ie(e))}function Xs(t,e){const n=t.draggable.current;if(!n)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&n.originTarget!==e.target&&!n.newPiece){t.draggable.current=void 0;return}Ee(t),Ae(t);const r=Ie(e)||n.pos,i=Ke(r,J(t),t.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?si(t,n.orig,i,n.force):(t.stats.ctrlKey=e.ctrlKey,ii(t,n.orig,i)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!i&&(t.pieces.delete(n.orig),Y(t.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?re(t):t.selectable.enabled||re(t),mi(t),t.draggable.current=void 0,t.dom.redraw()}function Tt(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,re(t),mi(t),t.dom.redraw())}function mi(t){const e=t.dom.elements;e.ghost&&Hn(e.ghost,!1)}function wi(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&n.tagName==="PIECE")return n;n=n.nextSibling}}function eo(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{gr(t,2),setTimeout(()=>gr(t,void 0),120)},120)}function gr(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function to(t,e){function n(){_s(t),e()}return{set(r){r.orientation&&r.orientation!==t.orientation&&n(),ui(t,r),(r.fen?xe:ke)(i=>hi(i,r),t)},state:t,getFen:()=>Is(t.pieces),toggleOrientation:n,setPieces(r){xe(i=>Cs(i,r),t)},selectSquare(r,i){r?xe(s=>cn(s,r,i),t):t.selected&&(re(t),t.dom.redraw())},move(r,i){xe(s=>ni(s,r,i),t)},newPiece(r,i){xe(s=>Gn(s,r,i),t)},playPremove(){if(t.premovable.current){if(xe(Os,t))return!0;t.dom.redraw()}return!1},playPredrop(r){if(t.predroppable.current){const i=Ns(t,r);return t.dom.redraw(),i}return!1},cancelPremove(){ke(Ee,t)},cancelPredrop(){ke(Ae,t)},cancelMove(){ke(r=>{Yn(r),Tt(r)},t)},stop(){ke(r=>{dr(r),Tt(r)},t)},explode(r){eo(t,r)},setAutoShapes(r){ke(i=>i.drawable.autoShapes=r,t)},setShapes(r){ke(i=>i.drawable.shapes=r,t)},getKeyAtDomPos(r){return Ke(r,J(t),t.dom.bounds())},redrawAll:e,dragNewPiece(r,i,s){Js(t,r,i,s)},destroy(){dr(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function no(){return{pieces:ai(ci),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:bs()}}const mr={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function ro(){const t=L("defs"),e=V(L("filter"),{id:"cg-filter-blur"});return e.appendChild(V(L("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function io(t,e,n){var r;const i=t.drawable,s=i.current,o=s&&s.mouseSq?s:void 0,l=new Map,c=t.dom.bounds(),a=i.autoShapes.filter(g=>!g.piece);for(const g of i.shapes.concat(a).concat(o?[o]:[])){if(!g.dest)continue;const m=(r=l.get(g.dest))!==null&&r!==void 0?r:new Set,f=It(zt(N(g.orig),t.orientation),c),b=It(zt(N(g.dest),t.orientation),c);m.add(un(f,b)),l.set(g.dest,m)}const h=i.shapes.concat(a).map(g=>({shape:g,current:!1,hash:wr(g,an(g.dest,l),!1,c)}));o&&h.push({shape:o,current:!0,hash:wr(o,an(o.dest,l),!0,c)});const u=h.map(g=>g.hash).join(";");if(u===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=u;const p=e.querySelector("defs");so(i,h,p),oo(h,e.querySelector("g"),n.querySelector("g"),g=>ao(t,g,i.brushes,l,c))}function so(t,e,n){var r;const i=new Map;let s;for(const c of e.filter(a=>a.shape.dest&&a.shape.brush))s=bi(t.brushes[c.shape.brush],c.shape.modifiers),!((r=c.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(Dt(s).key,Dt(s)),i.set(s.key,s);const o=new Set;let l=n.firstElementChild;for(;l;)o.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(const[c,a]of i.entries())o.has(c)||n.appendChild(fo(a))}function oo(t,e,n,r){const i=new Map;for(const s of t)i.set(s.hash,!1);for(const s of[e,n]){const o=[];let l=s.firstElementChild,c;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):o.push(l),l=l.nextElementSibling;for(const a of o)s.removeChild(a)}for(const s of t.filter(o=>!i.get(o.hash)))for(const o of r(s))o.isCustom?n.appendChild(o.el):e.appendChild(o.el)}function wr({orig:t,dest:e,brush:n,piece:r,modifiers:i,customSvg:s,label:o},l,c,a){var h,u;return[a.width,a.height,c,t,e,n,l&&"-",r&&lo(r),i&&co(i),s&&`custom-${br(s.html)},${(u=(h=s.center)===null||h===void 0?void 0:h[0])!==null&&u!==void 0?u:"o"}`,o&&`label-${br(o.text)}`].filter(p=>p).join(",")}function lo(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function co(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function br(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return e.toString()}function ao(t,{shape:e,current:n,hash:r},i,s,o){var l,c;const a=It(zt(N(e.orig),t.orientation),o),h=e.dest?It(zt(N(e.dest),t.orientation),o):a,u=e.brush&&bi(i[e.brush],e.modifiers),p=s.get(e.dest),g=[];if(u){const m=V(L("g"),{cgHash:r});g.push({el:m}),a[0]!==h[0]||a[1]!==h[1]?m.appendChild(ho(e,u,a,h,n,an(e.dest,s))):m.appendChild(uo(i[e.brush],a,n,o))}if(e.label){const m=e.label;(l=m.fill)!==null&&l!==void 0||(m.fill=e.brush&&i[e.brush].color);const f=e.brush?void 0:"tr";g.push({el:po(m,r,a,h,p,f),isCustom:!0})}if(e.customSvg){const m=(c=e.customSvg.center)!==null&&c!==void 0?c:"orig",[f,b]=m==="label"?yi(a,h,p).map(y=>y-.5):m==="dest"?h:a,k=V(L("g"),{transform:`translate(${f},${b})`,cgHash:r});k.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,g.push({el:k,isCustom:!0})}return g}function uo(t,e,n,r){const i=go(),s=(r.width+r.height)/(4*Math.max(r.width,r.height));return V(L("circle"),{stroke:t.color,"stroke-width":i[n?0:1],fill:"none",opacity:ki(t,n),cx:e[0],cy:e[1],r:s-i[1]/2})}function Dt(t){return["#ffffff","#fff","white"].includes(t.color)?mr.hilitePrimary:mr.hiliteWhite}function ho(t,e,n,r,i,s){var o;function l(h){var u;const p=wo(s&&!i),g=r[0]-n[0],m=r[1]-n[1],f=Math.atan2(m,g),b=Math.cos(f)*p,k=Math.sin(f)*p;return V(L("line"),{stroke:h?Dt(e).color:e.color,"stroke-width":mo(e,i)+(h?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${h?Dt(e).key:e.key})`,opacity:!((u=t.modifiers)===null||u===void 0)&&u.hilite?1:ki(e,i),x1:n[0],y1:n[1],x2:r[0]-b,y2:r[1]-k})}if(!(!((o=t.modifiers)===null||o===void 0)&&o.hilite))return l(!1);const c=L("g"),a=V(L("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(bo(n,r)),a.appendChild(l(!0)),c.appendChild(a),c.appendChild(l(!1)),c}function fo(t){const e=V(L("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(V(L("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function po(t,e,n,r,i,s){var o;const c=.4*.75**t.text.length,a=yi(n,r,i),h=s==="tr"?.4:0,u=V(L("g"),{transform:`translate(${a[0]+h},${a[1]-h})`,cgHash:e});u.appendChild(V(L("circle"),{r:.4/2,"fill-opacity":s?1:.8,"stroke-opacity":s?1:.7,"stroke-width":.03,fill:(o=t.fill)!==null&&o!==void 0?o:"#666",stroke:"white"}));const p=V(L("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return p.innerHTML=t.text,u.appendChild(p),u}function zt(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function an(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function L(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function V(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.setAttribute(n,e[n]);return t}function bi(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(n=>n).join("")}:t}function go(){return[3/64,4/64]}function mo(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function ki(t,e){return(t.opacity||1)*(e?.9:1)}function wo(t){return(t?20:10)/64}function It(t,e){const n=Math.min(1,e.width/e.height),r=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*r]}function bo(t,e){const n={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return V(L("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function un(t,e,n=!0){const r=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function ko(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((n,r)=>n+r*r,0))}function yi(t,e,n){let r=ko(t,e);const i=un(t,e,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const s=un(t,e);(n.has((s+1)%16)||n.has((s+15)%16))&&s&1&&(r-=.4)}return[t[0]-Math.cos(i)*r,t[1]-Math.sin(i)*r].map(s=>s+.5)}function yo(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const c of gs)t.classList.toggle("orientation-"+c,e.orientation===c);t.classList.toggle("manipulable",!e.viewOnly);const n=pe("cg-container");t.appendChild(n);const r=pe("cg-board");n.appendChild(r);let i,s,o;if(e.drawable.visible&&(i=V(L("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(ro()),i.appendChild(L("g")),s=V(L("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),s.appendChild(L("g")),o=pe("cg-auto-pieces"),n.appendChild(i),n.appendChild(s),n.appendChild(o)),e.coordinates){const c=e.orientation==="black"?" black":"",a=e.ranksPosition==="left"?" left":"";if(e.coordinatesOnSquares){const h=e.orientation==="white"?u=>u+1:u=>8-u;Ot.forEach((u,p)=>n.appendChild(Zt(Nt.map(g=>u+g),"squares rank"+h(p)+c+a)))}else n.appendChild(Zt(Nt,"ranks"+c+a)),n.appendChild(Zt(Ot,"files"+c))}let l;return e.draggable.enabled&&e.draggable.showGhost&&(l=pe("piece","ghost"),Hn(l,!1),n.appendChild(l)),{board:r,container:n,wrap:t,ghost:l,svg:i,customSvg:s,autoPieces:o}}function Zt(t,e){const n=pe("coords",e);let r;for(const i of t)r=pe("coord"),r.textContent=i,n.appendChild(r);return n}function vo(t,e){if(!t.dropmode.active)return;Ee(t),Ae(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const r=Ie(e),i=r&&Ke(r,J(t),t.dom.bounds());i&&si(t,"a0",i)}t.dom.redraw()}function _o(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),t.viewOnly)return;const r=So(t);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function Co(t,e){const n=[];if("ResizeObserver"in window||n.push(et(document.body,"chessground.resize",e)),!t.viewOnly){const r=kr(t,Zs,Ws),i=kr(t,Xs,Us);for(const o of["touchmove","mousemove"])n.push(et(document,o,r));for(const o of["touchend","mouseup"])n.push(et(document,o,i));const s=()=>t.dom.bounds.clear();n.push(et(document,"scroll",s,{capture:!0,passive:!0})),n.push(et(window,"resize",s,{passive:!0}))}return()=>n.forEach(r=>r())}function et(t,e,n,r){return t.addEventListener(e,n,r),()=>t.removeEventListener(e,n,r)}const So=t=>e=>{t.draggable.current?Tt(t):t.drawable.current?pi(t):e.shiftKey||Qr(e)?t.drawable.enabled&&js(t,e):t.viewOnly||(t.dropmode.active?vo(t,e):Qs(t,e))},kr=(t,e,n)=>r=>{t.drawable.current?t.drawable.enabled&&n(t,r):t.viewOnly||e(t,r)};function Eo(t){const e=J(t),n=yt(t.dom.bounds()),r=t.dom.elements.board,i=t.pieces,s=t.animation.current,o=s?s.plan.anims:new Map,l=s?s.plan.fadings:new Map,c=t.draggable.current,a=$o(t),h=new Set,u=new Set,p=new Map,g=new Map;let m,f,b,k,y,$,P,x,Z,te;for(f=r.firstChild;f;){if(m=f.cgKey,vi(f))if(b=i.get(m),y=o.get(m),$=l.get(m),k=f.cgPiece,f.cgDragging&&(!c||c.orig!==m)&&(f.classList.remove("dragging"),ae(f,n(N(m),e)),f.cgDragging=!1),!$&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),b){if(y&&f.cgAnimating&&k===tt(b)){const R=N(m);R[0]+=y[2],R[1]+=y[3],f.classList.add("anim"),ae(f,n(R,e))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),ae(f,n(N(m),e)),t.addPieceZIndex&&(f.style.zIndex=Xt(N(m),e)));k===tt(b)&&(!$||!f.cgFading)?h.add(m):$&&k===tt($)?(f.classList.add("fading"),f.cgFading=!0):en(p,k,f)}else en(p,k,f);else if(_i(f)){const R=f.className;a.get(m)===R?u.add(m):en(g,R,f)}f=f.nextSibling}for(const[R,X]of a)if(!u.has(R)){Z=g.get(X),te=Z&&Z.pop();const D=n(N(R),e);if(te)te.cgKey=R,ae(te,D);else{const B=pe("square",X);B.cgKey=R,ae(B,D),r.insertBefore(B,r.firstChild)}}for(const[R,X]of i)if(y=o.get(R),!h.has(R))if(P=p.get(tt(X)),x=P&&P.pop(),x){x.cgKey=R,x.cgFading&&(x.classList.remove("fading"),x.cgFading=!1);const D=N(R);t.addPieceZIndex&&(x.style.zIndex=Xt(D,e)),y&&(x.cgAnimating=!0,x.classList.add("anim"),D[0]+=y[2],D[1]+=y[3]),ae(x,n(D,e))}else{const D=tt(X),B=pe("piece",D),$e=N(R);B.cgPiece=D,B.cgKey=R,y&&(B.cgAnimating=!0,$e[0]+=y[2],$e[1]+=y[3]),ae(B,n($e,e)),t.addPieceZIndex&&(B.style.zIndex=Xt($e,e)),r.appendChild(B)}for(const R of p.values())vr(t,R);for(const R of g.values())vr(t,R)}function Ao(t){const e=J(t),n=yt(t.dom.bounds());let r=t.dom.elements.board.firstChild;for(;r;)(vi(r)&&!r.cgAnimating||_i(r))&&ae(r,n(N(r.cgKey),e)),r=r.nextSibling}function yr(t){var e,n;const r=t.dom.elements.wrap.getBoundingClientRect(),i=t.dom.elements.container,s=r.height/r.width,o=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=o*s;i.style.width=o+"px",i.style.height=l+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("---cg-width",o+"px"),(n=t.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",l+"px")}const vi=t=>t.tagName==="PIECE",_i=t=>t.tagName==="SQUARE";function vr(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function Xt(t,e){const r=t[1];return`${e?10-r:3+r}`}const tt=t=>`${t.color} ${t.role}`;function $o(t){var e,n,r;const i=new Map;if(t.lastMove&&t.highlight.lastMove)for(const l of t.lastMove)fe(i,l,"last-move");if(t.check&&t.highlight.check&&fe(i,t.check,"check"),t.selected&&(fe(i,t.selected,"selected"),t.movable.showDests)){const l=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(l)for(const a of l)fe(i,a,"move-dest"+(t.pieces.has(a)?" oc":""));const c=(r=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(t.selected))!==null&&r!==void 0?r:t.premovable.dests;if(c)for(const a of c)fe(i,a,"premove-dest"+(t.pieces.has(a)?" oc":""))}const s=t.premovable.current;if(s)for(const l of s)fe(i,l,"current-premove");else t.predroppable.current&&fe(i,t.predroppable.current.key,"current-premove");const o=t.exploding;if(o)for(const l of o.keys)fe(i,l,"exploding"+o.stage);return t.highlight.custom&&t.highlight.custom.forEach((l,c)=>{fe(i,c,l)}),i}function fe(t,e,n){const r=t.get(e);r?t.set(e,`${r} ${n}`):t.set(e,n)}function en(t,e,n){const r=t.get(e);r?r.push(n):t.set(e,[n])}function xo(t,e,n){const r=new Map,i=[];for(const l of t)r.set(l.hash,!1);let s=e.firstElementChild,o;for(;s;)o=s.getAttribute("cgHash"),r.has(o)?r.set(o,!0):i.push(s),s=s.nextElementSibling;for(const l of i)e.removeChild(l);for(const l of t)r.get(l.hash)||e.appendChild(n(l))}function Po(t,e){const r=t.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Oo(i),current:!1}));xo(r,e,i=>Mo(t,i,t.dom.bounds()))}function Ro(t){var e;const n=J(t),r=yt(t.dom.bounds());let i=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;i;)Vr(i,r(N(i.cgKey),n),i.cgScale),i=i.nextSibling}function Mo(t,{shape:e,hash:n},r){var i,s,o;const l=e.orig,c=(i=e.piece)===null||i===void 0?void 0:i.role,a=(s=e.piece)===null||s===void 0?void 0:s.color,h=(o=e.piece)===null||o===void 0?void 0:o.scale,u=pe("piece",`${c} ${a}`);return u.setAttribute("cgHash",n),u.cgKey=l,u.cgScale=h,Vr(u,yt(r)(N(l),J(t)),h),u}const Oo=t=>{var e,n,r;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(n=t.piece)===null||n===void 0?void 0:n.color,(r=t.piece)===null||r===void 0?void 0:r.scale].join(",")};function No(t,e){const n=no();hi(n,e||{});function r(){const i="dom"in n?n.dom.unbind:void 0,s=yo(t,n),o=ws(()=>s.board.getBoundingClientRect()),l=h=>{Eo(a),s.autoPieces&&Po(a,s.autoPieces),!h&&s.svg&&io(a,s.svg,s.customSvg)},c=()=>{yr(a),Ao(a),s.autoPieces&&Ro(a)},a=n;return a.dom={elements:s,bounds:o,redraw:To(l),redrawNow:l,unbind:i},a.drawable.prevSvgHash="",yr(a),l(!1),_o(a,c),i||(a.dom.unbind=Co(a,c)),a.events.insert&&a.events.insert(s),a}return to(r(),r)}function To(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}let Ci=class{unwrap(e,n){const r=this._chain(i=>C.ok(e?e(i):i),i=>n?C.ok(n(i)):C.err(i));if(r.isErr)throw r.error;return r.value}map(e,n){return this._chain(r=>C.ok(e(r)),r=>C.err(n?n(r):r))}chain(e,n){return this._chain(e,n||(r=>C.err(r)))}},Do=class extends Ci{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}},zo=class extends Ci{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}};var C;(function(t){t.ok=function(e){return new Do(e)},t.err=function(e){return new zo(e||new Error)},t.all=function(e){if(Array.isArray(e)){const i=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;i.push(o.value)}return t.ok(i)}const n={},r=Object.keys(e);for(let i=0;i<r.length;i++){const s=e[r[i]];if(s.isErr)return s;n[r[i]]=s.value}return t.ok(n)}})(C||(C={}));const _r=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),hn=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Cr=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,hn(t));let w=class A{constructor(e,n){v(this,"lo");v(this,"hi");this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new A(0,1<<e-32):new A(1<<e,0)}static fromRank(e){return new A(255,0).shl64(8*e)}static fromFile(e){return new A(16843009<<e,16843009<<e)}static empty(){return new A(0,0)}static full(){return new A(4294967295,4294967295)}static corners(){return new A(129,2164260864)}static center(){return new A(402653184,24)}static backranks(){return new A(255,4278190080)}static backrank(e){return e==="white"?new A(255,0):new A(0,4278190080)}static lightSquares(){return new A(1437226410,1437226410)}static darkSquares(){return new A(2857740885,2857740885)}complement(){return new A(~this.lo,~this.hi)}xor(e){return new A(this.lo^e.lo,this.hi^e.hi)}union(e){return new A(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new A(this.lo&e.lo,this.hi&e.hi)}diff(e){return new A(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?A.empty():e>=32?new A(this.hi>>>e-32,0):e>0?new A(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?A.empty():e>=32?new A(0,this.lo<<e-32):e>0?new A(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new A(hn(this.hi),hn(this.lo))}rbit64(){return new A(Cr(this.hi),Cr(this.lo))}minus64(e){const n=this.lo-e.lo,r=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new A(n,this.hi-(e.hi+r))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return _r(this.lo)+_r(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new A(this.lo,this.hi|1<<e-32):new A(this.lo|1<<e,this.hi)}without(e){return e>=32?new A(this.lo,this.hi&~(1<<e-32)):new A(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new A(this.lo,this.hi^1<<e-32):new A(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new A(this.lo&this.lo-1,this.hi):new A(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const r=31-Math.clz32(e&-e);e^=1<<r,yield r}for(;n!==0;){const r=31-Math.clz32(n&-n);n^=1<<r,yield 32+r}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const r=31-Math.clz32(n);n^=1<<r,yield 32+r}for(;e!==0;){const r=31-Math.clz32(e);e^=1<<r,yield r}}};const fn=["a","b","c","d","e","f","g","h"],Si=["1","2","3","4","5","6","7","8"],Je=["white","black"],ue=["pawn","knight","bishop","rook","queen","king"],Io=["a","h"];let Ei=class Et{constructor(){v(this,"occupied");v(this,"promoted");v(this,"white");v(this,"black");v(this,"pawn");v(this,"knight");v(this,"bishop");v(this,"rook");v(this,"queen");v(this,"king")}static default(){const e=new Et;return e.reset(),e}reset(){this.occupied=new w(65535,4294901760),this.promoted=w.empty(),this.white=new w(65535,0),this.black=new w(0,4294901760),this.pawn=new w(65280,16711680),this.knight=new w(66,1107296256),this.bishop=new w(36,603979776),this.rook=new w(129,2164260864),this.queen=new w(8,134217728),this.king=new w(16,268435456)}static empty(){const e=new Et;return e.clear(),e}clear(){this.occupied=w.empty(),this.promoted=w.empty();for(const e of Je)this[e]=w.empty();for(const e of ue)this[e]=w.empty()}clone(){const e=new Et;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of Je)e[n]=this[n];for(const n of ue)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of ue)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const r=this.getRole(e),i=this.promoted.has(e);return{color:n,role:r,promoted:i}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const r=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),r}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}},vt=class je{constructor(){v(this,"pawn");v(this,"knight");v(this,"bishop");v(this,"rook");v(this,"queen");v(this,"king")}static empty(){const e=new je;for(const n of ue)e[n]=0;return e}static fromBoard(e,n){const r=new je;for(const i of ue)r[i]=e.pieces(n,i).size();return r}clone(){const e=new je;for(const n of ue)e[n]=this[n];return e}equals(e){return ue.every(n=>this[n]===e[n])}add(e){const n=new je;for(const r of ue)n[r]=this[r]+e[r];return n}subtract(e){const n=new je;for(const r of ue)n[r]=this[r]-e[r];return n}nonEmpty(){return ue.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}},Ko=class We{constructor(e,n){v(this,"white");v(this,"black");this.white=e,this.black=n}static empty(){return new We(vt.empty(),vt.empty())}static fromBoard(e){return new We(vt.fromBoard(e,"white"),vt.fromBoard(e,"black"))}clone(){return new We(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new We(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new We(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}},Sr=class dn{constructor(e,n){v(this,"white");v(this,"black");this.white=e,this.black=n}static default(){return new dn(3,3)}clone(){return new dn(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}};const E=t=>t!==void 0,z=t=>t==="white"?"black":"white",Te=t=>t>>3,ce=t=>t&7,pn=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,Er=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Lo(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Bo(t){if(t.length===2)return pn(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const Fo=t=>fn[ce(t)]+Si[Te(t)],Xn=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,er=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,qo="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",jo=qo+" w KQkq -",Wo=jo+" 0 1";var I;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(I||(I={}));let F=class extends Error{};const Uo=(t,e,n)=>{let r=t.indexOf(e);for(;n-- >0&&r!==-1;)r=t.indexOf(e,r+e.length);return r},Ge=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,Ai=t=>{const e=Lo(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},tn=t=>{const e=Ei.empty();let n=7,r=0;for(let i=0;i<t.length;i++){const s=t[i];if(s==="/"&&r===8)r=0,n--;else{const o=parseInt(s,10);if(o>0)r+=o;else{if(r>=8||n<0)return C.err(new F(I.Board));const l=r+n*8,c=Ai(s);if(!c)return C.err(new F(I.Board));t[i+1]==="~"&&(c.promoted=!0,i++),e.set(l,c),r++}}}return n!==0||r!==8?C.err(new F(I.Board)):C.ok(e)},Ar=t=>{if(t.length>64)return C.err(new F(I.Pockets));const e=Ko.empty();for(const n of t){const r=Ai(n);if(!r)return C.err(new F(I.Pockets));e[r.color][r.role]++}return C.ok(e)},Ho=(t,e)=>{let n=w.empty();if(e==="-")return C.ok(n);for(const r of e){const i=r.toLowerCase(),s=r===i?"black":"white",o=s==="white"?0:7;if("a"<=i&&i<="h")n=n.with(pn(i.charCodeAt(0)-97,o));else if(i==="k"||i==="q"){const l=t[s].intersect(w.backrank(s)).intersect(t.rook.union(t.king)),c=i==="k"?l.last():l.first();n=n.with(E(c)&&t.rook.has(c)?c:pn(i==="k"?7:0,o))}else return C.err(new F(I.Castling))}return Je.some(r=>w.backrank(r).intersect(n).size()>2)?C.err(new F(I.Castling)):C.ok(n)},$r=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=Ge(e[1]),r=Ge(e[2]);return!E(n)||n>3||!E(r)||r>3?C.err(new F(I.RemainingChecks)):C.ok(new Sr(3-n,3-r))}else if(e.length===2){const n=Ge(e[0]),r=Ge(e[1]);return!E(n)||n>3||!E(r)||r>3?C.err(new F(I.RemainingChecks)):C.ok(new Sr(n,r))}else return C.err(new F(I.RemainingChecks))},Go=t=>{const e=t.split(/[\s_]+/),n=e.shift();let r,i=C.ok(void 0);if(n.endsWith("]")){const l=n.indexOf("[");if(l===-1)return C.err(new F(I.Fen));r=tn(n.slice(0,l)),i=Ar(n.slice(l+1,-1))}else{const l=Uo(n,"/",7);l===-1?r=tn(n):(r=tn(n.slice(0,l)),i=Ar(n.slice(l+1)))}let s;const o=e.shift();if(!E(o)||o==="w")s="white";else if(o==="b")s="black";else return C.err(new F(I.Turn));return r.chain(l=>{const c=e.shift(),a=E(c)?Ho(l,c):C.ok(w.empty()),h=e.shift();let u;if(E(h)&&h!=="-"&&(u=Bo(h),!E(u)))return C.err(new F(I.EpSquare));let p=e.shift(),g;E(p)&&p.includes("+")&&(g=$r(p),p=e.shift());const m=E(p)?Ge(p):0;if(!E(m))return C.err(new F(I.Halfmoves));const f=e.shift(),b=E(f)?Ge(f):1;if(!E(b))return C.err(new F(I.Fullmoves));const k=e.shift();let y=C.ok(void 0);if(E(k)){if(E(g))return C.err(new F(I.RemainingChecks));y=$r(k)}else E(g)&&(y=g);return e.length>0?C.err(new F(I.Fen)):i.chain($=>a.chain(P=>y.map(x=>({board:l,pockets:$,turn:s,castlingRights:P,remainingChecks:x,epSquare:u,halfmoves:m,fullmoves:Math.max(1,b)}))))})};var Vo=se('<div class="is2d chessboard">');const Qo=t=>{let e,n;return Ji(()=>{let r=t.color,i=t.dests,s={premovable:{enabled:!1},movable:{color:r,free:!1,dests:i,events:{after:t.onMoveAfter}},drawable:{onChange:t.onShapes}};n=No(e,s)}),de(()=>{let r,i;t.fen_uci?[r,i]=t.fen_uci:r=Wo;let s=[];i&&(s.push(i.slice(0,2)),s.push(i.slice(2,4)));let o=t.movable?t.color:void 0;n.set({fen:r,lastMove:s,turnColor:t.color,movable:{color:o,dests:t.dests}})}),de(()=>{let r=t.orientation??"white";n.set({orientation:r})}),de(()=>{let r=t.doPromotion;if(r){let i=n.state.pieces.get(r);n.setPieces(new Map([[r,{color:i.color,role:"queen",promoted:!0}]]))}}),de(()=>{t.shapes&&n.setAutoShapes(t.shapes)}),(()=>{var r=Vo();return Hr(i=>e=i,r),r})()},Yo=Symbol("store-raw"),Jo=Symbol("store-node"),Be=Symbol("store-has"),Zo=Symbol("store-self");function ht(t){let e;return t!=null&&typeof t=="object"&&(t[Vi]||!(e=Object.getPrototypeOf(t))||e===Object.prototype||Array.isArray(t))}function gn(t,e=new Set){let n,r,i,s;if(n=t!=null&&t[Yo])return n;if(!ht(t)||e.has(t))return t;if(Array.isArray(t)){Object.isFrozen(t)?t=t.slice(0):e.add(t);for(let o=0,l=t.length;o<l;o++)i=t[o],(r=gn(i,e))!==i&&(t[o]=r)}else{Object.isFrozen(t)?t=Object.assign({},t):e.add(t);const o=Object.keys(t),l=Object.getOwnPropertyDescriptors(t);for(let c=0,a=o.length;c<a;c++)s=o[c],!l[s].get&&(i=t[s],(r=gn(i,e))!==i&&(t[s]=r))}return t}function Xo(t,e){let n=t[e];return n||Object.defineProperty(t,e,{value:n=Object.create(null)}),n}function xr(t,e,n){if(t[e])return t[e];const[r,i]=Q(n,{equals:!1,internal:!0});return r.$=i,t[e]=r}function be(t,e,n,r=!1){if(!r&&t[e]===n)return;const i=t[e],s=t.length;n===void 0?(delete t[e],t[Be]&&t[Be][e]&&i!==void 0&&t[Be][e].$()):(t[e]=n,t[Be]&&t[Be][e]&&i===void 0&&t[Be][e].$());let o=Xo(t,Jo),l;if((l=xr(o,e,i))&&l.$(()=>n),Array.isArray(t)&&t.length!==s){for(let c=t.length;c<s;c++)(l=o[c])&&l.$();(l=xr(o,"length",s))&&l.$(t.length)}(l=o[Zo])&&l.$()}const mn=Symbol("store-root");function Ue(t,e,n,r,i){const s=e[n];if(t===s)return;const o=Array.isArray(t);if(n!==mn&&(!ht(t)||!ht(s)||o!==Array.isArray(s)||i&&t[i]!==s[i])){be(e,n,t);return}if(o){if(t.length&&s.length&&(!r||i&&t[0]&&t[0][i]!=null)){let a,h,u,p,g,m,f,b;for(u=0,p=Math.min(s.length,t.length);u<p&&(s[u]===t[u]||i&&s[u]&&t[u]&&s[u][i]===t[u][i]);u++)Ue(t[u],s,u,r,i);const k=new Array(t.length),y=new Map;for(p=s.length-1,g=t.length-1;p>=u&&g>=u&&(s[p]===t[g]||i&&s[u]&&t[u]&&s[p][i]===t[g][i]);p--,g--)k[g]=s[p];if(u>g||u>p){for(h=u;h<=g;h++)be(s,h,t[h]);for(;h<t.length;h++)be(s,h,k[h]),Ue(t[h],s,h,r,i);s.length>t.length&&be(s,"length",t.length);return}for(f=new Array(g+1),h=g;h>=u;h--)m=t[h],b=i&&m?m[i]:m,a=y.get(b),f[h]=a===void 0?-1:a,y.set(b,h);for(a=u;a<=p;a++)m=s[a],b=i&&m?m[i]:m,h=y.get(b),h!==void 0&&h!==-1&&(k[h]=s[a],h=f[h],y.set(b,h));for(h=u;h<t.length;h++)h in k?(be(s,h,k[h]),Ue(t[h],s,h,r,i)):be(s,h,t[h])}else for(let a=0,h=t.length;a<h;a++)Ue(t[a],s,a,r,i);s.length>t.length&&be(s,"length",t.length);return}const l=Object.keys(t);for(let a=0,h=l.length;a<h;a++)Ue(t[l[a]],s,l[a],r,i);const c=Object.keys(s);for(let a=0,h=c.length;a<h;a++)t[c[a]]===void 0&&be(s,c[a],void 0)}function el(t,e={}){const{merge:n,key:r="id"}=e,i=gn(t);return s=>{if(!ht(s)||!ht(i))return i;const o=Ue(i,{[mn]:s},mn,n,r);return o===void 0?s:o}}var tl=t=>(typeof t.clear=="function"||(t.clear=()=>{let e;for(;e=t.key(0);)t.removeItem(e)}),t),nl=["clear","getItem","getAll","setItem","removeItem","key","getLength"],rl=t=>(t.withOptions=e=>nl.reduce((n,r)=>(typeof t[r]=="function"&&(n[r]=(...i)=>(i[t[r].length-1]=e,t[r](...i))),n),{get length(){return t.length},withOptions:n=>t.withOptions(n)}),t),il={domain:"Domain",expires:"Expires",path:"Path",secure:"Secure",httpOnly:"HttpOnly",maxAge:"Max-Age",sameSite:"SameSite"};function sl(t){if(!t)return"";const e=Object.entries(t).map(([n,r])=>{const i=il[n];if(i)return r instanceof Date?`${i}=${r.toUTCString()}`:typeof r=="boolean"?r?`${i}`:void 0:`${i}=${r}`}).filter(n=>!!n);return e.length!=0?`; ${e.join("; ")}`:""}function ol(t,e){var r;const n=(r=t.match(`(^|;)\\s*${e}\\s*=\\s*([^;]+)`))==null?void 0:r.pop();return n!=null?decodeURIComponent(n):null}var nt=rl(tl({_read:()=>document.cookie,_write:(t,e,n)=>{document.cookie=`${t}=${e}${sl(n)}`},getItem:(t,e)=>ol(nt._read(e),t),setItem:(t,e,n)=>{nt._write(t,e.replace(/[\u00c0-\uffff\&;]/g,r=>encodeURIComponent(r)),n)},removeItem:(t,e)=>{nt._write(t,"deleted",{...e,expires:new Date(0)})},key:(t,e)=>{let n=null,r=0;return nt._read(e).replace(/(?:^|;)\s*(.+?)\s*=\s*[^;]+/g,(i,s)=>(!n&&s&&r++===t&&(n=s),"")),n},getLength:t=>{let e=0;return nt._read(t).replace(/(?:^|;)\s*.+?\s*=\s*[^;]+/g,n=>(e+=n?1:0,"")),e},get length(){return this.getLength()}}));function ll(t,e={}){var h;const n=e.storage||globalThis.localStorage,r=e.name||`storage-${cs()}`;if(!n)return[t[0],t[1],null];const i=e.storageOptions,s=e.serialize||JSON.stringify.bind(JSON),o=e.deserialize||JSON.parse.bind(JSON),l=n.getItem(r,i),c=typeof t[0]=="function"?u=>{try{const p=o(u);t[1](()=>p)}catch{}}:u=>{try{const p=o(u);t[1](el(p))}catch{}};let a=!0;if(l instanceof Promise?l.then(u=>a&&u&&c(u)):l&&c(l),typeof((h=e.sync)==null?void 0:h[0])=="function"){const u=typeof t[0]=="function"?t[0]:()=>t[0];e.sync[0](p=>{p.key!==r||(p.url||globalThis.location.href)!==globalThis.location.href||p.newValue===s(ie(u))||c(p.newValue)})}return[t[0],typeof t[0]=="function"?u=>{var m;const p=t[1](u),g=u!=null?s(p):u;return(m=e.sync)==null||m[1](r,g),g!=null?n.setItem(r,g,i):n.removeItem(r,i),a=!1,p}:(...u)=>{var g;t[1](...u);const p=s(ie(()=>t[0]));(g=e.sync)==null||g[1](r,p),n.setItem(r,p,i),a=!1},l]}const wn=(t,e,n)=>ll(Q(t),{name:`.hopefox2000.v0.${e}`}),Kt=(t,e)=>{let n=w.empty();for(const r of e){const i=t+r;0<=i&&i<64&&Math.abs(ce(t)-ce(i))<=2&&(n=n.with(i))}return n},_e=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},cl=_e(t=>Kt(t,[-9,-8,-7,-1,1,7,8,9])),al=_e(t=>Kt(t,[-17,-15,-10,-6,6,10,15,17])),ul={white:_e(t=>Kt(t,[7,9])),black:_e(t=>Kt(t,[-7,-9]))},ft=t=>cl[t],dt=t=>al[t],Ze=(t,e)=>ul[t][e],bn=_e(t=>w.fromFile(ce(t)).without(t)),kn=_e(t=>w.fromRank(Te(t)).without(t)),yn=_e(t=>{const e=new w(134480385,2151686160),n=8*(Te(t)-ce(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),vn=_e(t=>{const e=new w(270549120,16909320),n=8*(Te(t)+ce(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),_n=(t,e,n)=>{let r=n.intersect(e),i=r.bswap64();return r=r.minus64(t),i=i.minus64(t.bswap64()),r.xor(i.bswap64()).intersect(e)},hl=(t,e)=>_n(w.fromSquare(t),bn[t],e),fl=(t,e)=>{const n=kn[t];let r=e.intersect(n),i=r.rbit64();return r=r.minus64(w.fromSquare(t)),i=i.minus64(w.fromSquare(63-t)),r.xor(i.rbit64()).intersect(n)},Me=(t,e)=>{const n=w.fromSquare(t);return _n(n,yn[t],e).xor(_n(n,vn[t],e))},Oe=(t,e)=>hl(t,e).xor(fl(t,e)),Lt=(t,e)=>Me(t,e).xor(Oe(t,e)),dl=(t,e,n)=>{switch(t.role){case"pawn":return Ze(t.color,e);case"knight":return dt(e);case"bishop":return Me(e,n);case"rook":return Oe(e,n);case"queen":return Lt(e,n);case"king":return ft(e)}},Cn=(t,e)=>{const n=w.fromSquare(e);return kn[t].intersects(n)?kn[t].with(t):vn[t].intersects(n)?vn[t].with(t):yn[t].intersects(n)?yn[t].with(t):bn[t].intersects(n)?bn[t].with(t):w.empty()},Qe=(t,e)=>Cn(t,e).intersect(w.full().shl64(t).xor(w.full().shl64(e))).withoutFirst();var ye;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(ye||(ye={}));let Fe=class extends Error{};const pl=(t,e,n,r)=>n[e].intersect(Oe(t,r).intersect(n.rooksAndQueens()).union(Me(t,r).intersect(n.bishopsAndQueens())).union(dt(t).intersect(n.knight)).union(ft(t).intersect(n.king)).union(Ze(z(e),t).intersect(n.pawn)));let Pr=class st{constructor(){v(this,"castlingRights");v(this,"rook");v(this,"path")}static default(){const e=new st;return e.castlingRights=w.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new w(14,0),h:new w(96,0)},black:{a:new w(0,234881024),h:new w(0,1610612736)}},e}static empty(){const e=new st;return e.castlingRights=w.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:w.empty(),h:w.empty()},black:{a:w.empty(),h:w.empty()}},e}clone(){const e=new st;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,r,i){const s=Xn(e,n),o=er(e,n);this.castlingRights=this.castlingRights.with(i),this.rook[e][n]=i,this.path[e][n]=Qe(i,o).with(o).union(Qe(r,s).with(s)).without(r).without(i)}static fromSetup(e){const n=st.empty(),r=e.castlingRights.intersect(e.board.rook);for(const i of Je){const s=w.backrank(i),o=e.board.kingOf(i);if(!E(o)||!s.has(o))continue;const l=r.intersect(e.board[i]).intersect(s),c=l.first();E(c)&&c<o&&n.add(i,"a",o,c);const a=l.last();E(a)&&o<a&&n.add(i,"h",o,a)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of Je)for(const r of Io)this.rook[n][r]===e&&(this.rook[n][r]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(w.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}},gl=class{constructor(e){v(this,"rules");v(this,"board");v(this,"pockets");v(this,"turn");v(this,"castles");v(this,"epSquare");v(this,"remainingChecks");v(this,"halfmoves");v(this,"fullmoves");this.rules=e}reset(){this.board=Ei.default(),this.pockets=void 0,this.turn="white",this.castles=Pr.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=w.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Pr.fromSetup(e),this.epSquare=wl(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,r){return pl(e,n,this.board,r)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[z(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!E(n))return{king:n,blockers:w.empty(),checkers:w.empty(),variantEnd:e,mustCapture:!1};const r=Oe(n,w.empty()).intersect(this.board.rooksAndQueens()).union(Me(n,w.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[z(this.turn)]);let i=w.empty();for(const o of r){const l=Qe(n,o).intersect(this.board.occupied);l.moreThanOne()||(i=i.union(l))}const s=this.kingAttackers(n,z(this.turn),this.board.occupied);return{king:n,blockers:i,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var n,r;const e=new this.constructor;return e.board=this.board.clone(),e.pockets=(n=this.pockets)==null?void 0:n.clone(),e.turn=this.turn,e.castles=this.castles.clone(),e.epSquare=this.epSquare,e.remainingChecks=(r=this.remainingChecks)==null?void 0:r.clone(),e.halfmoves=this.halfmoves,e.fullmoves=this.fullmoves,e}validate(){if(this.board.occupied.isEmpty())return C.err(new Fe(ye.Empty));if(this.board.king.size()!==2)return C.err(new Fe(ye.Kings));if(!E(this.board.kingOf(this.turn)))return C.err(new Fe(ye.Kings));const e=this.board.kingOf(z(this.turn));return E(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?C.err(new Fe(ye.OppositeCheck)):w.backranks().intersects(this.board.pawn)?C.err(new Fe(ye.PawnsOnBackrank)):C.ok(void 0):C.err(new Fe(ye.Kings))}dropDests(e){return w.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return w.empty();const r=this.board.get(e);if(!r||r.color!==this.turn)return w.empty();let i,s;if(r.role==="pawn"){i=Ze(this.turn,e).intersect(this.board[z(this.turn)]);const o=this.turn==="white"?8:-8,l=e+o;if(0<=l&&l<64&&!this.board.occupied.has(l)){i=i.with(l);const c=this.turn==="white"?e<16:e>=48,a=l+o;c&&!this.board.occupied.has(a)&&(i=i.with(a))}E(this.epSquare)&&Rr(this,e,n)&&(s=w.fromSquare(this.epSquare))}else r.role==="bishop"?i=Me(e,this.board.occupied):r.role==="knight"?i=dt(e):r.role==="rook"?i=Oe(e,this.board.occupied):r.role==="queen"?i=Lt(e,this.board.occupied):i=ft(e);if(i=i.diff(this.board[this.turn]),E(n.king)){if(r.role==="king"){const o=this.board.occupied.without(e);for(const l of i)this.kingAttackers(l,z(this.turn),o).nonEmpty()&&(i=i.without(l));return i.union(_t(this,"a",n)).union(_t(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!E(o))return w.empty();i=i.intersect(Qe(o,n.king).with(o))}n.blockers.has(e)&&(i=i.intersect(Cn(e,n.king)))}return s&&(i=i.union(s)),i}pseudo_dests(e,n){if(n=n||this.ctx(),n.variantEnd)return w.empty();const r=this.board.get(e);if(!r||r.color!==this.turn)return w.empty();let i,s;if(r.role==="pawn"){i=Ze(this.turn,e);const o=this.turn==="white"?8:-8,l=e+o;if(0<=l&&l<64&&!this.board.occupied.has(l)){i=i.with(l);const c=this.turn==="white"?e<16:e>=48,a=l+o;c&&!this.board.occupied.has(a)&&(i=i.with(a))}E(this.epSquare)&&Rr(this,e,n)&&(s=w.fromSquare(this.epSquare))}else r.role==="bishop"?i=Me(e,this.board.occupied):r.role==="knight"?i=dt(e):r.role==="rook"?i=Oe(e,this.board.occupied):r.role==="queen"?i=Lt(e,this.board.occupied):i=ft(e);if(E(n.king)){if(r.role==="king"){this.board.occupied.without(e);for(const o of i);return i.union(_t(this,"a",n)).union(_t(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!E(o))return w.empty();i=i.intersect(Qe(o,n.king).with(o))}n.blockers.has(e)&&(i=i.intersect(Cn(e,n.king)))}return s&&(i=i.union(s)),i}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[z(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(w.darkSquares())||!this.board.bishop.intersects(w.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)==null?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:bl(this),remainingChecks:(n=this.remainingChecks)==null?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Je.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&w.backranks().has(e.to)))return!1;const r=this.dests(e.from,n);return r.has(e.to)||r.has(kl(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return E(e)&&this.kingAttackers(e,z(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:z(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const r of this.board[this.turn])n.set(r,this.dests(r,e));return n}play(e){const n=this.turn,r=this.epSquare,i=$i(this,e);this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=z(n);{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===r&&(o=this.board.take(e.to+(n==="white"?-8:8)));const l=e.from-e.to;Math.abs(l)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(i){const l=this.castles.rook[n][i];if(E(l)){const c=this.board.take(l);this.board.set(Xn(n,i),s),c&&this.board.set(er(n,i),c)}}this.castles.discardColor(n)}if(!i){const l=this.board.set(e.to,s)||o;l&&this.playCaptureAt(e.to,l)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}},ml=class extends gl{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(r=>n)}clone(){return super.clone()}};const wl=(t,e)=>{if(!E(e))return;const n=t.turn==="white"?5:2,r=t.turn==="white"?8:-8;if(Te(e)!==n||t.board.occupied.has(e+r))return;const i=e-r;if(!(!t.board.pawn.has(i)||!t.board[z(t.turn)].has(i)))return e},bl=t=>{if(!E(t.epSquare))return;const e=t.ctx(),r=t.board.pieces(t.turn,"pawn").intersect(Ze(z(t.turn),t.epSquare));for(const i of r)if(t.dests(i,e).has(t.epSquare))return t.epSquare},Rr=(t,e,n)=>{if(!E(t.epSquare)||!Ze(t.turn,e).has(t.epSquare))return!1;if(!E(n.king))return!0;const r=t.turn==="white"?8:-8,i=t.epSquare-r;return t.kingAttackers(n.king,z(t.turn),t.board.occupied.toggle(e).toggle(i).with(t.epSquare)).without(i).isEmpty()},_t=(t,e,n)=>{if(!E(n.king)||n.checkers.nonEmpty())return w.empty();const r=t.castles.rook[t.turn][e];if(!E(r)||t.castles.path[t.turn][e].intersects(t.board.occupied))return w.empty();const i=Xn(t.turn,e),s=Qe(n.king,i),o=t.board.occupied.without(n.king);for(const a of s)if(t.kingAttackers(a,z(t.turn),o).nonEmpty())return w.empty();const l=er(t.turn,e),c=t.board.occupied.toggle(n.king).toggle(r).toggle(l);return t.kingAttackers(i,z(t.turn),c).nonEmpty()?w.empty():w.fromSquare(r)},$i=(t,e)=>{const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},kl=(t,e)=>{const n=$i(t,e);if(!n)return e;const r=t.castles.rook[t.turn][n];return{from:e.from,to:E(r)?r:e.to}},yl=(t,e)=>{let n="";{const r=t.board.getRole(e.from);if(!r)return"--";if(r==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))n=e.to>e.from?"O-O":"O-O-O";else{const i=t.board.occupied.has(e.to)||r==="pawn"&&ce(e.from)!==ce(e.to);if(r!=="pawn"){n=Er(r).toUpperCase();let s;if(r==="king"?s=ft(e.to).intersect(t.board.king):r==="queen"?s=Lt(e.to,t.board.occupied).intersect(t.board.queen):r==="rook"?s=Oe(e.to,t.board.occupied).intersect(t.board.rook):r==="bishop"?s=Me(e.to,t.board.occupied).intersect(t.board.bishop):s=dt(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const l of s)t.dests(l,o).has(e.to)||(s=s.without(l));if(s.nonEmpty()){let l=!1,c=s.intersects(w.fromRank(Te(e.from)));s.intersects(w.fromFile(ce(e.from)))?l=!0:c=!0,c&&(n+=fn[ce(e.from)]),l&&(n+=Si[Te(e.from)])}}}else i&&(n=fn[ce(e.from)]);i&&(n+="x"),n+=Fo(e.to),e.promotion&&(n+="="+Er(e.promotion).toUpperCase())}}return n},vl=(t,e)=>{var r;const n=yl(t,e);return t.play(e),(r=t.outcome())!=null&&r.winner?n+"#":t.isCheck()?n+"+":n},_l=(t,e)=>vl(t.clone(),e);function Cl(t,e){let n={};for(let r of Object.keys(t))Bt(r).length>0&&t[r]===e.from?n[r]=e.to:n[r]=t[r];return n}function Sl(t){return[...w.full()].flatMap(e=>[...El(t,e)].flatMap(n=>{var s;let r=[];if((n<8||n>=56)&&((s=t.board.get(e))==null?void 0:s.role)==="pawn")return r.push({from:e,to:n,promotion:"queen"}),r.push({from:e,to:n,promotion:"knight"}),r;let i={from:e,to:n};return r.push(i),r})).map(e=>{let n=t.clone();return n.play(e),[e,n]})}function El(t,e){return t.dests(e)}function rt(t){return Sl(t.pos).map(([e,n])=>({parent:[t,e],pos:n,ctx:Cl(t.ctx,e)}))}function Al(t){let e=t.trim().split(`
`),n={depth:-1,rule:"*",children:[],p_m:[],m:[],n:[],long:!1,no_c:!1};const r=[n];for(let i=0;i<e.length;i++){let s=e[i],o=s.trim();if(!o)continue;const l=s.search(/\S/);let c=!1,a=!1;o[o.length-1]==="5"&&(a=!0,o=o.slice(0,-1).trim()),o[o.length-1]==="P"&&(c=!0,o=o.slice(0,-1).trim());let h={depth:l,rule:o,children:[],p_m:[],m:[],long:a,no_c:c};for(;r.length>l+1;)r.pop();r[r.length-1].children.push(h),r.push(h)}return n}function xi(t){let e=[],n=t;for(;n.parent;){let r=_l(n.parent[0].pos,n.parent[1]);e.unshift(r),n=n.parent[0]}return e.join(" ")}function Pi(t){let e="",n=" ".repeat(t.depth+1),r=t.long?50:1,i=t.no_c?t.p_m:t.m,s=i.slice(0,r).map(xi).join(", ");return i.length>1&&(s+=".."+i.length),e+=" "+t.rule+" <"+(s??"?")+`>
`,t.children.map((o,l)=>{l===t.children.length-1?e+=n+"└─":l===0?e+=n+"├─":e+=n+"│ ",e+=Pi(o)}).join(""),e}function He(t,e){let n={};for(let r of Object.keys(t))if(!e[r])n[r]=t[r];else{if(t[r]!==e[r])return;n[r]=t[r]}for(let r of Object.keys(e))if(!t[r])n[r]=e[r];else{if(t[r]!==e[r])return;n[r]=e[r]}for(let r of Object.keys(n))for(let i of Object.keys(n))if(r!==i&&r[0]===i[0]&&n[r]===n[i])return;return n}function Bt(t){switch(t[0]){case"Q":case"q":return["queen"];case"R":case"r":return["rook"];case"B":case"b":return["bishop"];case"N":case"n":return["knight"];case"K":case"k":return["king"];case"P":case"p":return["pawn"];case"M":case"m":return["knight","bishop"];case"J":case"j":return["rook","queen"];case"U":case"u":return["knight","bishop","rook","queen"];case"L":case"l":return["queen","rook","bishop","knight","king"];case"G":case"g":return["queen","rook","bishop","knight","pawn"];case"A":case"a":return["pawn","king","queen","rook","bishop","knight"];default:return[]}}function Sn(t){return t.toLowerCase()===t}function $l(t,e){if(e.ctx[t])return w.fromSquare(e.ctx[t])}function En(t,e,n){let r=$l(t,n);if(r)return r;let i=Sn(t)?e:z(e),s=Bt(t);return An(n.pos,i,s)}function An(t,e,n){return n.reduce((r,i)=>r.union(t.board[i]),w.empty()).intersect(t.board[e])}function Mr(t,e){let n=t.board.get(e);return n?dl(n,e,t.board.occupied):w.empty()}function it(t,e,n){return t.split(",").reduce((r,i)=>Ri(i.trim(),r[0],n),[e,[]])}function Ri(t,e,n){var l;if(t===".")return[e,[]];if(t[0]==="!"){let[c,a]=Ri(t.slice(1),e,n);return[a,c]}let r=[],i=[];if(t[0]==="="){let c=(l=t.slice(1).match(/^([pqrnbkPQRNBKmjuaglMJUAGL]'?)/))==null?void 0:l[0];for(let a of e){if(a.ctx[c]&&a.parent[1].to===a.ctx[c]){r.push(a);continue}i.push(a)}return[r,i]}let[s,...o]=t.split(" ");for(let c of e){let a=xl(s,c,n);if(!a){i.push(c);continue}let h=!1;for(let[u,p]of a){let g=o.reduce((m,f)=>m.flatMap(b=>Pl(f,b,u,n)??[]),[p]);!g||g.length===0||(h=!0,r.push(...g))}h||i.push(c)}return[r,i]}function xl(t,e,n){var l;let r=(l=t.match(/^([pqrnbkPQRNBKmjuaglMJUAGL]'?)/))==null?void 0:l[0];if(!r)return;let i=[],s=En(r,n,e),o=En(r,n,e.parent[0]);s.has(e.parent[1].to)&&(o.has(e.parent[1].from)?s=s.set(e.parent[1].from,!0):s=s.set(e.parent[1].to,!1));for(let c of s){let a=He(e.ctx,{[r]:c});a&&i.push([r,{pos:e.pos,ctx:a,parent:e.parent}])}return i}function Pl(t,e,n,r){var h;let i=t.match(/\=([a-h][1-8])$/),s=t.match(/\=([pqrnbkPQRNBKmjuaglMJUAGL]'?)$/),o=t.match(/\+([a-h][1-8])$/),l=t.match(/\+([pqrnbkPQRNBKmjuaglMJUAGL]'?)$/),c=(h=t.match(/_/))==null?void 0:h[0];if(t.match(/#/)&&!e.pos.isCheckmate())return;let a=[];if(c){let u=n,p=Sn(u)?r:z(r),g=Bt(u),m=e.pos,f=An(m,p,g);e.parent[1].to===16&&console.log("here");for(let b of f){if(!m.board.get(b))continue;let y=He(e.ctx,{[n]:b});y&&a.push({pos:e.pos,ctx:y,parent:e.parent})}}if(s){let[u,p]=s,g=e.parent[1].to,m=Sn(p)?r:z(r),f=Bt(p);if(!An(e.parent[0].pos,m,f).has(g))return;let b=He(e.ctx,{[n]:g,[p]:g});if(!b)return;b[n]=e.parent[1].to,a.push({pos:e.pos,ctx:b,parent:e.parent})}if(i){let[u,p]=i,g=e.parent[1].to,m=He(e.ctx,{[n]:e.parent[1].from,[p]:g});if(!m)return;m[n]=e.parent[1].to,a.push({pos:e.pos,ctx:m,parent:e.parent})}if(o){let[u,p]=o;for(let g of Mr(e.pos,e.ctx[n])){let m=He(e.ctx,{[p]:g});m&&a.push({pos:e.pos,ctx:m,parent:e.parent})}}if(l){let[u,p]=l,g=En(p,r,e);for(let m of Mr(e.pos,e.ctx[n]).intersect(g)){let f=He(e.ctx,{[p]:m});f&&a.push({pos:e.pos,ctx:f,parent:e.parent})}}return a}function Rl(t,e){const n=new Map;return t.forEach(r=>{const i=e(r),s=n.get(i);s?s.push(r):n.set(i,[r])}),n}function Ct(t){return[...Rl(t,e=>`${e.parent[0].parent[1].from}${e.parent[0].parent[1].to}`).values()]}function Mi(t,e,n){let r=[],i=[],s=[],o=[];if(t.rule[0]==="C"){let l=[],c=[],a=Ct(e);for(let h of a)for(let u of h){let p=rt(u),[g,m]=it(t.rule.slice(2),p,n);m.length===0?l.push(u):c.push(u)}t.p_m=c,t.m=l,s=[],o=l,s=[],i=c,r=l}else if(t.rule[0]==="O"){let l=[],c=[],a=Ct(e);for(let h of a)for(let u of h){let p=rt(u),[g,m]=it(t.rule.slice(2),p,n);g.length>0?l.push(u):c.push(u)}t.p_m=c,t.m=l,s=[],o=l,s=[],i=c,r=l}else if(t.rule[0]==="A"){let l=[],c=[],a=Ct(e);for(let h of a){let u=!1;for(let p of h){let g=rt(p),[m,f]=it(t.rule.slice(2),g,n);if(f.length===0){u=!0;break}}u?l.push(...h):c.push(...h)}return t.p_m=c,t.m=l,{saa:l,sbb:c}}else if(t.rule[0]==="E"){let l=[],c=[],a=Ct(e);for(let h of a){let u=!0;for(let p of h){let g=rt(p),[m,f]=it(t.rule.slice(2),g,n);if(m.length===0){u=!1;break}}u?l.push(...h):c.push(...h)}return t.p_m=c,t.m=l,{saa:l,sbb:c}}else if(t.rule==="*"){let l=e.flatMap(rt);s=[],o=l,t.p_m=l,t.m=s,s=[],i=l,r=l}else[r,i]=it(t.rule,e,n),t.p_m=r,s=[],o=r;if(t.children.length===0)return t.m=r,{saa:r,sbb:i};for(let l=0;l<t.children.length;l++){let c=t.children[l],a=Mi(c,o,n);if(o=a.sbb,s.push(...a.saa),o.length===0)break}return t.m=s,o.length!==0?{saa:s,sbb:[...o,...i]}:{saa:s,sbb:i}}function Oi(t,e){let n=ml.fromSetup(Go(t).unwrap()).unwrap(),r=Al(e);return r.children.length===0||Mi(r,[{pos:n,ctx:{}}],n.turn),r}function Ml(t,e){let n=Oi(t,e),r=n.children[0].m[0],i=n.children[0].children;if(i[i.length-1].m.length===0)return xi(r)}const Ni=t=>{let e=Object.keys(t.has_tags).length,n={...t.has_tags};return e>0&&(n.has_tag=!0,e===1?n.single_tag=!0:n.many_tags=!0),n[`id_${t.id}`]=!0,n},Ol=t=>{let e={...t.tags,...Ni(t)};return t.rules&&[...new Set(t.rules.flatMap(Nl))].forEach(r=>e[r]=!0),e},Nl=t=>t.solve===void 0?(t.rule.rule.includes("."),["solved",`solved_${t.rule.name}`]):t.solve>=0?["failed",`failed_${t.rule.name}`]:[""];class Ti{unwrap(e,n){const r=this._chain(i=>S.ok(e?e(i):i),i=>n?S.ok(n(i)):S.err(i));if(r.isErr)throw r.error;return r.value}map(e,n){return this._chain(r=>S.ok(e(r)),r=>S.err(n?n(r):r))}chain(e,n){return this._chain(e,n||(r=>S.err(r)))}}class Tl extends Ti{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}}class Dl extends Ti{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}}var S;(function(t){t.ok=function(e){return new Tl(e)},t.err=function(e){return new Dl(e||new Error)},t.all=function(e){if(Array.isArray(e)){const i=[];for(let s=0;s<e.length;s++){const o=e[s];if(o.isErr)return o;i.push(o.value)}return t.ok(i)}const n={},r=Object.keys(e);for(let i=0;i<r.length;i++){const s=e[r[i]];if(s.isErr)return s;n[r[i]]=s.value}return t.ok(n)}})(S||(S={}));const Or=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),$n=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Nr=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,$n(t));class d{constructor(e,n){this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new d(0,1<<e-32):new d(1<<e,0)}static fromRank(e){return new d(255,0).shl64(8*e)}static fromFile(e){return new d(16843009<<e,16843009<<e)}static empty(){return new d(0,0)}static full(){return new d(4294967295,4294967295)}static corners(){return new d(129,2164260864)}static center(){return new d(402653184,24)}static backranks(){return new d(255,4278190080)}static backrank(e){return e==="white"?new d(255,0):new d(0,4278190080)}static lightSquares(){return new d(1437226410,1437226410)}static darkSquares(){return new d(2857740885,2857740885)}complement(){return new d(~this.lo,~this.hi)}xor(e){return new d(this.lo^e.lo,this.hi^e.hi)}union(e){return new d(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new d(this.lo&e.lo,this.hi&e.hi)}diff(e){return new d(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?d.empty():e>=32?new d(this.hi>>>e-32,0):e>0?new d(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?d.empty():e>=32?new d(0,this.lo<<e-32):e>0?new d(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new d($n(this.hi),$n(this.lo))}rbit64(){return new d(Nr(this.hi),Nr(this.lo))}minus64(e){const n=this.lo-e.lo,r=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new d(n,this.hi-(e.hi+r))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return Or(this.lo)+Or(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new d(this.lo,this.hi|1<<e-32):new d(this.lo|1<<e,this.hi)}without(e){return e>=32?new d(this.lo,this.hi&~(1<<e-32)):new d(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new d(this.lo,this.hi^1<<e-32):new d(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new d(this.lo&this.lo-1,this.hi):new d(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const r=31-Math.clz32(e&-e);e^=1<<r,yield r}for(;n!==0;){const r=31-Math.clz32(n&-n);n^=1<<r,yield 32+r}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const r=31-Math.clz32(n);n^=1<<r,yield 32+r}for(;e!==0;){const r=31-Math.clz32(e);e^=1<<r,yield r}}}const Ft=["a","b","c","d","e","f","g","h"],Di=["1","2","3","4","5","6","7","8"],De=["white","black"],le=["pawn","knight","bishop","rook","queen","king"],zl=["a","h"],qt=t=>"role"in t;class Ye{constructor(){}static default(){const e=new Ye;return e.reset(),e}reset(){this.occupied=new d(65535,4294901760),this.promoted=d.empty(),this.white=new d(65535,0),this.black=new d(0,4294901760),this.pawn=new d(65280,16711680),this.knight=new d(66,1107296256),this.bishop=new d(36,603979776),this.rook=new d(129,2164260864),this.queen=new d(8,134217728),this.king=new d(16,268435456)}static empty(){const e=new Ye;return e.clear(),e}clear(){this.occupied=d.empty(),this.promoted=d.empty();for(const e of De)this[e]=d.empty();for(const e of le)this[e]=d.empty()}clone(){const e=new Ye;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of De)e[n]=this[n];for(const n of le)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of le)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const r=this.getRole(e),i=this.promoted.has(e);return{color:n,role:r,promoted:i}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const r=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),r}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}class he{constructor(){}static empty(){const e=new he;for(const n of le)e[n]=0;return e}static fromBoard(e,n){const r=new he;for(const i of le)r[i]=e.pieces(n,i).size();return r}clone(){const e=new he;for(const n of le)e[n]=this[n];return e}equals(e){return le.every(n=>this[n]===e[n])}add(e){const n=new he;for(const r of le)n[r]=this[r]+e[r];return n}subtract(e){const n=new he;for(const r of le)n[r]=this[r]-e[r];return n}nonEmpty(){return le.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class Pe{constructor(e,n){this.white=e,this.black=n}static empty(){return new Pe(he.empty(),he.empty())}static fromBoard(e){return new Pe(he.fromBoard(e,"white"),he.fromBoard(e,"black"))}clone(){return new Pe(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new Pe(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new Pe(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class pt{constructor(e,n){this.white=e,this.black=n}static default(){return new pt(3,3)}clone(){return new pt(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}const _=t=>t!==void 0,W=t=>t==="white"?"black":"white",ze=t=>t>>3,ee=t=>t&7,xn=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,lt=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Pn(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ct(t){if(t.length===2)return xn(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const gt=t=>Ft[ee(t)]+Di[ze(t)],zi=t=>{if(t[1]==="@"&&t.length===4){const e=Pn(t[0]),n=ct(t.slice(2));if(e&&_(n))return{role:e,to:n}}else if(t.length===4||t.length===5){const e=ct(t.slice(0,2)),n=ct(t.slice(2,4));let r;if(t.length===5&&(r=Pn(t[4]),!r))return;if(_(e)&&_(n))return{from:e,to:n,promotion:r}}},tr=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,nr=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,Il="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Kl=Il+" w KQkq -",Ii=Kl+" 0 1";var K;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(K||(K={}));class q extends Error{}const Ll=(t,e,n)=>{let r=t.indexOf(e);for(;n-- >0&&r!==-1;)r=t.indexOf(e,r+e.length);return r},Ve=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,Ki=t=>{const e=Pn(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},nn=t=>{const e=Ye.empty();let n=7,r=0;for(let i=0;i<t.length;i++){const s=t[i];if(s==="/"&&r===8)r=0,n--;else{const o=parseInt(s,10);if(o>0)r+=o;else{if(r>=8||n<0)return S.err(new q(K.Board));const l=r+n*8,c=Ki(s);if(!c)return S.err(new q(K.Board));t[i+1]==="~"&&(c.promoted=!0,i++),e.set(l,c),r++}}}return n!==0||r!==8?S.err(new q(K.Board)):S.ok(e)},Tr=t=>{if(t.length>64)return S.err(new q(K.Pockets));const e=Pe.empty();for(const n of t){const r=Ki(n);if(!r)return S.err(new q(K.Pockets));e[r.color][r.role]++}return S.ok(e)},Bl=(t,e)=>{let n=d.empty();if(e==="-")return S.ok(n);for(const r of e){const i=r.toLowerCase(),s=r===i?"black":"white",o=s==="white"?0:7;if("a"<=i&&i<="h")n=n.with(xn(i.charCodeAt(0)-97,o));else if(i==="k"||i==="q"){const l=t[s].intersect(d.backrank(s)).intersect(t.rook.union(t.king)),c=i==="k"?l.last():l.first();n=n.with(_(c)&&t.rook.has(c)?c:xn(i==="k"?7:0,o))}else return S.err(new q(K.Castling))}return De.some(r=>d.backrank(r).intersect(n).size()>2)?S.err(new q(K.Castling)):S.ok(n)},Dr=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=Ve(e[1]),r=Ve(e[2]);return!_(n)||n>3||!_(r)||r>3?S.err(new q(K.RemainingChecks)):S.ok(new pt(3-n,3-r))}else if(e.length===2){const n=Ve(e[0]),r=Ve(e[1]);return!_(n)||n>3||!_(r)||r>3?S.err(new q(K.RemainingChecks)):S.ok(new pt(n,r))}else return S.err(new q(K.RemainingChecks))},Rn=t=>{const e=t.split(/[\s_]+/),n=e.shift();let r,i=S.ok(void 0);if(n.endsWith("]")){const l=n.indexOf("[");if(l===-1)return S.err(new q(K.Fen));r=nn(n.slice(0,l)),i=Tr(n.slice(l+1,-1))}else{const l=Ll(n,"/",7);l===-1?r=nn(n):(r=nn(n.slice(0,l)),i=Tr(n.slice(l+1)))}let s;const o=e.shift();if(!_(o)||o==="w")s="white";else if(o==="b")s="black";else return S.err(new q(K.Turn));return r.chain(l=>{const c=e.shift(),a=_(c)?Bl(l,c):S.ok(d.empty()),h=e.shift();let u;if(_(h)&&h!=="-"&&(u=ct(h),!_(u)))return S.err(new q(K.EpSquare));let p=e.shift(),g;_(p)&&p.includes("+")&&(g=Dr(p),p=e.shift());const m=_(p)?Ve(p):0;if(!_(m))return S.err(new q(K.Halfmoves));const f=e.shift(),b=_(f)?Ve(f):1;if(!_(b))return S.err(new q(K.Fullmoves));const k=e.shift();let y=S.ok(void 0);if(_(k)){if(_(g))return S.err(new q(K.RemainingChecks));y=Dr(k)}else _(g)&&(y=g);return e.length>0?S.err(new q(K.Fen)):i.chain($=>a.chain(P=>y.map(x=>({board:l,pockets:$,turn:s,castlingRights:P,remainingChecks:x,epSquare:u,halfmoves:m,fullmoves:Math.max(1,b)}))))})},Fl=t=>{let e=lt(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},ql=t=>{let e="",n=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const s=i+r*8,o=t.get(s);o?(n>0&&(e+=n,n=0),e+=Fl(o)):n++,i===7&&(n>0&&(e+=n,n=0),r!==0&&(e+="/"))}return e},zr=t=>le.map(e=>lt(e).repeat(t[e])).join(""),jl=t=>zr(t.white).toUpperCase()+zr(t.black),Wl=(t,e)=>{let n="";for(const r of De){const i=d.backrank(r);let s=t.kingOf(r);_(s)&&!i.has(s)&&(s=void 0);const o=t.pieces(r,"rook").intersect(i);for(const l of e.intersect(i).reversed())if(l===o.first()&&_(s)&&l<s)n+=r==="white"?"Q":"q";else if(l===o.last()&&_(s)&&s<l)n+=r==="white"?"K":"k";else{const c=Ft[ee(l)];n+=r==="white"?c.toUpperCase():c}}return n||"-"},Ul=t=>`${t.white}+${t.black}`,Li=(t,e)=>[ql(t.board)+(t.pockets?`[${jl(t.pockets)}]`:""),t.turn[0],Wl(t.board,t.castlingRights),_(t.epSquare)?gt(t.epSquare):"-",...t.remainingChecks?[Ul(t.remainingChecks)]:[],Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))].join(" "),jt=(t,e)=>{let n=d.empty();for(const r of e){const i=t+r;0<=i&&i<64&&Math.abs(ee(t)-ee(i))<=2&&(n=n.with(i))}return n},Ce=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},Hl=Ce(t=>jt(t,[-9,-8,-7,-1,1,7,8,9])),Gl=Ce(t=>jt(t,[-17,-15,-10,-6,6,10,15,17])),Vl={white:Ce(t=>jt(t,[7,9])),black:Ce(t=>jt(t,[-7,-9]))},rr=t=>Hl[t],ir=t=>Gl[t],Vt=(t,e)=>Vl[t][e],Mn=Ce(t=>d.fromFile(ee(t)).without(t)),On=Ce(t=>d.fromRank(ze(t)).without(t)),Nn=Ce(t=>{const e=new d(134480385,2151686160),n=8*(ze(t)-ee(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Tn=Ce(t=>{const e=new d(270549120,16909320),n=8*(ze(t)+ee(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),Dn=(t,e,n)=>{let r=n.intersect(e),i=r.bswap64();return r=r.minus64(t),i=i.minus64(t.bswap64()),r.xor(i.bswap64()).intersect(e)},Ql=(t,e)=>Dn(d.fromSquare(t),Mn[t],e),Yl=(t,e)=>{const n=On[t];let r=e.intersect(n),i=r.rbit64();return r=r.minus64(d.fromSquare(t)),i=i.minus64(d.fromSquare(63-t)),r.xor(i.rbit64()).intersect(n)},mt=(t,e)=>{const n=d.fromSquare(t);return Dn(n,Nn[t],e).xor(Dn(n,Tn[t],e))},wt=(t,e)=>Ql(t,e).xor(Yl(t,e)),Bi=(t,e)=>mt(t,e).xor(wt(t,e)),Fi=(t,e)=>{const n=d.fromSquare(e);return On[t].intersects(n)?On[t].with(t):Tn[t].intersects(n)?Tn[t].with(t):Nn[t].intersects(n)?Nn[t].with(t):Mn[t].intersects(n)?Mn[t].with(t):d.empty()},bt=(t,e)=>Fi(t,e).intersect(d.full().shl64(t).xor(d.full().shl64(e))).withoutFirst();var ve;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(ve||(ve={}));class qe extends Error{}const Jl=(t,e,n,r)=>n[e].intersect(wt(t,r).intersect(n.rooksAndQueens()).union(mt(t,r).intersect(n.bishopsAndQueens())).union(ir(t).intersect(n.knight)).union(rr(t).intersect(n.king)).union(Vt(W(e),t).intersect(n.pawn)));class Re{constructor(){}static default(){const e=new Re;return e.castlingRights=d.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new d(14,0),h:new d(96,0)},black:{a:new d(0,234881024),h:new d(0,1610612736)}},e}static empty(){const e=new Re;return e.castlingRights=d.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:d.empty(),h:d.empty()},black:{a:d.empty(),h:d.empty()}},e}clone(){const e=new Re;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,r,i){const s=tr(e,n),o=nr(e,n);this.castlingRights=this.castlingRights.with(i),this.rook[e][n]=i,this.path[e][n]=bt(i,o).with(o).union(bt(r,s).with(s)).without(r).without(i)}static fromSetup(e){const n=Re.empty(),r=e.castlingRights.intersect(e.board.rook);for(const i of De){const s=d.backrank(i),o=e.board.kingOf(i);if(!_(o)||!s.has(o))continue;const l=r.intersect(e.board[i]).intersect(s),c=l.first();_(c)&&c<o&&n.add(i,"a",o,c);const a=l.last();_(a)&&o<a&&n.add(i,"h",o,a)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of De)for(const r of zl)this.rook[n][r]===e&&(this.rook[n][r]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(d.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class Zl{constructor(e){this.rules=e}reset(){this.board=Ye.default(),this.pockets=void 0,this.turn="white",this.castles=Re.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=d.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=Re.fromSetup(e),this.epSquare=Xl(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,r){return Jl(e,n,this.board,r)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[W(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!_(n))return{king:n,blockers:d.empty(),checkers:d.empty(),variantEnd:e,mustCapture:!1};const r=wt(n,d.empty()).intersect(this.board.rooksAndQueens()).union(mt(n,d.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[W(this.turn)]);let i=d.empty();for(const o of r){const l=bt(n,o).intersect(this.board.occupied);l.moreThanOne()||(i=i.union(l))}const s=this.kingAttackers(n,W(this.turn),this.board.occupied);return{king:n,blockers:i,checkers:s,variantEnd:e,mustCapture:!1}}clone(){var e,n;const r=new this.constructor;return r.board=this.board.clone(),r.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),r.turn=this.turn,r.castles=this.castles.clone(),r.epSquare=this.epSquare,r.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),r.halfmoves=this.halfmoves,r.fullmoves=this.fullmoves,r}validate(){if(this.board.occupied.isEmpty())return S.err(new qe(ve.Empty));if(this.board.king.size()!==2)return S.err(new qe(ve.Kings));if(!_(this.board.kingOf(this.turn)))return S.err(new qe(ve.Kings));const e=this.board.kingOf(W(this.turn));return _(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?S.err(new qe(ve.OppositeCheck)):d.backranks().intersects(this.board.pawn)?S.err(new qe(ve.PawnsOnBackrank)):S.ok(void 0):S.err(new qe(ve.Kings))}dropDests(e){return d.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return d.empty();const r=this.board.get(e);if(!r||r.color!==this.turn)return d.empty();let i,s;if(r.role==="pawn"){i=Vt(this.turn,e).intersect(this.board[W(this.turn)]);const o=this.turn==="white"?8:-8,l=e+o;if(0<=l&&l<64&&!this.board.occupied.has(l)){i=i.with(l);const c=this.turn==="white"?e<16:e>=48,a=l+o;c&&!this.board.occupied.has(a)&&(i=i.with(a))}_(this.epSquare)&&tc(this,e,n)&&(s=d.fromSquare(this.epSquare))}else r.role==="bishop"?i=mt(e,this.board.occupied):r.role==="knight"?i=ir(e):r.role==="rook"?i=wt(e,this.board.occupied):r.role==="queen"?i=Bi(e,this.board.occupied):i=rr(e);if(i=i.diff(this.board[this.turn]),_(n.king)){if(r.role==="king"){const o=this.board.occupied.without(e);for(const l of i)this.kingAttackers(l,W(this.turn),o).nonEmpty()&&(i=i.without(l));return i.union(Ir(this,"a",n)).union(Ir(this,"h",n))}if(n.checkers.nonEmpty()){const o=n.checkers.singleSquare();if(!_(o))return d.empty();i=i.intersect(bt(o,n.king).with(o))}n.blockers.has(e)&&(i=i.intersect(Fi(e,n.king)))}return s&&(i=i.union(s)),i}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[W(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(d.darkSquares())||!this.board.bishop.intersects(d.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:ec(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return De.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){if(qt(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&d.backranks().has(e.to)?!1:this.dropDests(n).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&d.backranks().has(e.to)))return!1;const r=this.dests(e.from,n);return r.has(e.to)||r.has(nc(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return _(e)&&this.kingAttackers(e,W(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:W(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const r of this.board[this.turn])n.set(r,this.dests(r,e));return n}play(e){const n=this.turn,r=this.epSquare,i=qi(this,e);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=W(n),qt(e))this.board.set(e.to,{role:e.role,color:n}),this.pockets&&this.pockets[n][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const s=this.board.take(e.from);if(!s)return;let o;if(s.role==="pawn"){this.halfmoves=0,e.to===r&&(o=this.board.take(e.to+(n==="white"?-8:8)));const l=e.from-e.to;Math.abs(l)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(s.role=e.promotion,s.promoted=!!this.pockets)}else if(s.role==="rook")this.castles.discardRook(e.from);else if(s.role==="king"){if(i){const l=this.castles.rook[n][i];if(_(l)){const c=this.board.take(l);this.board.set(tr(n,i),s),c&&this.board.set(nr(n,i),c)}}this.castles.discardColor(n)}if(!i){const l=this.board.set(e.to,s)||o;l&&this.playCaptureAt(e.to,l)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class zn extends Zl{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(r=>n)}clone(){return super.clone()}}const Xl=(t,e)=>{if(!_(e))return;const n=t.turn==="white"?5:2,r=t.turn==="white"?8:-8;if(ze(e)!==n||t.board.occupied.has(e+r))return;const i=e-r;if(!(!t.board.pawn.has(i)||!t.board[W(t.turn)].has(i)))return e},ec=t=>{if(!_(t.epSquare))return;const e=t.ctx(),r=t.board.pieces(t.turn,"pawn").intersect(Vt(W(t.turn),t.epSquare));for(const i of r)if(t.dests(i,e).has(t.epSquare))return t.epSquare},tc=(t,e,n)=>{if(!_(t.epSquare)||!Vt(t.turn,e).has(t.epSquare))return!1;if(!_(n.king))return!0;const r=t.turn==="white"?8:-8,i=t.epSquare-r;return t.kingAttackers(n.king,W(t.turn),t.board.occupied.toggle(e).toggle(i).with(t.epSquare)).without(i).isEmpty()},Ir=(t,e,n)=>{if(!_(n.king)||n.checkers.nonEmpty())return d.empty();const r=t.castles.rook[t.turn][e];if(!_(r)||t.castles.path[t.turn][e].intersects(t.board.occupied))return d.empty();const i=tr(t.turn,e),s=bt(n.king,i),o=t.board.occupied.without(n.king);for(const a of s)if(t.kingAttackers(a,W(t.turn),o).nonEmpty())return d.empty();const l=nr(t.turn,e),c=t.board.occupied.toggle(n.king).toggle(r).toggle(l);return t.kingAttackers(i,W(t.turn),c).nonEmpty()?d.empty():d.fromSquare(r)},qi=(t,e)=>{if(qt(e))return;const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},nc=(t,e)=>{const n=qi(t,e);if(!n)return e;const r=t.castles.rook[t.turn][n];return{from:e.from,to:_(r)?r:e.to}},rc=(t,e)=>{const n=new Map,r=t.ctx();for(const[i,s]of t.allDests(r))if(s.nonEmpty()){const o=Array.from(s,gt);i===r.king&&ee(i)===4&&(s.has(0)?o.push("c1"):s.has(56)&&o.push("c8"),s.has(7)?o.push("g1"):s.has(63)&&o.push("g8")),n.set(gt(i),o)}return n},ic=(t,e)=>{let n="";if(qt(e))e.role!=="pawn"&&(n=lt(e.role).toUpperCase()),n+="@"+gt(e.to);else{const r=t.board.getRole(e.from);if(!r)return"--";if(r==="king"&&(t.board[t.turn].has(e.to)||Math.abs(e.to-e.from)===2))n=e.to>e.from?"O-O":"O-O-O";else{const i=t.board.occupied.has(e.to)||r==="pawn"&&ee(e.from)!==ee(e.to);if(r!=="pawn"){n=lt(r).toUpperCase();let s;if(r==="king"?s=rr(e.to).intersect(t.board.king):r==="queen"?s=Bi(e.to,t.board.occupied).intersect(t.board.queen):r==="rook"?s=wt(e.to,t.board.occupied).intersect(t.board.rook):r==="bishop"?s=mt(e.to,t.board.occupied).intersect(t.board.bishop):s=ir(e.to).intersect(t.board.knight),s=s.intersect(t.board[t.turn]).without(e.from),s.nonEmpty()){const o=t.ctx();for(const l of s)t.dests(l,o).has(e.to)||(s=s.without(l));if(s.nonEmpty()){let l=!1,c=s.intersects(d.fromRank(ze(e.from)));s.intersects(d.fromFile(ee(e.from)))?l=!0:c=!0,c&&(n+=Ft[ee(e.from)]),l&&(n+=Di[ze(e.from)])}}}else i&&(n=Ft[ee(e.from)]);i&&(n+="x"),n+=gt(e.to),e.promotion&&(n+="="+lt(e.promotion).toUpperCase())}}return n},sc=(t,e)=>{var n;const r=ic(t,e);return t.play(e),!((n=t.outcome())===null||n===void 0)&&n.winner?r+"#":t.isCheck()?r+"+":r},oc=(t,e)=>sc(t.clone(),e);function lc(t,e){let n=Rn(t).unwrap(),r=zn.fromSetup(n).unwrap(),i=zi(e);return r.play(i),Li(r.toSetup())}const Ut=class Ut{constructor(){v(this,"_add_uci");v(this,"_promotion");v(this,"_position");v(this,"m_fen");v(this,"m_dests");v(this,"m_color");v(this,"_last_move");v(this,"_on_wheel");v(this,"set_on_wheel",e=>{this._on_wheel[1](e)});v(this,"on_play_uci",e=>{let n=lc(this.fen,e);this.on_set_fen_uci(n,e)});v(this,"on_set_fen_uci",(e,n)=>{xt(()=>{this.add_uci=void 0,this.last_move=n,this.position=zn.fromSetup(Rn(e).unwrap()).unwrap()})});v(this,"reset_move_after",()=>{this.position=this.position});v(this,"on_move_after",(e,n)=>{let r=this.position.board.get(ct(e)),i=e+n;r.role==="pawn"&&(n[1]==="8"&&this.turnColor==="white"||n[1]==="1"&&this.turnColor==="black")&&(i+="q");let s=zi(i),o=oc(this.position,s);this.position.play(s),xt(()=>{this.last_move=i,this.position=this.position,i.length===5&&(this.promotion=n),this.add_uci=[i,o]})});this._on_wheel=Q(void 0,{equals:!1}),this._last_move=Q(void 0,{equals:!1}),this._add_uci=Q(void 0,{equals:!1}),this._promotion=Q(void 0,{equals:!1}),this._position=Q(zn.fromSetup(Rn(Ii).unwrap()).unwrap(),{equals:!1}),this.m_dests=H(()=>rc(this.position)),this.m_fen=H(()=>Li(this.position.toSetup())),this.m_color=H(()=>this.position.turn)}get position(){return this._position[0]()}set position(e){this._position[1](e)}get turnColor(){return this.m_color()}get promotion(){return this._promotion[0]()}set promotion(e){this._promotion[1](e)}get add_uci(){return this._add_uci[0]()}set add_uci(e){this._add_uci[1](e)}get last_move(){return this._last_move[0]()}set last_move(e){this._last_move[1](e)}get on_wheel(){return this._on_wheel[0]()}get fen_uci(){let e=this.fen,n=this.last_move;return[e,n]}get fen(){return this.m_fen()}get dests(){return this.m_dests()}};v(Ut,"init",()=>new Ut);let In=Ut;function cc(t){let e=0;return n=>{e+=n.deltaY*(n.deltaMode?40:1),Math.abs(e)>=4?(t(n,!0),e=0):t(n,!1)}}function ac(t){return new Worker(""+new URL("worker2-UUsytELw.js",import.meta.url).href,{type:"module",name:t==null?void 0:t.name})}const Qt=Xi(),uc=t=>{let e=new ac;const[n,r]=Q(),[i,s]=Q(),[o,l]=Q();e.onmessage=f=>{switch(f.data==="ready"&&(c=!0,u()),f.data.t){case"progress":r(f.data.d);break;case"puzzles":let{all:b,filtered:k}=f.data.d;xt(()=>{l(b),s(k)});break}};let c=!1,a,h=[];function u(){c&&e.postMessage({t:"filter",d:{filter:a,rules:h}})}let m={get progress(){return n()},get puzzles(){return i()},get all(){return o()},filter:f=>{a=f,u()},rules:f=>{h=f,u()}};return U(Qt.Provider,{value:m,get children(){return[" ",H(()=>t.children)," "]}})};function hc(t,e,n=!1){let r,i=0;return function(...s){const o=this;r&&clearTimeout(r),r=void 0;const l=performance.now()-i;i=performance.now(),n&&l>e?t.apply(o,s):r=setTimeout(()=>{r=void 0,t.apply(o,s)},e)}}var fc=se("<div class=header>"),dc=se("<div class=app-wrap><div class=board-wrap><div class=board></div><div class=tree></div></div><div class=editor-wrap></div><div class=puzzles-wrap>"),pc=se("<div>"),gc=se("<div class=progress> <!>/<!> "),mc=se('<div class=puzzles><div class=filter><input type=text placeholder="Filter y_filter _!_ n_filter"><span>/10000 Positions</span></div><div class=list></div><div class=info><button>Toggle Solved</button><button>Toggle Id</button><button>Toggle Failed'),wc=se("<div><span class=id><a target=_blank></a></span><span class=has-tags></span><span class=tags>"),Kr=se("<span class=tag>"),bc=se("<div class=rule-list><div class=scroll-wrap></div><div class=tools><div class=rule>+ New rule</div><div class=rule>- Delete rule"),kc=se("<div class=text-wrap><textarea class=editor-input title=rules rows=13 cols=21></textarea><div class=ascii><textarea>"),yc=se("<div><span class=name></span><span class=stats>f <!> / s "),vc=se("<span>");function _c(){return U(uc,{get children(){return U(Cc,{})}})}function Cc(){const[t,e]=Q(void 0),[n,r]=Q(0),i=H(()=>{let l=t();return l?l.sans:[]});de(()=>{let l=t(),c=n();l?s.on_set_fen_uci(l.move_fens[c+1]):s.on_set_fen_uci(Ii)}),de(rn(t,()=>{r(-1)}));const s=new In,o=cc((l,c)=>{if(!c)return;const a=l.target;if(a.tagName!=="PIECE"&&a.tagName!=="SQUARE"&&a.tagName!=="CG-BOARD")return;l.preventDefault();let h=Math.sign(l.deltaY),u=t();h>0?u&&r(Math.min(u.move_fens.length-2,n()+1)):r(Math.max(-1,n()-1))});return[fc(),(()=>{var l=dc(),c=l.firstChild,a=c.firstChild,h=a.nextSibling,u=c.nextSibling,p=u.nextSibling;return ds(a,"wheel",o),O(a,U(Qo,{onShapes:()=>{},movable:!0,get doPromotion(){return s.promotion},get onMoveAfter(){return s.on_move_after},get fen_uci(){return s.fen_uci},get color(){return s.turnColor},get dests(){return s.dests}})),O(h,U(ot,{get each(){return i()},children:(g,m)=>(()=>{var f=pc();return f.$$click=()=>r(m),O(f,g),me(()=>qn(f,"san"+(n()===m()?" active":""))),f})()})),O(u,U(Ac,{get fen(){return s.fen_uci[0]}})),O(p,U(Ec,{on_selected_puzzle:e})),O(l,U(Sc,{}),null),l})()]}const Sc=()=>{const t=Kn(Qt);return U(Fn,{get when(){return t.progress},children:e=>(()=>{var n=gc(),r=n.firstChild,i=r.nextSibling,s=i.nextSibling,o=s.nextSibling;return o.nextSibling,O(n,()=>e()[0],i),O(n,()=>e()[1],o),n})()})},Ht=class Ht{constructor(e){this.puzzle=e}get id(){return this.puzzle.id}get fen(){return this.puzzle.fen}get tags(){return this.puzzle.tags}get has_tags(){return Ni(this.puzzle)}get all_tags(){return Ol(this.puzzle)}};v(Ht,"create",e=>new Ht(e));let Wt=Ht;const Ec=t=>{let e=Kn(Qt);const n=H(Bn(()=>e.puzzles,Wt.create)),[r,i]=wn(void 0,"filter"),[s,o]=wn(void 0,"id_selected"),l=H(()=>n().find(f=>f.id===s()));let c=r();const a=()=>{let f=r();if(!f)return;let b=l();b&&(c?(i(c),c=void 0):(c=f,i(`id_${b.id} `)))},h=()=>{let f=r();f&&(f.includes("solved")?f=f.replace("solved",""):f=f.trim()+" solved",i(f))};let u=r();const p=()=>{let f=r();f&&(f.includes("failed")?f=u:(u=f,f="failed"),i(f))};de(rn(l,f=>{var b;f?t.on_selected_puzzle(f.puzzle):(n()[0]&&o((b=n()[0])==null?void 0:b.id),t.on_selected_puzzle(void 0))})),de(rn(r,f=>{e.filter(f)}));let g;const m=hc(f=>{i(f)},1100);return(()=>{var f=mc(),b=f.firstChild,k=b.firstChild,y=k.nextSibling,$=y.firstChild,P=b.nextSibling,x=P.nextSibling,Z=x.firstChild,te=Z.nextSibling,R=te.nextSibling;return Hr(X=>g=X,k),k.$$input=()=>m(g.value),hr(k,"spellcheck",!1),O(y,()=>n().length,$),O(P,U(Fn,{get when(){return n()},children:X=>U(ot,{get each(){return X().slice(0,1e3)},children:D=>(()=>{var B=wc(),$e=B.firstChild,sr=$e.firstChild,or=$e.nextSibling,ji=or.nextSibling;return B.$$click=()=>o(D.id),O(sr,()=>D.id),O(or,U(ot,{get each(){return Object.keys(D.has_tags).filter(oe=>!oe.includes("id_"))},children:oe=>(()=>{var we=Kr();return O(we,oe),we})()})),O(ji,U(ot,{get each(){return Object.keys(D.all_tags)},children:oe=>(()=>{var we=Kr();return O(we,oe),we})()})),me(oe=>{var we="puzzle"+(D.id===s()?" active":""),lr=`https://lichess.org/training/${D.id}`;return we!==oe.e&&qn(B,oe.e=we),lr!==oe.t&&hr(sr,"href",oe.t=lr),oe},{e:void 0,t:void 0}),B})()})})),Z.$$click=h,te.$$click=a,R.$$click=p,me(()=>k.value=r()),f})()};function Ac(t){let e=Kn(Qt);const n=H(Bn(()=>e.all,Wt.create)),r=b=>n().filter(k=>k.all_tags[`failed_${b}`]).length,i=b=>n().filter(k=>k.all_tags[`solved_${b}`]).length;function s(){let b=1,k=`rule${b}`,y=o();for(;y.find($=>$.name===k);)k=`rule${b++}`;return{name:k,rule:""}}const[o,l]=wn([{name:"rule1",rule:""}],"rule-list"),[c,a]=Q(0);e.rules(o());const h=H(()=>o()[c()]),u=b=>{if(b.key==="Escape"){let k=b.target.value,y=h(),$={name:y.name,rule:k},P=o(),x=P.findIndex(Z=>Z.name===y.name);P.splice(x,1,$),l([...P]),e.rules([$])}},p=()=>{xt(()=>{l([s(),...o()]),a(0)})},g=()=>{let b=o();if(b.length===1)return;let k=b.splice(c(),1);l([...b]),e.rules(k.map(y=>({name:y.name,rule:""})))};let m=H(()=>{if(t.fen)try{return Ml(t.fen,h().rule)}catch(b){return"Error"+b}});const f=H(()=>{let b=h();if(!(!b||!t.fen))return Pi(Oi(t.fen,b.rule))});return[(()=>{var b=bc(),k=b.firstChild,y=k.nextSibling,$=y.firstChild,P=$.nextSibling;return O(k,U(ot,{get each(){return o()},children:(x,Z)=>(()=>{var te=yc(),R=te.firstChild,X=R.nextSibling,D=X.firstChild,B=D.nextSibling;return B.nextSibling,te.$$click=()=>a(Z()),O(R,()=>x.name),O(X,()=>r(x.name),B),O(X,()=>i(x.name),null),me(()=>qn(te,"rule"+(Z()===c()?" active":""))),te})()})),$.$$click=p,P.$$click=g,b})(),(()=>{var b=kc(),k=b.firstChild,y=k.nextSibling,$=y.firstChild;return k.$$keydown=u,$.disabled=!0,O($,f),O(y,U(Fn,{get when(){return m()},children:P=>(()=>{var x=vc();return O(x,P),x})()}),null),me(()=>{var P;return k.value=((P=h())==null?void 0:P.rule)??"Select a rule"}),b})()]}fs(["click","input","keydown"]);const $c=document.getElementById("root");hs(()=>U(_c,{}),$c);
